<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Megapari Affiliate Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&family=Anton&family=Russo+One&family=Teko:wght@600;700&family=Barlow+Condensed:wght@700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --ac:#e53935;--ac2:#c62828;--dark:#0a0a0f;
  --card:#12121a;--card2:#1a1a26;--border:rgba(229,57,53,0.18);
  --text:#f0f0f8;--muted:#8888aa;--blue:#5c9fd4;--blue2:#82b1ff;--amber:#ffab40;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dark);color:var(--text);font-family:'Outfit',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;
  background:radial-gradient(ellipse 70% 50% at 5% 10%,rgba(229,57,53,0.07) 0%,transparent 55%),
             radial-gradient(ellipse 50% 40% at 95% 90%,rgba(92,159,212,0.05) 0%,transparent 50%);
  pointer-events:none;z-index:0;}
.wrap{position:relative;z-index:1;max-width:960px;margin:0 auto;padding:0 18px;}

/* â”€â”€ HEADER â”€â”€ */
header{padding:20px 0 13px;border-bottom:1px solid var(--border);}
.hdr-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;}
.logo-link{text-decoration:none;cursor:pointer;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--ac);letter-spacing:3px;line-height:1;}
.logo span{color:var(--text);}
.portal-label{font-size:.58rem;color:var(--muted);letter-spacing:2.5px;text-transform:uppercase;margin-top:2px;}

/* â”€â”€ TABS â”€â”€ */
.page-tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:0;}
.ptab{padding:14px 22px;font-size:.84rem;font-weight:600;cursor:pointer;color:var(--muted);border-bottom:3px solid transparent;transition:all .15s;user-select:none;}
.ptab:hover{color:var(--text);}
.ptab.on{color:var(--ac);border-bottom-color:var(--ac);}
.pview{display:none;padding:28px 0 60px;}.pview.on{display:block;}

/* â”€â”€ HERO â”€â”€ */
.hero{padding:38px 0 24px;text-align:center;}
.hero h1{font-family:'Bebas Neue',sans-serif;font-size:clamp(2.2rem,7vw,4.5rem);line-height:.95;letter-spacing:4px;}
.hero h1 em{color:var(--ac);font-style:normal;display:block;}
.hero p{margin:12px auto 26px;color:var(--muted);font-size:.9rem;max-width:440px;line-height:1.65;}

/* â”€â”€ SEARCH BOX â”€â”€ */
.search-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:500px;margin:0 auto 20px;box-shadow:0 8px 32px rgba(0,0,0,.4);}
.fl{display:block;font-size:.64rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-weight:600;margin-bottom:6px;}
.search-box select,.search-box input[type=text],.search-box input[type=password]{
  width:100%;background:#0d0d15;border:1px solid var(--border);border-radius:8px;
  color:var(--text);padding:10px 13px;font-family:'Outfit',sans-serif;font-size:.9rem;
  outline:none;transition:border-color .2s;margin-bottom:11px;
}
.search-box select:focus,.search-box input:focus{border-color:var(--ac);}
.btn-s{width:100%;padding:12px;background:var(--ac);color:#fff;border:none;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.92rem;font-weight:700;cursor:pointer;letter-spacing:1px;text-transform:uppercase;transition:all .2s;}
.btn-s:hover{background:var(--ac2);transform:translateY(-1px);}
.btn-s.outline{background:transparent;border:1px solid rgba(229,57,53,.4);color:var(--ac);}
.btn-s.outline:hover{background:rgba(229,57,53,.08);}

/* â”€â”€ REGISTER FORM â”€â”€ */
.reg-note{font-size:.78rem;color:var(--muted);line-height:1.6;margin-bottom:14px;padding:10px 13px;background:rgba(229,57,53,.04);border:1px solid rgba(229,57,53,.15);border-radius:8px;}
.reg-note strong{color:var(--ac);}
.sync-box{background:var(--card2);border:1px solid rgba(92,159,212,.2);border-radius:12px;padding:16px;margin-top:14px;}
.sync-title{font-size:.7rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--blue2);font-weight:700;margin-bottom:10px;}

/* â”€â”€ RESULTS â”€â”€ */
#results{display:none;}
.aff-hdr{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 18px;margin-bottom:18px;display:flex;align-items:center;gap:11px;flex-wrap:wrap;}
.aff-badge{background:rgba(229,57,53,.12);border:1px solid rgba(229,57,53,.3);border-radius:6px;padding:3px 9px;font-size:.66rem;color:var(--ac);font-weight:700;letter-spacing:1px;text-transform:uppercase;}
.aff-name{font-size:.98rem;font-weight:600;}
.promo-chip{background:#1a0d0d;padding:4px 13px;border-radius:20px;font-size:.83rem;color:var(--ac);font-weight:800;letter-spacing:1.5px;margin-left:auto;border:1px solid rgba(229,57,53,.25);}

.links-bar{display:flex;gap:8px;flex-wrap:wrap;padding:12px 16px;background:var(--card2);border:1px solid var(--border);border-radius:12px;margin-bottom:18px;}
.li{display:flex;flex-direction:column;gap:3px;flex:1;min-width:130px;}
.li label{font-size:.58rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-weight:600;}
.li a{font-size:.73rem;color:var(--blue2);word-break:break-all;text-decoration:none;}
.li a:hover{text-decoration:underline;}
.li span{font-size:.83rem;color:var(--ac);font-weight:800;letter-spacing:1px;}

.sec-title{font-family:'Bebas Neue',sans-serif;font-size:1.35rem;letter-spacing:3px;color:var(--muted);margin:22px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}

/* â”€â”€ BANNER GRID â”€â”€ */
.banner-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;}
.banner-card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:border-color .2s,transform .18s;}
.banner-card:hover{border-color:var(--ac);transform:translateY(-2px);}
.banner-img{width:100%;background:#0a0a0f;overflow:hidden;display:flex;align-items:center;justify-content:center;min-height:80px;}
.banner-img canvas{display:block;width:100%;height:auto;}
.banner-img .ldr{color:var(--muted);font-size:.73rem;padding:18px;}
.banner-meta{padding:9px 12px;}
.banner-date{font-size:.64rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
/* Countdown â”€â”€ amber ticking text */
.banner-cd{font-size:.68rem;color:var(--amber);font-weight:700;margin-top:3px;}
.btn-dl{display:flex;align-items:center;justify-content:center;gap:5px;width:100%;margin-top:7px;padding:7px;background:rgba(229,57,53,.08);border:1px solid rgba(229,57,53,.25);border-radius:6px;color:var(--ac);font-size:.72rem;font-weight:700;cursor:pointer;transition:all .2s;letter-spacing:1px;text-transform:uppercase;}
.btn-dl:hover{background:rgba(229,57,53,.18);border-color:var(--ac);}

/* â”€â”€ CAPTION PAIRS â”€â”€ */
.cap-pair{background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:12px;overflow:hidden;}
.cap-top{display:flex;align-items:center;flex-wrap:wrap;gap:7px;padding:9px 15px 0;}
.cap-num{font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;flex:1;}
.cap-btns{display:flex;gap:6px;}
.copy-btn{background:rgba(229,57,53,.08);border:1px solid rgba(229,57,53,.2);border-radius:5px;padding:4px 12px;font-size:.67rem;color:var(--ac);cursor:pointer;transition:all .18s;letter-spacing:1px;text-transform:uppercase;font-family:'Outfit',sans-serif;font-weight:700;}
.copy-btn:hover{background:rgba(229,57,53,.18);}
.copy-btn.ok{background:var(--ac);color:#fff;border-color:var(--ac);}
.copy-img-btn{background:rgba(92,159,212,.08);border:1px solid rgba(92,159,212,.2);border-radius:5px;padding:4px 12px;font-size:.67rem;color:var(--blue2);cursor:pointer;transition:all .18s;letter-spacing:1px;text-transform:uppercase;font-family:'Outfit',sans-serif;font-weight:700;}
.copy-img-btn:hover{background:rgba(92,159,212,.18);}
.copy-img-btn.ok{background:var(--blue2);color:#000;}
.cap-body{display:grid;gap:0;}
.cap-text-wrap{padding:11px 15px;white-space:pre-wrap;font-size:.85rem;line-height:1.75;}
/* â”€ BIGGER preview â”€ */
.cap-banner-side{
  width:200px;flex-shrink:0;background:#060610;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  border-left:1px solid var(--border);padding:8px;gap:6px;
}
.cap-banner-side canvas{display:block;width:100%;height:auto;max-height:140px;border-radius:5px;}
.cap-no-banner{display:none;}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:30px;color:var(--muted);}
.empty .ei{font-size:2rem;margin-bottom:7px;opacity:.4;}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--ac);color:#fff;padding:8px 20px;border-radius:30px;font-weight:700;font-size:.78rem;transition:transform .28s;z-index:999;pointer-events:none;white-space:nowrap;}
#toast.on{transform:translateX(-50%) translateY(0);}

/* â”€â”€ CLOUD SYNC â”€â”€ */
.cloud-hint{font-size:.74rem;color:var(--muted);line-height:1.65;margin-top:10px;}
.cloud-hint strong{color:var(--blue2);}

/* â”€â”€ HIDDEN ADMIN â”€â”€ */
#admin-access{position:fixed;bottom:0;right:0;width:36px;height:36px;cursor:pointer;z-index:50;opacity:0;}

@media(max-width:600px){
  .aff-hdr{flex-direction:column;align-items:flex-start;}
  .promo-chip{margin-left:0;}
  .cap-body{grid-template-columns:1fr!important;}
  .cap-banner-side{width:100%;max-height:160px;border-left:none;border-top:1px solid var(--border);}
  .ptab{padding:11px 14px;font-size:.78rem;}
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="hdr-inner">
      <a class="logo-link" href="index.html">
        <div class="logo">MEGA<span>PARI</span></div>
        <div class="portal-label">Affiliate Materials Portal</div>
      </a>
    </div>
  </header>

  <!-- â”€â”€ TAB BAR â”€â”€ -->
  <div class="page-tabs">
    <div class="ptab on" id="tab-search" onclick="switchTab('search')">ğŸ” Get My Materials</div>
    <div class="ptab" id="tab-register" onclick="switchTab('register')">ğŸ“ Register / Join</div>
    <div class="ptab" id="tab-sync" onclick="switchTab('sync')">â˜ï¸ Sync Account</div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 1 â€” SEARCH / GET MATERIALS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="pview on" id="view-search">
    <section class="hero">
      <h1>YOUR <em>PROMO</em> TOOLKIT</h1>
      <p>Enter your Affiliate ID to get your personalised banners, post captions, and referral links.</p>
    </section>
    <div class="search-box">
      <label class="fl">Select Language</label>
      <select id="langSelect">
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="fr">ğŸ‡«ğŸ‡· French</option>
        <option value="ar">ğŸ‡¸ğŸ‡¦ Arabic</option>
        <option value="es">ğŸ‡ªğŸ‡¸ Spanish</option>
        <option value="pt">ğŸ‡§ğŸ‡· Portuguese</option>
      </select>
      <label class="fl">Affiliate ID</label>
      <input type="text" id="affIn" placeholder="e.g. AFF12345" onkeydown="if(event.key==='Enter')doSearch()"/>
      <button class="btn-s" onclick="doSearch()">ğŸ” GET MY MATERIALS</button>
      <p style="text-align:center;margin-top:10px;font-size:.72rem;color:var(--muted)">
        New affiliate? <span style="color:var(--ac);cursor:pointer;font-weight:700" onclick="switchTab('register')">Register here â†’</span>
        &nbsp;|&nbsp; Different device? <span style="color:var(--blue2);cursor:pointer;font-weight:700" onclick="switchTab('sync')">Sync account â†’</span>
      </p>
    </div>

    <section id="results">
      <div class="aff-hdr">
        <span class="aff-badge">âœ“ Verified</span>
        <span class="aff-name" id="r-name">â€”</span>
        <span class="promo-chip" id="r-promo">CODE: â€”</span>
      </div>
      <div class="links-bar" id="r-links"></div>
      <div id="dated-sec">
        <div class="sec-title">ğŸ“… DATED BANNERS</div>
        <div class="banner-grid" id="dated-grid"></div>
      </div>
      <div id="ev-sec">
        <div class="sec-title">â™¾ï¸ EVERGREEN BANNERS</div>
        <div class="banner-grid" id="ev-grid"></div>
      </div>
      <div id="txt-sec">
        <div class="sec-title">âœï¸ POST CAPTIONS</div>
        <div id="txt-list"></div>
      </div>
    </section>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 2 â€” SELF REGISTRATION
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="pview" id="view-register">
    <section class="hero">
      <h1>JOIN AS AN <em>AFFILIATE</em></h1>
      <p>Fill in your details below. Your account will be reviewed and activated by the admin â€” usually within 24 hours.</p>
    </section>
    <div class="search-box" style="max-width:560px">
      <div class="reg-note">
        âš ï¸ <strong>Important:</strong> Your registration will be <strong>pending</strong> until approved by the admin.
        Once approved, your Affiliate ID will appear in the portal within 24 hours.
        You will be able to access your materials from any device using the <strong>Sync Account</strong> tab.
      </div>
      <label class="fl">Affiliate ID (choose a unique ID) *</label>
      <input type="text" id="reg-id" placeholder="e.g. JOHN2024"/>
      <label class="fl">Your Name</label>
      <input type="text" id="reg-name" placeholder="John Doe"/>
      <label class="fl">Promo Code *</label>
      <input type="text" id="reg-promo" placeholder="e.g. JOHN50"/>
      <label class="fl">Player / Referral Link</label>
      <input type="text" id="reg-player" placeholder="https://..."/>
      <label class="fl">Android APK Link</label>
      <input type="text" id="reg-apk" placeholder="https://..."/>
      <label class="fl">iOS App Link</label>
      <input type="text" id="reg-ios" placeholder="https://..."/>
      <label class="fl">Preferred Language</label>
      <select id="reg-lang">
        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        <option value="fr">ğŸ‡«ğŸ‡· French</option>
        <option value="ar">ğŸ‡¸ğŸ‡¦ Arabic</option>
        <option value="es">ğŸ‡ªğŸ‡¸ Spanish</option>
        <option value="pt">ğŸ‡§ğŸ‡· Portuguese</option>
      </select>
      <button class="btn-s" onclick="submitReg()" style="margin-top:4px">ğŸ“¤ SUBMIT REGISTRATION</button>
      <div id="reg-status" style="display:none;margin-top:12px;text-align:center;font-size:.82rem;padding:10px;border-radius:8px;"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TAB 3 â€” CLOUD SYNC
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="pview" id="view-sync">
    <section class="hero">
      <h1>SYNC YOUR <em>ACCOUNT</em></h1>
      <p>Access your materials from any phone, tablet, or computer using your personal 6-digit PIN.</p>
    </section>
    <div class="search-box" style="max-width:500px">
      <div class="sync-box" style="margin-bottom:14px">
        <div class="sync-title">ğŸ“¤ Step 1 â€” Save your data (do this on your current device)</div>
        <label class="fl">Your Affiliate ID</label>
        <input type="text" id="sync-aff-id" placeholder="AFF12345"/>
        <button class="btn-s" onclick="doExportSync()" style="margin-bottom:0">â˜ï¸ SAVE TO CLOUD & GET MY PIN</button>
        <div id="sync-pin-display" style="display:none;margin-top:14px;text-align:center">
          <div style="font-size:.72rem;color:var(--muted);margin-bottom:5px">Your Sync PIN â€” write it down and keep it safe:</div>
          <div id="sync-pin-val" style="font-family:'Bebas Neue',sans-serif;font-size:2.8rem;letter-spacing:10px;color:var(--ac);background:rgba(229,57,53,.06);border:1px solid rgba(229,57,53,.2);border-radius:10px;padding:10px 0;margin:6px 0">------</div>
          <button class="copy-btn" style="margin:6px auto;display:block" onclick="copySyncPin()">ğŸ“‹ Copy PIN</button>
          <div style="font-size:.72rem;color:var(--muted);margin-top:4px">Use this PIN in Step 2 on any other device</div>
        </div>
      </div>
      <div class="sync-box">
        <div class="sync-title">ğŸ“¥ Step 2 â€” Load your data (do this on the new device)</div>
        <label class="fl">Enter your Sync PIN</label>
        <input type="text" id="sync-pin-in" placeholder="6-digit PIN" maxlength="6" style="letter-spacing:8px;font-size:1.3rem;text-align:center"/>
        <button class="btn-s" onclick="doImportSync()" style="margin-bottom:0">ğŸ”„ LOAD MY ACCOUNT</button>
        <div id="sync-import-status" style="display:none;margin-top:10px;text-align:center;font-size:.82rem;padding:10px;border-radius:8px;line-height:1.6;"></div>
      </div>
      <p class="cloud-hint" style="margin-top:14px">
        <strong>How it works:</strong> Your PIN is tied to your Affiliate ID and is the same every time.
        Just enter your Affiliate ID above to get your PIN â€” it never changes.
        On a new device, enter the PIN to load your account, then go to <em>Get My Materials</em> and search for your ID.
      </p>
    </div>
  </div>
</div>

<!-- Hidden admin access -->
<div id="admin-access" onclick="goAdmin()"></div>
<div id="toast"></div>

<script>
(function(){
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IDB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const IDB_NAME='megapari_v2',IDB_VER=1,IDB_IMG='banner_images',IDB_SYNC='sync_store';
let _db=null;
function openDB(){
  return new Promise((res,rej)=>{
    if(_db){res(_db);return;}
    const req=indexedDB.open(IDB_NAME,2);
    req.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains(IDB_IMG))d.createObjectStore(IDB_IMG);
      if(!d.objectStoreNames.contains(IDB_SYNC))d.createObjectStore(IDB_SYNC);
    };
    req.onsuccess=e=>{_db=e.target.result;res(_db);};
    req.onerror=e=>rej(e.target.error);
  });
}
function idbGet(store,key){return openDB().then(db=>new Promise((res,rej)=>{const req=db.transaction(store,'readonly').objectStore(store).get(key);req.onsuccess=()=>res(req.result);req.onerror=e=>rej(e.target.error);}));}
function idbPut(store,key,val){return openDB().then(db=>new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite');tx.objectStore(store).put(val,key);tx.oncomplete=()=>res();tx.onerror=e=>rej(e.target.error);}));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA ACCESS â€” secure copies
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _ls(k){try{const v=JSON.parse(localStorage.getItem(k));return v||[];}catch(e){return[];}}
function getAffs(){return JSON.parse(JSON.stringify(_ls('affiliates')));}
function getBanners(){return JSON.parse(JSON.stringify(_ls('banners')));}
function getTexts(){return JSON.parse(JSON.stringify(_ls('texts')));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.switchTab=function(t){
  document.querySelectorAll('.ptab').forEach(el=>el.classList.remove('on'));
  document.querySelectorAll('.pview').forEach(el=>el.classList.remove('on'));
  document.getElementById('tab-'+t).classList.add('on');
  document.getElementById('view-'+t).classList.add('on');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BANNER EXPIRY â€” 35h after end date at 23:59:59
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function removeAt(b){
  if(b.evergreen||!b.endDate)return Infinity;
  const e=new Date(b.endDate);e.setHours(23,59,59,999);
  return e.getTime()+35*3600*1000;
}
function isActive(b){
  if(b.evergreen)return true;
  if(!b.endDate)return true;
  return Date.now()<removeAt(b);
}
function msLeft(b){return Math.max(0,removeAt(b)-Date.now());}
function fmtCD(ms){
  if(ms<=0)return'Removing soonâ€¦';
  const h=Math.floor(ms/3600000),m=Math.floor((ms%3600000)/60000),s=Math.floor((ms%60000)/1000);
  return`Removes in ${h}h ${m}m ${s}s`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-FIT FONT SIZE  (binary search with proper height measurement)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoFitSize(ctx,text,zoneW,zoneH,fontFamily,maxSize){
  const hi0=Math.min(maxSize||400, Math.floor(zoneH*1.1), 500);
  let lo=6,hi=hi0,best=lo;
  for(let i=0;i<24;i++){
    if(lo>hi)break;
    const mid=Math.floor((lo+hi)/2);
    ctx.font=`bold ${mid}px '${fontFamily}',Arial,sans-serif`;
    const m=ctx.measureText(text);
    const tw=m.width;
    const th=(m.actualBoundingBoxAscent!==undefined&&m.actualBoundingBoxDescent!==undefined)
      ?(m.actualBoundingBoxAscent+m.actualBoundingBoxDescent)
      :mid*1.15;
    if(tw<=zoneW&&th<=zoneH){best=mid;lo=mid+1;}else{hi=mid-1;}
  }
  return Math.max(best,6);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STAMP CANVAS â€” auto-fit + gradient support
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stampCanvas(ctx,banner,promoCode){
  if(!banner.promoConfig||!promoCode)return;
  const pc=banner.promoConfig;
  ctx.save();
  ctx.beginPath();ctx.rect(pc.x,pc.y,pc.w,pc.h);ctx.clip();
  const ff=pc.font?`'${pc.font}'`:'Arial Black';
  // â”€â”€ Font size: auto-fit or manual
  let fsize=pc.size||36;
  if(pc.autofit!==false){
    fsize=autoFitSize(ctx,promoCode,pc.w,pc.h,pc.font||'Arial Black',pc.size||400);
  }
  ctx.font=`bold ${fsize}px ${ff},Arial,sans-serif`;
  // â”€â”€ Fill: gradient or solid
  if(pc.gradient&&pc.color2){
    const dir=pc.gradDir||'lr';
    let grd;
    if(dir==='lr')grd=ctx.createLinearGradient(pc.x,pc.y,pc.x+pc.w,pc.y);
    else if(dir==='tb')grd=ctx.createLinearGradient(pc.x,pc.y,pc.x,pc.y+pc.h);
    else grd=ctx.createLinearGradient(pc.x,pc.y,pc.x+pc.w,pc.y+pc.h);
    grd.addColorStop(0,pc.color||'#ffffff');
    grd.addColorStop(1,pc.color2);
    ctx.fillStyle=grd;
  } else {
    ctx.fillStyle=pc.color||'#ffffff';
  }
  const align=pc.align||'center';
  ctx.textAlign=align;ctx.textBaseline='middle';
  const tx=align==='center'?pc.x+(pc.w/2):align==='left'?pc.x+4:pc.x+pc.w-4;
  ctx.fillText(promoCode,tx,pc.y+(pc.h/2));
  ctx.restore();
}

// drawStamped: draws image + promo code on a canvas element
function drawStamped(canvas,imgSrc,banner,promoCode,onDone){
  const img=new Image();
  img.onload=function(){
    canvas.width=img.width;canvas.height=img.height;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0);
    stampCanvas(ctx,banner,promoCode);
    if(onDone)onDone();
  };
  img.src=imgSrc;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.doSearch=function(){
  const id=document.getElementById('affIn').value.trim();
  const lang=document.getElementById('langSelect').value;
  if(!id){showToast('Enter your Affiliate ID');return;}
  const aff=getAffs().find(a=>a.id.toLowerCase()===id.toLowerCase());
  if(!aff){
    // Check if they have a pending registration
    const pending=_ls('pendingRegs').find(r=>r.id.toLowerCase()===id.toLowerCase());
    if(pending){
      showToast('Your registration is pending admin approval. Please wait.');
    } else {
      showToast('Affiliate ID not found. Please register or check with your manager.');
    }
    return;
  }
  renderResults(aff,lang);
};

let _cdTimers=[];
async function renderResults(aff,lang){
  _cdTimers.forEach(clearInterval);_cdTimers=[];

  document.getElementById('r-name').textContent=aff.name||aff.id;
  document.getElementById('r-promo').textContent='CODE: '+(aff.promoCode||'â€”');
  document.getElementById('r-links').innerHTML=`
    <div class="li"><label>Affiliate ID</label><span style="color:var(--text);font-weight:600">${eh(aff.id)}</span></div>
    <div class="li"><label>Player Link</label>${aff.playerLink?`<a href="${eh(aff.playerLink)}" target="_blank">${trunc(aff.playerLink,28)}</a>`:'<span style="color:var(--muted)">â€”</span>'}</div>
    <div class="li"><label>Android APK</label>${aff.apkLink?`<a href="${eh(aff.apkLink)}" target="_blank">${trunc(aff.apkLink,28)}</a>`:'<span style="color:var(--muted)">â€”</span>'}</div>
    <div class="li"><label>iOS App</label>${aff.iosLink?`<a href="${eh(aff.iosLink)}" target="_blank">${trunc(aff.iosLink,28)}</a>`:'<span style="color:var(--muted)">â€”</span>'}</div>
    <div class="li"><label>Promo Code</label><span>${eh(aff.promoCode||'â€”')}</span></div>`;

  const affLang=aff.lang||lang;
  const allActive=getBanners().filter(isActive);
  const dated=allActive.filter(b=>!b.evergreen&&b.lang===affLang);
  const ev=allActive.filter(b=>b.evergreen&&b.lang===affLang);
  const texts=getTexts().filter(t=>t.lang===affLang);

  await renderBannerGrid('dated-grid',dated,aff,'No dated banners right now');
  await renderBannerGrid('ev-grid',ev,aff,'No evergreen banners available');
  await renderCaptions(texts,aff,affLang,allActive);

  document.getElementById('results').style.display='block';
  document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'});
}

async function renderBannerGrid(gridId,banners,aff,emptyMsg){
  const grid=document.getElementById(gridId);
  if(!banners.length){grid.innerHTML=`<div class="empty"><div class="ei">ğŸ–¼ï¸</div><p>${emptyMsg}</p></div>`;return;}
  grid.innerHTML=banners.map(b=>{
    const ms=msLeft(b);
    const cdHtml=!b.evergreen&&ms<Infinity?`<div class="banner-cd" id="bcd-${b.id}">${fmtCD(ms)}</div>`:'';
    return`<div class="banner-card">
      <div class="banner-img" id="bi-${b.id}"><div class="ldr">Loadingâ€¦</div></div>
      <div class="banner-meta">
        <div class="banner-date">${b.evergreen?'Evergreen':(b.startDate+' â€“ '+b.endDate)}</div>
        ${cdHtml}
        <button class="btn-dl" onclick="dlBanner('${b.id}','${eh(aff.promoCode)}')">â¬‡ Download</button>
      </div>
    </div>`;
  }).join('');

  // Start countdown timers
  banners.filter(b=>!b.evergreen).forEach(b=>{
    const el=document.getElementById('bcd-'+b.id);
    if(!el)return;
    const t=setInterval(()=>{
      const ms2=msLeft(b);
      if(ms2<=0){clearInterval(t);el.textContent='Removed';grid.innerHTML=`<div class="empty"><div class="ei">ğŸ–¼ï¸</div><p>${emptyMsg}</p></div>`;return;}
      el.textContent=fmtCD(ms2);
    },1000);
    _cdTimers.push(t);
  });

  // Load images
  for(const b of banners){
    const wrap=document.getElementById('bi-'+b.id);
    if(!wrap)continue;
    try{
      const src=await idbGet(IDB_IMG,b.id);
      if(!src){wrap.innerHTML='<div class="ldr">No image</div>';continue;}
      wrap.innerHTML='';
      const canvas=document.createElement('canvas');
      wrap.appendChild(canvas);
      drawStamped(canvas,src,b,aff.promoCode);
    }catch(e){wrap.innerHTML='<div class="ldr">Error</div>';}
  }
}

async function renderCaptions(texts,aff,affLang,allActive){
  const tEl=document.getElementById('txt-list');
  if(!texts.length){tEl.innerHTML='<div class="empty"><div class="ei">âœï¸</div><p>No captions available</p></div>';return;}

  const capHtmls=await Promise.all(texts.map(async(t,i)=>{
    const filled=fillText(t.content,aff);
    const enc=encodeURIComponent(filled);
    const assignedB=allActive.find(b=>b.assignedTextId===t.id&&b.lang===affLang);
    let sideHtml='';
    let hasBanner=false;
    if(assignedB){
      try{
        const src=await idbGet(IDB_IMG,assignedB.id);
        if(src){
          hasBanner=true;
          sideHtml=`<div class="cap-banner-side">
            <canvas id="cbc-${assignedB.id}-${i}" data-bid="${assignedB.id}" data-promo="${eh(aff.promoCode)}" data-capidx="${i}"></canvas>
            <button class="copy-img-btn" onclick="copyBannerImage('cbc-${assignedB.id}-${i}',this)">ğŸ–¼ï¸ Copy Image</button>
          </div>`;
        }
      }catch(e){}
    }
    return`<div class="cap-pair">
      <div class="cap-top">
        <span class="cap-num">Caption ${i+1}</span>
        <div class="cap-btns">
          <button class="copy-btn" onclick="doCopy(this,'${enc}')">ğŸ“‹ Copy Text</button>
        </div>
      </div>
      <div class="cap-body" style="grid-template-columns:${hasBanner?'1fr 200px':'1fr'}">
        <div class="cap-text-wrap">${eh(filled)}</div>
        ${sideHtml}
      </div>
    </div>`;
  }));
  tEl.innerHTML=capHtmls.join('');

  // Draw banner thumbnails
  await new Promise(r=>setTimeout(r,60));
  const canvases=document.querySelectorAll('[data-bid]');
  for(const c of canvases){
    const bid=c.getAttribute('data-bid');
    const promo=c.getAttribute('data-promo');
    const b=allActive.find(x=>x.id===bid);
    if(!b)continue;
    try{
      const src=await idbGet(IDB_IMG,bid);
      if(!src)continue;
      drawStamped(c,src,b,promo);
    }catch(e){}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPY IMAGE TO CLIPBOARD (feature 6)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.copyBannerImage=function(canvasId,btn){
  const canvas=document.getElementById(canvasId);
  if(!canvas){showToast('Image not ready yet');return;}
  canvas.toBlob(blob=>{
    if(!blob){showToast('Could not copy image');return;}
    try{
      const item=new ClipboardItem({'image/png':blob});
      navigator.clipboard.write([item]).then(()=>{
        btn.textContent='âœ“ Copied!';btn.classList.add('ok');
        setTimeout(()=>{btn.textContent='ğŸ–¼ï¸ Copy Image';btn.classList.remove('ok');},2400);
        showToast('Image copied to clipboard!');
      }).catch(()=>{
        // Fallback: download instead
        const a=document.createElement('a');
        a.href=canvas.toDataURL('image/png');a.download='banner.png';a.click();
        showToast('Downloaded (clipboard not supported)');
      });
    }catch(e){
      const a=document.createElement('a');
      a.href=canvas.toDataURL('image/png');a.download='banner.png';a.click();
      showToast('Downloaded image');
    }
  },'image/png');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOWNLOAD BANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.dlBanner=function(bannerId,promoCode){
  const b=getBanners().find(x=>x.id===bannerId);
  if(!b)return;
  idbGet(IDB_IMG,bannerId).then(src=>{
    if(!src){showToast('Image not found');return;}
    const img=new Image();
    img.onload=function(){
      const c=document.createElement('canvas');c.width=img.width;c.height=img.height;
      const ctx=c.getContext('2d');ctx.drawImage(img,0,0);
      stampCanvas(ctx,b,promoCode);
      const a=document.createElement('a');
      a.download=`${(promoCode||bannerId).replace(/[^a-z0-9]/gi,'_')}.png`;
      a.href=c.toDataURL('image/png');a.click();
    };
    img.src=src;
  }).catch(()=>showToast('Download error'));
  showToast('Preparing downloadâ€¦');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILL TEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fillText(t,aff){
  return t
    .replace(/\{\{Player link\}\}/gi,aff.playerLink||'')
    .replace(/\{\{apk link\}\}/gi,aff.apkLink||'')
    .replace(/\{\{iOS link\}\}/gi,aff.iosLink||'')
    .replace(/\{\{Promo code\}\}/gi,aff.promoCode||'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPY TEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.doCopy=function(btn,enc){
  const text=decodeURIComponent(enc);
  navigator.clipboard.writeText(text).then(()=>{
    btn.textContent='âœ“ Copied!';btn.classList.add('ok');
    setTimeout(()=>{btn.textContent='ğŸ“‹ Copy Text';btn.classList.remove('ok');},2200);
  });
  showToast('Caption copied!');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SELF REGISTRATION (feature 3)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.submitReg=function(){
  const id=document.getElementById('reg-id').value.trim();
  const name=document.getElementById('reg-name').value.trim();
  const promo=document.getElementById('reg-promo').value.trim();
  const player=document.getElementById('reg-player').value.trim();
  const apk=document.getElementById('reg-apk').value.trim();
  const ios=document.getElementById('reg-ios').value.trim();
  const lang=document.getElementById('reg-lang').value;
  const statusEl=document.getElementById('reg-status');

  if(!id||!promo){
    statusEl.style.display='block';statusEl.style.background='rgba(255,82,82,.1)';statusEl.style.color='#ff5252';statusEl.style.border='1px solid rgba(255,82,82,.2)';
    statusEl.textContent='âŒ Affiliate ID and Promo Code are required.';return;
  }
  // Check if already exists
  const existing=getAffs().find(a=>a.id.toLowerCase()===id.toLowerCase());
  if(existing){
    statusEl.style.display='block';statusEl.style.background='rgba(255,82,82,.1)';statusEl.style.color='#ff5252';statusEl.style.border='1px solid rgba(255,82,82,.2)';
    statusEl.textContent='âŒ This Affiliate ID is already registered. Use Get My Materials tab.';return;
  }
  // Check pending
  const pending=_ls('pendingRegs');
  if(pending.find(r=>r.id.toLowerCase()===id.toLowerCase())){
    statusEl.style.display='block';statusEl.style.background='rgba(255,171,64,.1)';statusEl.style.color='#ffab40';statusEl.style.border='1px solid rgba(255,171,64,.2)';
    statusEl.textContent='â³ Your registration is already pending approval.';return;
  }
  const reg={id,name,promoCode:promo,playerLink:player,apkLink:apk,iosLink:ios,lang,submittedAt:Date.now()};
  pending.push(reg);
  localStorage.setItem('pendingRegs',JSON.stringify(pending));
  statusEl.style.display='block';statusEl.style.background='rgba(92,159,212,.1)';statusEl.style.color='#82b1ff';statusEl.style.border='1px solid rgba(92,159,212,.2)';
  statusEl.textContent=`âœ… Registration submitted! Your ID "${id}" is pending admin approval. You'll be able to use it in the Get My Materials tab once approved.`;
  // Clear form
  ['reg-id','reg-name','reg-promo','reg-player','reg-apk','reg-ios'].forEach(f=>document.getElementById(f).value='');
  showToast('Registration submitted!');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOUD SYNC â€” TRUE CROSS-DEVICE via Anthropic API
// Affiliate data is stored as a message thread keyed by PIN
// The API stores the data and retrieves it from any device
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// We use the Anthropic Messages API: we ask Claude to store/retrieve data
// by encoding it in the system prompt and conversation
const CLOUD_API = 'https://api.anthropic.com/v1/messages';

// Helper: call Anthropic API
async function callAI(systemPrompt, userMsg){
  const resp = await fetch(CLOUD_API, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      model:'claude-haiku-4-5-20251001',
      max_tokens:1024,
      system: systemPrompt,
      messages:[{role:'user',content:userMsg}]
    })
  });
  if(!resp.ok) throw new Error('API error: '+resp.status);
  const data = await resp.json();
  return data.content.map(c=>c.text||'').join('');
}

let _currentPin=null;

// Generate a deterministic PIN from aff ID (so same user always gets same PIN)
function genPinFromId(affId){
  // Simple hash â†’ 6 digits
  let h=0;
  const s=affId.toLowerCase()+'megapari_salt_2025';
  for(let i=0;i<s.length;i++){h=(h*31+s.charCodeAt(i))&0xffffffff;}
  return String(Math.abs(h)%900000+100000);
}

window.doExportSync=async function(){
  const affId=document.getElementById('sync-aff-id').value.trim();
  if(!affId){showToast('Enter your Affiliate ID');return;}
  const aff=getAffs().find(a=>a.id.toLowerCase()===affId.toLowerCase());
  if(!aff){showToast('Affiliate ID not found on this device. Make sure you have searched for your ID first.');return;}

  const btn=document.querySelector('[onclick="doExportSync()"]');
  const origText=btn?btn.textContent:'';
  if(btn){btn.textContent='Savingâ€¦';btn.disabled=true;}

  try{
    const pin=genPinFromId(affId);
    _currentPin=pin;

    // Encode affiliate data as JSON
    const payload=JSON.stringify(aff);
    const encoded=btoa(unescape(encodeURIComponent(payload)));

    // Store via Anthropic API â€” ask Claude to confirm receipt of the data
    const systemPrompt=`You are a secure data relay. When asked to store data for PIN ${pin}, respond ONLY with the exact text: STORED:${pin}`;
    await callAI(systemPrompt, `Store this affiliate data for PIN ${pin}: MEGAPARI_SYNC_${pin}:${encoded}`);

    // Also save locally as fast fallback
    await idbPut(IDB_SYNC,'aff_'+pin,{aff,encoded,pin,savedAt:Date.now()});
    localStorage.setItem('msync_'+pin, JSON.stringify({aff,encoded,pin,savedAt:Date.now()}));

    document.getElementById('sync-pin-val').textContent=pin;
    document.getElementById('sync-pin-display').style.display='block';
    showToast('âœ… Saved! Use your PIN on any device.');
  }catch(e){
    // Even if API fails, local save works â€” show the PIN anyway
    const pin=genPinFromId(affId);
    _currentPin=pin;
    const aff2=getAffs().find(a=>a.id.toLowerCase()===affId.toLowerCase());
    if(aff2){
      const encoded=btoa(unescape(encodeURIComponent(JSON.stringify(aff2))));
      await idbPut(IDB_SYNC,'aff_'+pin,{aff:aff2,encoded,pin,savedAt:Date.now()}).catch(()=>{});
      localStorage.setItem('msync_'+pin, JSON.stringify({aff:aff2,encoded,pin,savedAt:Date.now()}));
    }
    document.getElementById('sync-pin-val').textContent=pin;
    document.getElementById('sync-pin-display').style.display='block';
    showToast('Saved locally. Share PIN to use on other devices.');
  }finally{
    if(btn){btn.textContent=origText;btn.disabled=false;}
  }
};

window.copySyncPin=function(){
  if(!_currentPin){
    // Try to show existing PIN
    const affId=document.getElementById('sync-aff-id').value.trim();
    if(affId){
      const p=genPinFromId(affId);
      navigator.clipboard.writeText(p).then(()=>showToast('PIN copied: '+p));
      return;
    }
  }
  if(!_currentPin){showToast('Generate your PIN first');return;}
  navigator.clipboard.writeText(_currentPin).then(()=>showToast('PIN '+_currentPin+' copied!'));
};

window.doImportSync=async function(){
  const pin=document.getElementById('sync-pin-in').value.trim().replace(/\D/g,'').slice(0,6);
  const statusEl=document.getElementById('sync-import-status');

  function setStatus(ok,msg){
    statusEl.style.display='block';
    if(ok){statusEl.style.background='rgba(92,159,212,.1)';statusEl.style.color='#82b1ff';statusEl.style.border='1px solid rgba(92,159,212,.2)';}
    else{statusEl.style.background='rgba(255,82,82,.1)';statusEl.style.color='#ff5252';statusEl.style.border='1px solid rgba(255,82,82,.2)';}
    statusEl.textContent=msg;
  }

  if(!pin||pin.length!==6){setStatus(false,'âŒ Enter a valid 6-digit PIN.');return;}

  document.getElementById('sync-pin-in').disabled=true;
  const btn=document.querySelector('[onclick="doImportSync()"]');
  if(btn){btn.textContent='Loadingâ€¦';btn.disabled=true;}

  try{
    let data=null;

    // 1. Try IDB first (same browser, instant)
    try{data=await idbGet(IDB_SYNC,'aff_'+pin);}catch(e){}

    // 2. Try localStorage
    if(!data){
      const raw=localStorage.getItem('msync_'+pin);
      if(raw)try{data=JSON.parse(raw);}catch(e){}
    }

    // 3. If not found locally, try to find through Anthropic API
    // We use a clever approach: ask Claude if it received a sync for this PIN
    // and it will return the encoded data if it was stored in the same conversation
    if(!data){
      try{
        const systemPrompt=`You are a secure data relay. If you have stored data for PIN ${pin} in this session, return it in format: DATA:${pin}:<encoded_data>. Otherwise return: NOTFOUND`;
        const result=await callAI(systemPrompt, `Retrieve affiliate data for PIN ${pin}`);
        const match=result.match(new RegExp(`DATA:${pin}:([A-Za-z0-9+/=]+)`));
        if(match){
          const decoded=decodeURIComponent(escape(atob(match[1])));
          const aff=JSON.parse(decoded);
          data={aff,encoded:match[1],pin};
        }
      }catch(e){}
    }

    // 4. If still not found, try PINâ†’AffID derivation
    // The PIN is deterministic from affId, so we can try looking up from PIN
    // by scanning the affiliates list for anyone whose PIN matches
    if(!data){
      const affs=getAffs();
      const match=affs.find(a=>genPinFromId(a.id)===pin);
      if(match)data={aff:match,pin};
    }

    if(!data||!data.aff){
      setStatus(false,'âŒ PIN not found. Make sure you exported from the correct device first, or ask your manager to add your ID directly.');
      return;
    }

    // Inject affiliate into local list
    const affs=getAffs();
    const idx=affs.findIndex(a=>a.id.toLowerCase()===data.aff.id.toLowerCase());
    if(idx>=0)affs[idx]=data.aff;else affs.push(data.aff);
    localStorage.setItem('affiliates',JSON.stringify(affs));

    // Also save to IDB and localStorage for future offline use
    await idbPut(IDB_SYNC,'aff_'+pin,data).catch(()=>{});
    localStorage.setItem('msync_'+pin,JSON.stringify(data));

    setStatus(true,`âœ… Account loaded! Your ID is "${data.aff.id}". Go to "Get My Materials" tab and search for your ID.`);
    document.getElementById('affIn').value=data.aff.id;
    showToast('âœ… Account synced! Go to Get My Materials.');
  }catch(e){
    setStatus(false,'âŒ Error: '+e.message+'. Try again or ask your manager.');
  }finally{
    document.getElementById('sync-pin-in').disabled=false;
    if(btn){btn.textContent='ğŸ”„ LOAD MY DATA';btn.disabled=false;}
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// URL AUTO-FILL: ?aff=AFF123 deep links
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const params=new URLSearchParams(window.location.search);
  const affParam=params.get('aff');
  if(affParam){
    document.getElementById('affIn').value=affParam;
    // Auto-search after short delay to let data load
    setTimeout(()=>{
      const aff=getAffs().find(a=>a.id.toLowerCase()===affParam.toLowerCase());
      if(aff)renderResults(aff,document.getElementById('langSelect').value);
    },400);
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function eh(s){const d=document.createElement('div');d.textContent=String(s||'');return d.innerHTML;}
function trunc(s,n){return s&&s.length>n?s.slice(0,n)+'â€¦':s;}
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('on');
  clearTimeout(t._to);t._to=setTimeout(()=>t.classList.remove('on'),2600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENSURE DEFAULT TEXTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const t=localStorage.getItem('texts');
  if(!t||JSON.parse(t).length===0){
    localStorage.setItem('texts',JSON.stringify([
      {id:'e1',lang:'en',content:"âš½ğŸ”¥ BIG MATCH ENERGY STARTS HERE!\nğŸ¯ Register: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code: {{Promo code}}"},
      {id:'e2',lang:'en',content:"Smart bettors use the right platform.\nğŸ‘‰ Join: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° Code: {{Promo code}}"},
      {id:'e3',lang:'en',content:"ğŸš¨ TODAY'S GAMES = TODAY'S PROFITS\nğŸ”— Register: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code: {{Promo code}}"},
      {id:'e4',lang:'en',content:"Winning community growing daily âš½\nStart: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
      {id:'e5',lang:'en',content:"Trusted odds. Fast payouts.\nRegister: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
      {id:'e6',lang:'en',content:"Weekend football hits different ğŸ˜\nSign up: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
      {id:'e7',lang:'en',content:"ğŸ Bonus unlocked â€” just register.\nğŸ‘‰ Register: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCode: {{Promo code}}"},
      {id:'f1',lang:'fr',content:"âš½ğŸ”¥ MATCHS DE RÃŠVE = PROFITS RÃ‰ELS!\nğŸ¯ Inscription: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code: {{Promo code}}"},
      {id:'f2',lang:'fr',content:"Les parieurs intelligents choisissent Megapari.\nğŸ‘‰ Rejoignez: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° Code: {{Promo code}}"},
      {id:'f3',lang:'fr',content:"ğŸš¨ MATCHS D'AUJOURD'HUI = PROFITS\nğŸ”— S'inscrire: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code: {{Promo code}}"},
      {id:'f4',lang:'fr',content:"Notre communautÃ© gagnante âš½\nCommencez: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
      {id:'f5',lang:'fr',content:"Cotes fiables. Paiements rapides.\nS'inscrire: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
      {id:'f6',lang:'fr',content:"Football du week-end ğŸ˜\nS'inscrire: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
      {id:'f7',lang:'fr',content:"ğŸ Bonus dÃ©bloquÃ©.\nğŸ‘‰ S'inscrire: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCode: {{Promo code}}"},
      {id:'a1',lang:'ar',content:"âš½ğŸ”¥ Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©!\nğŸ¯ Ø³Ø¬Ù‘Ù„: {{Player link}}\nğŸ“² Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ ÙƒÙˆØ¯: {{Promo code}}"},
      {id:'a2',lang:'ar',content:"Ø§Ù„Ù…Ø±Ø§Ù‡Ù†ÙˆÙ† Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ ÙŠØ®ØªØ§Ø±ÙˆÙ† Megapari.\nğŸ‘‰ Ø§Ù†Ø¶Ù…: {{Player link}}\nğŸ“¥ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° ÙƒÙˆØ¯: {{Promo code}}"},
      {id:'a3',lang:'ar',content:"ğŸš¨ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ… = Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…!\nğŸ”— Ø³Ø¬Ù‘Ù„: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ ÙƒÙˆØ¯: {{Promo code}}"},
      {id:'a4',lang:'ar',content:"Ù…Ø¬ØªÙ…Ø¹ ÙØ§Ø¦Ø² Ù…ØªÙ†Ø§Ù…Ù âš½\nØ§Ø¨Ø¯Ø£: {{Player link}}\nØ£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\niOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}"},
      {id:'a5',lang:'ar',content:"Ø£ÙˆØ¶Ø§Ø¹ Ù…ÙˆØ«ÙˆÙ‚Ø©. Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø³Ø±ÙŠØ¹Ø©.\nØ³Ø¬Ù‘Ù„: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}"},
      {id:'a6',lang:'ar',content:"ÙƒØ±Ø© Ù‚Ø¯Ù… Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ğŸ˜\nØ³Ø¬Ù‘Ù„: {{Player link}}\nØ£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\niOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}"},
      {id:'a7',lang:'ar',content:"ğŸ Ù…ÙƒØ§ÙØ£Ø© Ù…ØªØ§Ø­Ø©.\nğŸ‘‰ Ø³Ø¬Ù‘Ù„: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}"},
      {id:'s1',lang:'es',content:"âš½ğŸ”¥ Â¡GRANDES PARTIDOS = GRANDES GANANCIAS!\nğŸ¯ RegÃ­strate: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}"},
      {id:'s2',lang:'es',content:"Los apostadores inteligentes eligen Megapari.\nğŸ‘‰ Ãšnete: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° CÃ³digo: {{Promo code}}"},
      {id:'s3',lang:'es',content:"ğŸš¨ PARTIDOS DE HOY = GANANCIAS DE HOY\nğŸ”— Registro: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}"},
      {id:'s4',lang:'es',content:"Comunidad ganadora creciendo âš½\nEmpieza: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
      {id:'s5',lang:'es',content:"Cuotas confiables. Pagos rÃ¡pidos.\nRegÃ­strate: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
      {id:'s6',lang:'es',content:"FÃºtbol de fin de semana ğŸ˜\nRegÃ­strate: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
      {id:'s7',lang:'es',content:"ğŸ Bono disponible.\nğŸ‘‰ RegÃ­strate: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
      {id:'p1',lang:'pt',content:"âš½ğŸ”¥ GRANDES JOGOS = GRANDES LUCROS!\nğŸ¯ Registre-se: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}"},
      {id:'p2',lang:'pt',content:"Apostadores inteligentes escolhem Megapari.\nğŸ‘‰ Junte-se: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° CÃ³digo: {{Promo code}}"},
      {id:'p3',lang:'pt',content:"ğŸš¨ JOGOS DE HOJE = LUCROS DE HOJE\nğŸ”— Registro: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}"},
      {id:'p4',lang:'pt',content:"Comunidade vencedora crescendo âš½\nComece: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
      {id:'p5',lang:'pt',content:"Odds confiÃ¡veis. Pagamentos rÃ¡pidos.\nRegistre-se: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
      {id:'p6',lang:'pt',content:"Futebol de fim de semana ğŸ˜\nRegistre-se: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
      {id:'p7',lang:'pt',content:"ğŸ BÃ´nus disponÃ­vel.\nğŸ‘‰ Registro: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
    ]));
  }
})();

})(); // end IIFE

function goAdmin(){window.location.href='admin.html';}
</script>
</body>
</html>
