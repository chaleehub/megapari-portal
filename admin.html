<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€” Megapari Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&family=Anton&family=Black+Han+Sans&family=Teko:wght@600;700&family=Barlow+Condensed:wght@700;800;900&family=Russo+One&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
:root{
  --green:#00e676;--green2:#00c853;--dark:#080c0a;
  --card:#111a14;--card2:#162019;--border:rgba(0,230,118,0.15);
  --text:#e8f5e9;--muted:#7a9e85;--red:#ff5252;--amber:#ffab40;--blue:#90caf9;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dark);color:var(--text);font-family:'Outfit',sans-serif;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 60% 50% at 10% 20%,rgba(0,230,118,0.05) 0%,transparent 60%);pointer-events:none;z-index:0;}

/* â”€â”€ LAYOUT â”€â”€ */
.wrap{display:flex;min-height:100vh;position:relative;z-index:1;}
.sidebar{width:230px;background:var(--card);border-right:1px solid var(--border);padding:22px 0;flex-shrink:0;position:fixed;top:0;left:0;height:100vh;overflow-y:auto;z-index:20;}
.sidebar-logo{padding:0 20px 22px;border-bottom:1px solid var(--border);margin-bottom:10px;}
.logo-t{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:var(--green);letter-spacing:2px;}
.logo-s{font-size:.6rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.nav{display:flex;align-items:center;gap:9px;padding:12px 20px;cursor:pointer;font-size:.86rem;font-weight:500;color:var(--muted);transition:all .15s;border-left:3px solid transparent;user-select:none;}
.nav:hover{color:var(--text);background:rgba(0,230,118,0.04);}
.nav.on{color:var(--green);border-left-color:var(--green);background:rgba(0,230,118,0.07);}
.nav-sep{height:1px;background:var(--border);margin:6px 0;}
.main{flex:1;margin-left:230px;padding:30px 34px;min-height:100vh;}
.page{display:none;}.page.on{display:block;}

/* â”€â”€ TYPOGRAPHY â”€â”€ */
.ph{margin-bottom:26px;padding-bottom:14px;border-bottom:1px solid var(--border);}
.ph h1{font-family:'Bebas Neue',sans-serif;font-size:2.1rem;letter-spacing:4px;}
.ph p{color:var(--muted);font-size:.83rem;margin-top:4px;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:13px;padding:22px;margin-bottom:20px;}
.card-title{font-size:.78rem;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:2px;margin-bottom:16px;display:flex;align-items:center;gap:8px;}

/* â”€â”€ FORMS â”€â”€ */
.row{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:13px;margin-bottom:13px;}
.fg{display:flex;flex-direction:column;gap:5px;}
.fg.full{grid-column:1/-1;}
label{font-size:.68rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600;}
input[type=text],input[type=date],input[type=number],input[type=password],select,textarea{
  background:#0a1209;border:1px solid var(--border);border-radius:8px;color:var(--text);
  padding:10px 13px;font-family:'Outfit',sans-serif;font-size:.87rem;outline:none;
  transition:border-color .2s;width:100%;
}
input[type=color]{background:#0a1209;border:1px solid var(--border);border-radius:8px;height:40px;padding:3px 7px;width:100%;cursor:pointer;}
input:focus,select:focus,textarea:focus{border-color:var(--green);}
textarea{resize:vertical;min-height:110px;line-height:1.6;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{padding:9px 18px;border:none;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.82rem;font-weight:700;cursor:pointer;transition:all .18s;letter-spacing:.4px;display:inline-flex;align-items:center;gap:6px;}
.g{background:var(--green);color:#000;}.g:hover{background:var(--green2);transform:translateY(-1px);}
.r{background:rgba(255,82,82,.12);color:var(--red);border:1px solid rgba(255,82,82,.25);}.r:hover{background:rgba(255,82,82,.2);}
.a{background:rgba(255,171,64,.12);color:var(--amber);border:1px solid rgba(255,171,64,.25);}.a:hover{background:rgba(255,171,64,.2);}
.o{background:transparent;color:var(--green);border:1px solid rgba(0,230,118,.35);}.o:hover{background:rgba(0,230,118,.07);}
.b{background:rgba(144,202,249,.1);color:var(--blue);border:1px solid rgba(144,202,249,.25);}.b:hover{background:rgba(144,202,249,.18);}
.sm{padding:4px 11px;font-size:.72rem;}
.br{display:flex;gap:9px;flex-wrap:wrap;align-items:center;margin-top:6px;}

/* â”€â”€ TABLE â”€â”€ */
.tw{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:.82rem;}
th{padding:9px 13px;background:var(--card2);color:var(--muted);text-align:left;font-weight:700;font-size:.66rem;text-transform:uppercase;letter-spacing:1.5px;}
td{padding:10px 13px;border-bottom:1px solid rgba(0,230,118,.05);vertical-align:middle;}
tr:last-child td{border-bottom:none;}tr:hover td{background:rgba(0,230,118,.02);}
.bx{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.67rem;font-weight:700;letter-spacing:.4px;}
.bx-g{background:rgba(0,230,118,.1);color:var(--green);border:1px solid rgba(0,230,118,.2);}
.bx-a{background:rgba(255,171,64,.1);color:var(--amber);border:1px solid rgba(255,171,64,.2);}
.bx-b{background:rgba(144,202,249,.1);color:var(--blue);border:1px solid rgba(144,202,249,.2);}

/* â”€â”€ UPLOAD DROP ZONE â”€â”€ */
.dropzone{border:2px dashed rgba(0,230,118,.25);border-radius:10px;padding:24px;text-align:center;background:rgba(0,230,118,.02);transition:all .2s;cursor:pointer;}
.dropzone:hover,.dropzone.drag{border-color:var(--green);background:rgba(0,230,118,.05);}
.dropzone .dz-icon{font-size:2.4rem;margin-bottom:8px;}
.dropzone p{color:var(--muted);font-size:.83rem;line-height:1.6;}
.dropzone strong{color:var(--green);}

/* â”€â”€ MULTI BANNER QUEUE â”€â”€ */
#banner-queue{display:flex;flex-direction:column;gap:14px;margin-top:16px;}
.bq-item{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:14px;}
.bq-top{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
.bq-thumb{width:80px;height:48px;object-fit:cover;border-radius:6px;border:1px solid var(--border);flex-shrink:0;}
.bq-name{font-size:.82rem;font-weight:600;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.bq-status{font-size:.7rem;padding:3px 8px;border-radius:4px;}
.bq-status.pending{background:rgba(255,171,64,.12);color:var(--amber);}
.bq-status.done{background:rgba(0,230,118,.12);color:var(--green);}
.bq-status.err{background:rgba(255,82,82,.12);color:var(--red);}

/* â”€â”€ CANVAS EDITOR â”€â”€ */
.canvas-editor{background:#060e08;border:2px solid rgba(0,230,118,.3);border-radius:10px;position:relative;overflow:hidden;cursor:crosshair;user-select:none;margin-bottom:10px;}
.canvas-editor canvas{display:block;max-width:100%;}
.drag-rect{position:absolute;border:2px solid var(--green);background:rgba(0,230,118,.15);pointer-events:none;box-shadow:0 0 0 1px rgba(0,230,118,.3);display:none;}
.drag-label{position:absolute;top:-22px;left:0;background:var(--green);color:#000;font-size:.65rem;font-weight:700;padding:2px 6px;border-radius:3px;white-space:nowrap;}

/* â”€â”€ FONT PREVIEW â”€â”€ */
.font-preview{background:#0a1209;border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin-top:8px;font-size:1.2rem;text-align:center;color:var(--green);min-height:44px;transition:all .2s;}

/* â”€â”€ INFO BOX â”€â”€ */
.ib{background:rgba(0,230,118,.04);border:1px solid rgba(0,230,118,.18);border-radius:8px;padding:11px 15px;font-size:.81rem;color:var(--muted);margin-bottom:13px;line-height:1.7;}
.ib strong{color:var(--green);}

/* â”€â”€ IMPORT PREVIEW â”€â”€ */
.ip{background:#0a1209;border:1px solid var(--border);border-radius:8px;padding:13px;margin-top:13px;max-height:210px;overflow-y:auto;}
.ip table{font-size:.77rem;}
.ip th{background:#0d1a10;padding:6px 10px;}
.ip td{padding:6px 10px;}

/* â”€â”€ FILTER TABS â”€â”€ */
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:15px;}
.tab{padding:5px 13px;border-radius:20px;font-size:.74rem;font-weight:600;cursor:pointer;border:1px solid var(--border);color:var(--muted);transition:all .14s;background:transparent;font-family:'Outfit',sans-serif;}
.tab:hover{border-color:var(--green);color:var(--green);}
.tab.on{background:var(--green);color:#000;border-color:var(--green);}

/* â”€â”€ TEXT CARDS â”€â”€ */
.tc{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:15px;margin-bottom:11px;transition:border-color .2s;}
.tc:hover{border-color:rgba(0,230,118,.3);}
.tc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px;gap:10px;flex-wrap:wrap;}
.tc pre{white-space:pre-wrap;font-family:'Outfit',sans-serif;font-size:.8rem;color:var(--text);line-height:1.65;max-height:100px;overflow:hidden;position:relative;}
.tc pre::after{content:'';position:absolute;bottom:0;left:0;right:0;height:24px;background:linear-gradient(transparent,var(--card2));}

/* â”€â”€ LOGIN â”€â”€ */
#login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--dark);z-index:999;}
.lc{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:42px;width:100%;max-width:390px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.5);}
.ll{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;letter-spacing:3px;}
.ls{font-size:.82rem;color:var(--muted);margin-bottom:30px;letter-spacing:1px;}
.le{color:var(--red);font-size:.79rem;margin-bottom:10px;padding:8px 12px;background:rgba(255,82,82,.1);border-radius:6px;display:none;}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:26px;right:26px;z-index:9999;padding:10px 20px;border-radius:30px;font-weight:700;font-size:.83rem;opacity:0;transform:translateY(12px);transition:all .28s;pointer-events:none;}
#toast.on{opacity:1;transform:translateY(0);}

/* â”€â”€ PROGRESS â”€â”€ */
.prog-bar{width:100%;background:var(--card2);border-radius:4px;height:6px;margin-top:8px;overflow:hidden;}
.prog-fill{height:100%;background:var(--green);transition:width .3s;border-radius:4px;}

/* â”€â”€ DOWNLOAD SECTION â”€â”€ */
.dl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-top:12px;}
.dl-card{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;cursor:pointer;transition:all .2s;}
.dl-card:hover{border-color:var(--green);background:rgba(0,230,118,.05);}
.dl-card .dc-name{font-size:.82rem;font-weight:700;color:var(--green);margin-bottom:4px;}
.dl-card .dc-info{font-size:.7rem;color:var(--muted);}

@media(max-width:700px){.sidebar{width:200px;}.main{margin-left:200px;padding:18px;}}
@media(max-width:560px){.wrap{flex-direction:column;}.sidebar{position:relative;width:100%;height:auto;}.main{margin-left:0;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="lc">
    <div class="ll"><span style="color:var(--green)">MEGA</span><span style="color:var(--text)">PARI</span></div>
    <div class="ls">Admin Panel</div>
    <div class="fg" style="text-align:left;margin-bottom:13px">
      <label>Password</label>
      <input type="password" id="pw-in" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <div class="le" id="pw-err">âŒ Incorrect password</div>
    <button class="btn g" style="width:100%;justify-content:center;padding:12px" onclick="doLogin()">ENTER ADMIN â†’</button>
    <p style="margin-top:14px;font-size:.7rem;color:var(--muted)">Default: <strong style="color:var(--text)">admin123</strong></p>
  </div>
</div>

<!-- PANEL -->
<div class="wrap" id="panel" style="display:none">
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-t">MEGA<span style="color:var(--text)">PARI</span></div>
      <div class="logo-s">Admin Panel</div>
    </div>
    <div class="nav on" onclick="go('affiliates',this)">ğŸ‘¥ Affiliates</div>
    <div class="nav" onclick="go('banners',this)">ğŸ–¼ï¸ Banners</div>
    <div class="nav" onclick="go('texts',this)">âœï¸ Post Captions</div>
    <div class="nav" onclick="go('download',this)">ğŸ“¥ Bulk Download</div>
    <div class="nav-sep"></div>
    <div class="nav" onclick="go('settings',this)">âš™ï¸ Settings</div>
    <div class="nav" onclick="window.open('index.html','_blank')">ğŸ”— View Portal</div>
    <div class="nav" onclick="doLogout()">ğŸšª Logout</div>
  </nav>

  <main class="main">

    <!-- â•â•â• AFFILIATES â•â•â• -->
    <div class="page on" id="page-affiliates">
      <div class="ph"><h1>ğŸ‘¥ AFFILIATES</h1><p>Add, edit, or bulk-import affiliates</p></div>

      <div class="card">
        <div class="card-title">â• <span id="aff-form-title">Add Affiliate</span></div>
        <input type="hidden" id="aff-orig-id">
        <div class="row">
          <div class="fg"><label>Affiliate ID *</label><input type="text" id="a-id" placeholder="AFF12345"/></div>
          <div class="fg"><label>Display Name</label><input type="text" id="a-name" placeholder="John Doe"/></div>
          <div class="fg"><label>Promo Code *</label><input type="text" id="a-promo" placeholder="JOHN50"/></div>
        </div>
        <div class="row">
          <div class="fg"><label>Player / Referral Link</label><input type="text" id="a-player" placeholder="https://..."/></div>
          <div class="fg"><label>Android APK Link</label><input type="text" id="a-apk" placeholder="https://..."/></div>
          <div class="fg"><label>iOS App Link</label><input type="text" id="a-ios" placeholder="https://..."/></div>
        </div>
        <div class="row">
          <div class="fg"><label>Preferred Language</label>
            <select id="a-lang"><option value="en">English</option><option value="fr">French</option><option value="ar">Arabic</option><option value="es">Spanish</option><option value="pt">Portuguese</option></select>
          </div>
        </div>
        <div class="br"><button class="btn g" onclick="saveAff()">ğŸ’¾ Save Affiliate</button><button class="btn o" onclick="clearAff()">âœ• Clear</button></div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“Š Bulk Import from Excel</div>
        <div class="ib">Columns: <strong>A</strong>=Affiliate ID Â· <strong>B</strong>=Name Â· <strong>C</strong>=Promo Code Â· <strong>D</strong>=Player Link Â· <strong>E</strong>=APK Link Â· <strong>F</strong>=iOS Link Â· <strong>G</strong>=Language (en/fr/ar/es/pt)</div>
        <div class="dropzone" onclick="document.getElementById('xl-in').click()"><div class="dz-icon">ğŸ“‚</div><p><strong>Click to choose Excel file</strong><br>.xlsx or .xls</p></div>
        <input type="file" id="xl-in" accept=".xlsx,.xls" style="display:none" onchange="xlImport()"/>
        <div id="xl-prev" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:14px;flex-wrap:wrap;gap:9px">
            <span id="xl-count" style="color:var(--green);font-weight:700;font-size:.87rem"></span>
            <div class="br"><button class="btn g sm" onclick="xlConfirm()">âœ… Import All</button><button class="btn r sm" onclick="xlCancel()">âœ• Cancel</button></div>
          </div>
          <div class="ip" id="xl-table"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“‹ All Affiliates (<span id="aff-cnt">0</span>)</div>
        <div class="tw"><table><thead><tr><th>ID</th><th>Name</th><th>Code</th><th>Lang</th><th>Player Link</th><th>Actions</th></tr></thead><tbody id="aff-tbody"></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• BANNERS â•â•â• -->
    <div class="page" id="page-banners">
      <div class="ph"><h1>ğŸ–¼ï¸ BANNERS</h1><p>Upload multiple banners at once â€” set promo code zone and font for each</p></div>

      <!-- Global settings for this batch -->
      <div class="card">
        <div class="card-title">âš™ï¸ Batch Settings (applies to all images in this upload)</div>
        <div class="row">
          <div class="fg"><label>Language *</label>
            <select id="ban-lang"><option value="en">English</option><option value="fr">French</option><option value="ar">Arabic</option><option value="es">Spanish</option><option value="pt">Portuguese</option></select>
          </div>
          <div class="fg"><label>Banner Type *</label>
            <select id="ban-type" onchange="toggleDates()">
              <option value="dated">ğŸ“… Dated (has expiry)</option>
              <option value="evergreen">â™¾ï¸ Evergreen (no expiry)</option>
            </select>
          </div>
          <div class="fg" id="sg-start"><label>Start Date</label><input type="date" id="ban-start"/></div>
          <div class="fg" id="sg-end"><label>End Date</label><input type="date" id="ban-end"/></div>
        </div>
        <div class="ib" style="margin-bottom:0">ğŸ“Œ After adding images below, <strong>click each banner's "Set Promo Zone"</strong> to drag the promo code area onto that specific image.</div>
      </div>

      <!-- Drop zone for multiple images -->
      <div class="card">
        <div class="card-title">â¬†ï¸ Upload Banner Images (select multiple)</div>
        <div class="dropzone" id="banner-dz" onclick="document.getElementById('ban-files').click()" ondragover="dzDrag(event,true)" ondragleave="dzDrag(event,false)" ondrop="dzDrop(event)">
          <div class="dz-icon">ğŸ–¼ï¸</div>
          <p><strong>Click or drag & drop images here</strong><br>PNG, JPG â€” select as many as you need at once</p>
        </div>
        <input type="file" id="ban-files" accept="image/*" multiple style="display:none" onchange="addBanners()"/>
        <div id="banner-queue"></div>
        <div class="br" style="margin-top:14px" id="save-all-row" style="display:none">
          <button class="btn g" onclick="saveAllBanners()">ğŸ’¾ Save All Banners to Portal</button>
          <button class="btn r" onclick="clearQueue()">ğŸ—‘ï¸ Clear Queue</button>
          <span id="save-prog" style="font-size:.8rem;color:var(--muted)"></span>
        </div>
      </div>

      <!-- Promo Zone Editor Modal-style panel -->
      <div id="zone-editor" style="display:none">
        <div class="card" style="border-color:rgba(0,230,118,.4)">
          <div class="card-title">ğŸ¯ Set Promo Code Zone â€” <span id="ze-banner-name" style="color:var(--text);font-weight:400"></span></div>
          <div class="ib">
            <strong>Click and drag</strong> directly on the image to mark where the promo code text will appear.<br>
            The green box shows the selected area. Adjust font settings below after dragging.
          </div>
          <div class="canvas-editor" id="ze-wrap">
            <canvas id="ze-canvas"></canvas>
            <div class="drag-rect" id="drag-rect"><div class="drag-label" id="drag-label">PROMO CODE ZONE</div></div>
          </div>
          <div id="ze-controls" style="display:none">
            <div class="row" style="margin-top:10px">
              <div class="fg">
                <label>Font Family</label>
                <select id="ze-font" onchange="updateFontPreview()">
                  <option value="Bebas Neue">Bebas Neue</option>
                  <option value="Anton">Anton</option>
                  <option value="Russo One">Russo One</option>
                  <option value="Teko">Teko Bold</option>
                  <option value="Barlow Condensed">Barlow Condensed</option>
                  <option value="Black Han Sans">Black Han Sans</option>
                  <option value="Outfit">Outfit ExtraBold</option>
                  <option value="Arial Black">Arial Black</option>
                  <option value="Impact">Impact</option>
                </select>
                <div class="font-preview" id="font-preview">PROMO50</div>
              </div>
              <div class="fg">
                <label>Font Size (px)</label>
                <input type="number" id="ze-size" value="32" min="8" max="200" onchange="updateFontPreview()"/>
              </div>
              <div class="fg">
                <label>Text Color</label>
                <input type="color" id="ze-color" value="#ffffff" onchange="updateFontPreview()"/>
              </div>
              <div class="fg">
                <label>Text Align</label>
                <select id="ze-align" onchange="updateFontPreview()">
                  <option value="center">Center</option>
                  <option value="left">Left</option>
                  <option value="right">Right</option>
                </select>
              </div>
            </div>
            <div class="fg" style="margin-bottom:12px">
              <label>Zone Position (auto-filled by drag)</label>
              <input type="text" id="ze-info" readonly style="cursor:default;font-size:.76rem;color:var(--muted)"/>
            </div>
          </div>
          <div class="br">
            <button class="btn g" onclick="confirmZone()">âœ… Confirm This Zone</button>
            <button class="btn o" onclick="clearZone()">â†©ï¸ Redo Zone</button>
            <button class="btn r sm" onclick="closeZoneEditor()">âœ• Close</button>
          </div>
        </div>
      </div>

      <!-- Banner list -->
      <div class="card">
        <div class="card-title">ğŸ“‹ Saved Banners (<span id="ban-cnt">0</span>)</div>
        <div class="tw"><table><thead><tr><th>Preview</th><th>Type</th><th>Language</th><th>Dates</th><th>Promo Zone</th><th>Assigned Caption</th><th>Actions</th></tr></thead><tbody id="ban-tbody"></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• TEXTS â•â•â• -->
    <div class="page" id="page-texts">
      <div class="ph"><h1>âœï¸ POST CAPTIONS</h1><p>7 captions per language â€” edit, add, delete</p></div>
      <div class="card">
        <div class="card-title"><span id="txt-icon">â•</span> <span id="txt-title">Add Caption</span></div>
        <input type="hidden" id="txt-edit-id">
        <div class="ib">Placeholders: <strong>{{Player link}}</strong> Â· <strong>{{apk link}}</strong> Â· <strong>{{iOS link}}</strong> Â· <strong>{{Promo code}}</strong></div>
        <div class="row"><div class="fg"><label>Language *</label>
          <select id="txt-lang"><option value="en">English</option><option value="fr">French</option><option value="ar">Arabic</option><option value="es">Spanish</option><option value="pt">Portuguese</option></select>
        </div></div>
        <div class="fg" style="margin-bottom:14px"><label>Caption Text</label><textarea id="txt-body" rows="9"></textarea></div>
        <div class="br">
          <button class="btn g" onclick="saveTxt()">ğŸ’¾ Save</button>
          <button class="btn o" onclick="clearTxt()">âœ• Clear</button>
          <span id="txt-edit-note" style="display:none;font-size:.77rem;color:var(--amber)">âœï¸ Editing â€” Save to update</span>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ All Captions (<span id="txt-cnt">0</span>)</div>
        <div class="tabs">
          <button class="tab on" onclick="filterTxt('all',this)">All</button>
          <button class="tab" onclick="filterTxt('en',this)">ğŸ‡¬ğŸ‡§ EN</button>
          <button class="tab" onclick="filterTxt('fr',this)">ğŸ‡«ğŸ‡· FR</button>
          <button class="tab" onclick="filterTxt('ar',this)">ğŸ‡¸ğŸ‡¦ AR</button>
          <button class="tab" onclick="filterTxt('es',this)">ğŸ‡ªğŸ‡¸ ES</button>
          <button class="tab" onclick="filterTxt('pt',this)">ğŸ‡§ğŸ‡· PT</button>
        </div>
        <div id="txt-list"></div>
      </div>
    </div>

    <!-- â•â•â• BULK DOWNLOAD â•â•â• -->
    <div class="page" id="page-download">
      <div class="ph"><h1>ğŸ“¥ BULK DOWNLOAD</h1><p>Download all affiliates' banners with promo codes stamped â€” packaged as ZIP</p></div>
      <div class="card">
        <div class="card-title">âš™ï¸ Download Options</div>
        <div class="row">
          <div class="fg">
            <label>Language Filter</label>
            <select id="dl-lang">
              <option value="all">All Languages</option>
              <option value="en">English</option>
              <option value="fr">French</option>
              <option value="ar">Arabic</option>
              <option value="es">Spanish</option>
              <option value="pt">Portuguese</option>
            </select>
          </div>
          <div class="fg">
            <label>Banner Type</label>
            <select id="dl-type">
              <option value="all">All Banners</option>
              <option value="dated">Dated Only</option>
              <option value="evergreen">Evergreen Only</option>
            </select>
          </div>
          <div class="fg">
            <label>Affiliate Filter</label>
            <select id="dl-aff">
              <option value="all">All Affiliates</option>
            </select>
          </div>
        </div>
        <div class="ib">
          Files will be named: <strong>PROMOCODE_STARTDATE_to_ENDDATE.png</strong> (dated) or <strong>PROMOCODE_evergreen.png</strong><br>
          All files are zipped together. One zip per affiliate, or one combined zip.
        </div>
        <div class="row">
          <div class="fg">
            <label>ZIP Structure</label>
            <select id="dl-structure">
              <option value="flat">One ZIP for all affiliates</option>
              <option value="perAff">Separate ZIP per affiliate</option>
            </select>
          </div>
        </div>
        <div class="br">
          <button class="btn g" onclick="startBulkDownload()">ğŸ“¦ Generate &amp; Download ZIP</button>
          <button class="btn b" onclick="previewDownload()">ğŸ‘ Preview Files</button>
        </div>
        <div id="dl-progress" style="display:none;margin-top:14px">
          <div style="font-size:.82rem;color:var(--muted);margin-bottom:6px" id="dl-prog-text">Preparingâ€¦</div>
          <div class="prog-bar"><div class="prog-fill" id="dl-prog-fill" style="width:0"></div></div>
        </div>
        <div id="dl-preview-list" style="margin-top:14px;display:none"></div>
      </div>
    </div>

    <!-- â•â•â• SETTINGS â•â•â• -->
    <div class="page" id="page-settings">
      <div class="ph"><h1>âš™ï¸ SETTINGS</h1><p>Password, data backup, stats</p></div>
      <div class="card">
        <div class="card-title">ğŸ” Change Password</div>
        <div class="row">
          <div class="fg"><label>Current Password</label><input type="password" id="cur-pw" placeholder="Current"/></div>
          <div class="fg"><label>New Password</label><input type="password" id="new-pw" placeholder="New (min 4 chars)"/></div>
          <div class="fg"><label>Confirm New</label><input type="password" id="conf-pw" placeholder="Confirm"/></div>
        </div>
        <button class="btn g" onclick="changePw()">ğŸ”’ Update Password</button>
      </div>
      <div class="card">
        <div class="card-title">ğŸ’¾ Data Backup</div>
        <p style="color:var(--muted);font-size:.83rem;margin-bottom:16px;line-height:1.7">Export affiliates and captions (text data). Banner images are stored in IndexedDB â€” use the Bulk Download feature to export banners.</p>
        <div class="br">
          <button class="btn g" onclick="exportData()">ğŸ“¤ Export Backup (JSON)</button>
          <button class="btn a" onclick="document.getElementById('imp-in').click()">ğŸ“¥ Import Backup</button>
          <button class="btn r" onclick="clearAll()">ğŸ—‘ï¸ Clear All Data</button>
        </div>
        <input type="file" id="imp-in" accept=".json" style="display:none" onchange="importData()"/>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“Š Stats</div>
        <div id="stats-area" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:4px"></div>
      </div>
    </div>

  </main>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDEXEDDB â€” stores banner image blobs (bypasses localStorage 5MB limit)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let DB = null;
const DB_NAME = 'megapari_v2', DB_VER = 1;
const STORE_IMGS = 'banner_images'; // key=bannerId, val=dataURL string

function openDB(){
  return new Promise((res,rej)=>{
    if(DB){res(DB);return;}
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE_IMGS)) db.createObjectStore(STORE_IMGS);
    };
    req.onsuccess = e => { DB = e.target.result; res(DB); };
    req.onerror = e => rej(e.target.error);
  });
}
async function dbPut(store, key, val){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readwrite');
    tx.objectStore(store).put(val, key);
    tx.oncomplete = ()=>res();
    tx.onerror = e=>rej(e.target.error);
  });
}
async function dbGet(store, key){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = ()=>res(req.result);
    req.onerror = e=>rej(e.target.error);
  });
}
async function dbDel(store, key){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readwrite');
    tx.objectStore(store).delete(key);
    tx.oncomplete = ()=>res();
    tx.onerror = e=>rej(e.target.error);
  });
}
async function dbGetAll(store){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(store,'readonly');
    const result = {};
    const cursor = tx.objectStore(store).openCursor();
    cursor.onsuccess = e => {
      const c = e.target.result;
      if(c){result[c.key]=c.value;c.continue();}
      else res(result);
    };
    cursor.onerror = e=>rej(e.target.error);
  });
}

// Compress image to JPEG at ~800px wide to save space
function compressImage(dataURL, maxW=900){
  return new Promise(res=>{
    const img = new Image();
    img.onload = ()=>{
      const sc = Math.min(1, maxW/img.width);
      const c = document.createElement('canvas');
      c.width = Math.round(img.width*sc);
      c.height = Math.round(img.height*sc);
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      // store as PNG to preserve quality for download
      res(c.toDataURL('image/png'));
    };
    img.src = dataURL;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOCALSTORAGE helpers (for text data only â€” no images)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gd(k,d){try{const v=JSON.parse(localStorage.getItem(k));return v!==null?v:d;}catch(e){return d;}}
function sd(k,v){localStorage.setItem(k,JSON.stringify(v));}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8);}
const LS = {en:'English',fr:'French',ar:'Arabic',es:'Spanish',pt:'Portuguese'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doLogin(){
  const pw = document.getElementById('pw-in').value;
  const stored = localStorage.getItem('adminPw')||'admin123';
  if(pw===stored){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('panel').style.display='flex';
    init();
  } else {
    const el=document.getElementById('pw-err');
    el.style.display='block';
    setTimeout(()=>el.style.display='none',3000);
  }
}
document.getElementById('pw-in').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
function doLogout(){
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('panel').style.display='none';
  document.getElementById('pw-in').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(p, el){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.nav').forEach(x=>x.classList.remove('on'));
  document.getElementById('page-'+p).classList.add('on');
  if(el) el.classList.add('on');
  if(p==='settings') renderStats();
  if(p==='texts'){txtFilter='all'; renderTxts();}
  if(p==='banners') renderBanners();
  if(p==='download') populateDlAffs();
}

function init(){
  ensureDefTxts();
  renderAffs();
  renderBanners();
  renderTxts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AFFILIATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAff(){
  const origId = document.getElementById('aff-orig-id').value;
  const id = document.getElementById('a-id').value.trim();
  const promo = document.getElementById('a-promo').value.trim();
  if(!id||!promo){toast('ID and Promo Code required','err');return;}
  let affs = gd('affiliates',[]);
  const obj = {
    id, name:document.getElementById('a-name').value.trim(),
    promoCode:promo,
    playerLink:document.getElementById('a-player').value.trim(),
    apkLink:document.getElementById('a-apk').value.trim(),
    iosLink:document.getElementById('a-ios').value.trim(),
    lang:document.getElementById('a-lang').value,
  };
  if(origId){
    affs = affs.map(a=>a.id===origId?obj:a);
  } else {
    if(affs.find(a=>a.id.toLowerCase()===id.toLowerCase())){toast('ID already exists','err');return;}
    affs.push(obj);
  }
  sd('affiliates',affs);
  clearAff();
  renderAffs();
  toast('âœ… Affiliate saved!');
}
function clearAff(){
  ['a-id','a-name','a-promo','a-player','a-apk','a-ios'].forEach(f=>document.getElementById(f).value='');
  document.getElementById('aff-orig-id').value='';
  document.getElementById('aff-form-title').textContent='Add Affiliate';
}
function editAff(id){
  const a = gd('affiliates',[]).find(x=>x.id===id);
  if(!a) return;
  document.getElementById('aff-orig-id').value=a.id;
  document.getElementById('a-id').value=a.id;
  document.getElementById('a-name').value=a.name||'';
  document.getElementById('a-promo').value=a.promoCode||'';
  document.getElementById('a-player').value=a.playerLink||'';
  document.getElementById('a-apk').value=a.apkLink||'';
  document.getElementById('a-ios').value=a.iosLink||'';
  document.getElementById('a-lang').value=a.lang||'en';
  document.getElementById('aff-form-title').textContent='Edit: '+id;
  window.scrollTo({top:0,behavior:'smooth'});
}
function delAff(id){
  if(!confirm('Delete "'+id+'"?')) return;
  sd('affiliates', gd('affiliates',[]).filter(a=>a.id!==id));
  renderAffs();
  toast('Deleted');
}
function renderAffs(){
  const affs = gd('affiliates',[]);
  document.getElementById('aff-cnt').textContent = affs.length;
  const tb = document.getElementById('aff-tbody');
  if(!affs.length){tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px">No affiliates yet</td></tr>';return;}
  tb.innerHTML = affs.map(a=>`<tr>
    <td><strong style="color:var(--green)">${eh(a.id)}</strong></td>
    <td>${eh(a.name||'â€”')}</td>
    <td><span class="bx bx-g">${eh(a.promoCode)}</span></td>
    <td><span class="bx bx-b">${LS[a.lang]||a.lang}</span></td>
    <td style="font-size:.74rem">${a.playerLink?`<a href="${eh(a.playerLink)}" target="_blank" style="color:var(--muted)">â†— link</a>`:'â€”'}</td>
    <td><div class="br">
      <button class="btn a sm" onclick="editAff('${ea(a.id)}')">âœï¸</button>
      <button class="btn r sm" onclick="delAff('${ea(a.id)}')">ğŸ—‘ï¸</button>
    </div></td>
  </tr>`).join('');
}

// Excel
let xlRows=[];
function xlImport(){
  const file=document.getElementById('xl-in').files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const wb=XLSX.read(e.target.result,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      const isHdr=r=>r[0]&&String(r[0]).toLowerCase().match(/id|affiliate|name/);
      const data=rows.filter((r,i)=>!(i===0&&isHdr(r))).filter(r=>String(r[0]||'').trim());
      xlRows=data.map(r=>({
        id:String(r[0]||'').trim(), name:String(r[1]||'').trim(),
        promoCode:String(r[2]||'').trim(), playerLink:String(r[3]||'').trim(),
        apkLink:String(r[4]||'').trim(), iosLink:String(r[5]||'').trim(),
        lang:String(r[6]||'en').trim().toLowerCase()||'en',
      })).filter(r=>r.id&&r.promoCode);
      if(!xlRows.length){toast('No valid rows found','err');return;}
      document.getElementById('xl-count').textContent=`âœ… ${xlRows.length} affiliates ready`;
      const rows2=xlRows.slice(0,15).map(r=>`<tr><td>${eh(r.id)}</td><td>${eh(r.name||'â€”')}</td><td>${eh(r.promoCode)}</td><td>${eh(r.lang)}</td></tr>`).join('');
      const more=xlRows.length>15?`<tr><td colspan="4" style="color:var(--muted);text-align:center">...and ${xlRows.length-15} more</td></tr>`:'';
      document.getElementById('xl-table').innerHTML=`<table><thead><tr><th>ID</th><th>Name</th><th>Promo</th><th>Lang</th></tr></thead><tbody>${rows2}${more}</tbody></table>`;
      document.getElementById('xl-prev').style.display='block';
    }catch(err){toast('Error reading file: '+err.message,'err');}
  };
  reader.readAsArrayBuffer(file);
}
function xlConfirm(){
  let affs=gd('affiliates',[]);
  let added=0,upd=0;
  xlRows.forEach(r=>{
    const i=affs.findIndex(a=>a.id.toLowerCase()===r.id.toLowerCase());
    if(i>=0){affs[i]=r;upd++;}else{affs.push(r);added++;}
  });
  sd('affiliates',affs);
  xlCancel();
  renderAffs();
  toast(`âœ… ${added} added, ${upd} updated`);
}
function xlCancel(){
  xlRows=[];
  document.getElementById('xl-in').value='';
  document.getElementById('xl-prev').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BANNERS â€” Multi-upload with per-banner zone editor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Queue: [{id, file, name, dataURL, compressed, zone:{x,y,w,h,font,size,color,align}, status}]
let queue = [];
let activeQueueIdx = null; // which queue item is being zone-edited
let zeState = { isDragging:false, start:{x:0,y:0}, zone:null, confirmed:false };
let zeScale = 1;

function dzDrag(e, on){ e.preventDefault(); document.getElementById('banner-dz').classList.toggle('drag',on); }
function dzDrop(e){ e.preventDefault(); document.getElementById('banner-dz').classList.remove('drag'); handleFiles(e.dataTransfer.files); }
function addBanners(){ handleFiles(document.getElementById('ban-files').files); }

function handleFiles(files){
  if(!files||!files.length) return;
  Array.from(files).forEach(f=>{
    if(!f.type.startsWith('image/')) return;
    const id = uid();
    const entry = { id, file:f, name:f.name, dataURL:null, compressed:null, zone:null, status:'pending' };
    queue.push(entry);
    const reader = new FileReader();
    reader.onload = async e => {
      entry.dataURL = e.target.result;
      // compress to save memory
      entry.compressed = await compressImage(e.target.result, 1200);
      renderQueue();
    };
    reader.readAsDataURL(f);
  });
  renderQueue();
}

function renderQueue(){
  const qEl = document.getElementById('banner-queue');
  const saveRow = document.getElementById('save-all-row');
  if(!queue.length){ qEl.innerHTML=''; saveRow.style.display='none'; return; }
  saveRow.style.display='flex';
  qEl.innerHTML = queue.map((item,i)=>`
    <div class="bq-item" id="bqi-${item.id}">
      <div class="bq-top">
        ${item.compressed?`<img class="bq-thumb" src="${item.compressed}" alt=""/>`:'<div class="bq-thumb" style="background:var(--card);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.7rem">Loadingâ€¦</div>'}
        <span class="bq-name">${eh(item.name)}</span>
        <span class="bq-status ${item.status}">${item.status==='pending'?'â³ Pending':item.status==='done'?'âœ… Zone Set':'âŒ Error'}</span>
        <div class="br" style="margin:0">
          ${item.compressed?`<button class="btn ${item.zone?'a':'g'} sm" onclick="openZoneEditor(${i})">${item.zone?'âœï¸ Edit Zone':'ğŸ¯ Set Zone'}</button>`:''}
          <button class="btn r sm" onclick="removeFromQueue(${i})">âœ•</button>
        </div>
      </div>
      ${item.zone?`<div style="font-size:.74rem;color:var(--green);padding:4px 0">âœ… Zone: X${item.zone.x} Y${item.zone.y} W${item.zone.w}Ã—H${item.zone.h} Â· Font: ${item.zone.font} ${item.zone.size}px</div>`:'<div style="font-size:.73rem;color:var(--amber);padding:4px 0">âš ï¸ No promo zone set â€” banner will be saved without promo code stamping</div>'}
    </div>`).join('');
}

function removeFromQueue(i){ queue.splice(i,1); renderQueue(); }
function clearQueue(){ queue=[]; renderQueue(); closeZoneEditor(); }

// â”€â”€ ZONE EDITOR â”€â”€
function openZoneEditor(i){
  activeQueueIdx = i;
  const item = queue[i];
  if(!item.compressed){ toast('Image still loadingâ€¦','err'); return; }

  const edEl = document.getElementById('zone-editor');
  edEl.style.display='block';
  edEl.scrollIntoView({behavior:'smooth'});
  document.getElementById('ze-banner-name').textContent = item.name;
  document.getElementById('ze-controls').style.display='none';
  document.getElementById('drag-rect').style.display='none';

  zeState = { isDragging:false, start:{x:0,y:0}, zone:null, confirmed:false };

  // Load image into canvas
  const wrap = document.getElementById('ze-wrap');
  const canvas = document.getElementById('ze-canvas');
  const img = new Image();
  img.onload = function(){
    const maxW = Math.min(wrap.clientWidth||800, 800);
    zeScale = Math.min(1, maxW/img.width);
    canvas.width = img.width; canvas.height = img.height;
    canvas.style.width = Math.round(img.width*zeScale)+'px';
    canvas.style.height = Math.round(img.height*zeScale)+'px';
    canvas.getContext('2d').drawImage(img,0,0);

    // If zone already set, show it
    if(item.zone){
      showExistingZone(item.zone);
      document.getElementById('ze-controls').style.display='block';
    }
  };
  img.src = item.compressed;

  // Attach drag
  attachZoneDrag(canvas, wrap);

  // Restore existing zone settings if available
  if(item.zone){
    document.getElementById('ze-font').value = item.zone.font||'Bebas Neue';
    document.getElementById('ze-size').value = item.zone.size||32;
    document.getElementById('ze-color').value = item.zone.color||'#ffffff';
    document.getElementById('ze-align').value = item.zone.align||'center';
    updateFontPreview();
  }
}

function showExistingZone(z){
  const rect = document.getElementById('drag-rect');
  const canvas = document.getElementById('ze-canvas');
  const wrap = document.getElementById('ze-wrap');
  const cr = canvas.getBoundingClientRect(), wr = wrap.getBoundingClientRect();
  rect.style.display='block';
  rect.style.left = (z.x*zeScale)+'px';
  rect.style.top = (z.y*zeScale)+'px';
  rect.style.width = (z.w*zeScale)+'px';
  rect.style.height = (z.h*zeScale)+'px';
  document.getElementById('ze-info').value = `X:${z.x} Y:${z.y} W:${z.w} H:${z.h}`;
}

function attachZoneDrag(canvas, wrap){
  // Remove previous listeners via clone trick
  const newC = canvas.cloneNode(false); // false = don't clone children
  canvas.parentNode.replaceChild(newC, canvas);

  // Redraw image on new canvas
  const item = queue[activeQueueIdx];
  const img2 = new Image();
  img2.onload = ()=>newC.getContext('2d').drawImage(img2,0,0);
  img2.src = item.compressed;

  const rect = document.getElementById('drag-rect');

  function getPos(e){
    const r = newC.getBoundingClientRect();
    const src = e.touches ? e.touches[0] : e;
    const cx = Math.max(0, Math.min(src.clientX-r.left, r.width));
    const cy = Math.max(0, Math.min(src.clientY-r.top, r.height));
    return { x: cx/zeScale, y: cy/zeScale };
  }

  function onDown(e){
    e.preventDefault();
    zeState.isDragging = true;
    zeState.start = getPos(e);
    zeState.zone = null;
    rect.style.display='block';
    rect.style.width='0'; rect.style.height='0';
    document.getElementById('ze-controls').style.display='none';
  }
  function onMove(e){
    if(!zeState.isDragging) return;
    e.preventDefault();
    const cur = getPos(e);
    const x = Math.min(zeState.start.x, cur.x);
    const y = Math.min(zeState.start.y, cur.y);
    const w = Math.abs(cur.x - zeState.start.x);
    const h = Math.abs(cur.y - zeState.start.y);
    zeState.zone = { x:Math.round(x), y:Math.round(y), w:Math.round(w), h:Math.round(h) };
    const wr = wrap.getBoundingClientRect(), cr = newC.getBoundingClientRect();
    rect.style.left = (cr.left-wr.left + x*zeScale)+'px';
    rect.style.top = (cr.top-wr.top + y*zeScale)+'px';
    rect.style.width = (w*zeScale)+'px';
    rect.style.height = (h*zeScale)+'px';
  }
  function onUp(){
    if(!zeState.isDragging) return;
    zeState.isDragging = false;
    if(zeState.zone && zeState.zone.w>6 && zeState.zone.h>6){
      document.getElementById('ze-info').value = `X:${zeState.zone.x} Y:${zeState.zone.y} W:${zeState.zone.w} H:${zeState.zone.h}`;
      document.getElementById('ze-controls').style.display='block';
      updateFontPreview();
    }
  }

  newC.addEventListener('mousedown', onDown);
  newC.addEventListener('touchstart', onDown, {passive:false});
  document.addEventListener('mousemove', onMove);
  document.addEventListener('touchmove', onMove, {passive:false});
  document.addEventListener('mouseup', onUp);
  document.addEventListener('touchend', onUp);
}

function updateFontPreview(){
  const font = document.getElementById('ze-font').value;
  const size = document.getElementById('ze-size').value;
  const color = document.getElementById('ze-color').value;
  const prev = document.getElementById('font-preview');
  prev.style.fontFamily = `'${font}', sans-serif`;
  prev.style.fontSize = Math.min(parseInt(size)||32, 48)+'px';
  prev.style.color = color;
  prev.style.fontWeight = '700';
}

function confirmZone(){
  if(!zeState.zone && !document.getElementById('ze-info').value){
    toast('Please drag a zone on the image first','err'); return;
  }
  const zone = zeState.zone || (()=>{
    // recover from existing
    const parts = document.getElementById('ze-info').value.match(/X:(\d+) Y:(\d+) W:(\d+) H:(\d+)/);
    if(parts) return {x:+parts[1],y:+parts[2],w:+parts[3],h:+parts[4]};
    return null;
  })();
  if(!zone){toast('No zone data','err');return;}
  zone.font = document.getElementById('ze-font').value;
  zone.size = parseInt(document.getElementById('ze-size').value)||32;
  zone.color = document.getElementById('ze-color').value;
  zone.align = document.getElementById('ze-align').value;
  queue[activeQueueIdx].zone = zone;
  queue[activeQueueIdx].status = 'done';
  closeZoneEditor();
  renderQueue();
  toast('âœ… Zone confirmed!');
}

function clearZone(){
  zeState.zone = null;
  document.getElementById('drag-rect').style.display='none';
  document.getElementById('ze-controls').style.display='none';
  document.getElementById('ze-info').value='';
}

function closeZoneEditor(){
  document.getElementById('zone-editor').style.display='none';
  activeQueueIdx = null;
}

// â”€â”€ SAVE ALL BANNERS â”€â”€
async function saveAllBanners(){
  if(!queue.length){toast('No banners in queue','err');return;}
  const evergreen = document.getElementById('ban-type').value==='evergreen';
  const startDate = document.getElementById('ban-start').value;
  const endDate = document.getElementById('ban-end').value;
  if(!evergreen && (!startDate||!endDate)){toast('Set start and end dates','err');return;}

  const prog = document.getElementById('save-prog');
  let saved = 0;
  const banners = gd('banners',[]);
  const texts = gd('texts',[]);
  const lang = document.getElementById('ban-lang').value;

  // Get captions for this language to pre-populate assignment
  const langTexts = texts.filter(t=>t.lang===lang);

  for(const item of queue){
    if(!item.compressed){toast(`${item.name} still loading, try again`,'err');continue;}
    try{
      const bid = item.id;
      // Store full-resolution image in IndexedDB
      await dbPut(STORE_IMGS, bid, item.compressed);

      const b = {
        id:bid, lang, evergreen,
        startDate:evergreen?null:startDate, endDate:evergreen?null:endDate,
        name:item.name, promoConfig:item.zone||null,
        // Auto-assign a caption (cycle through available)
        assignedTextId: langTexts.length ? langTexts[saved % langTexts.length].id : null,
        createdAt:Date.now(),
      };
      banners.push(b);
      saved++;
      prog.textContent = `Saving ${saved}/${queue.length}â€¦`;
    }catch(err){
      toast('Error saving '+item.name+': '+err.message,'err');
    }
  }
  sd('banners', banners);
  clearQueue();
  renderBanners();
  prog.textContent = '';
  toast(`âœ… ${saved} banner(s) saved!`);
}

function toggleDates(){
  const ev = document.getElementById('ban-type').value==='evergreen';
  document.getElementById('sg-start').style.display = ev?'none':'';
  document.getElementById('sg-end').style.display = ev?'none':'';
}

async function renderBanners(){
  const banners = gd('banners',[]);
  document.getElementById('ban-cnt').textContent = banners.length;
  const tb = document.getElementById('ban-tbody');
  if(!banners.length){tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">No banners saved yet</td></tr>';return;}
  const texts = gd('texts',[]);
  tb.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:12px;font-size:.78rem">Loading previewsâ€¦</td></tr>';

  // Load previews async
  const rows = await Promise.all(banners.map(async b=>{
    let thumbSrc = '';
    try{ const d = await dbGet(STORE_IMGS, b.id); if(d) thumbSrc=d; }catch(e){}
    const thumb = thumbSrc
      ? `<img src="${thumbSrc}" style="height:50px;width:80px;object-fit:cover;border-radius:6px;border:1px solid var(--border)"/>`
      : `<div style="width:80px;height:50px;background:var(--card2);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.65rem;color:var(--muted)">No img</div>`;
    const txt = texts.find(t=>t.id===b.assignedTextId);
    const assign = txt ? `<span style="font-size:.72rem;color:var(--green)">${LS[txt.lang]} Caption</span>` : '<span style="color:var(--muted);font-size:.72rem">None</span>';
    return `<tr>
      <td>${thumb}</td>
      <td><span class="bx ${b.evergreen?'bx-a':'bx-g'}">${b.evergreen?'â™¾ï¸ Evergreen':'ğŸ“… Dated'}</span></td>
      <td>${LS[b.lang]||b.lang}</td>
      <td style="font-size:.76rem;color:var(--muted)">${b.evergreen?'No expiry':(b.startDate+' â†’ '+b.endDate)}</td>
      <td>${b.promoConfig?'<span class="bx bx-g">âœ“ Set</span>':'<span style="color:var(--muted);font-size:.73rem">None</span>'}</td>
      <td>
        ${assign}
        <select onchange="assignText('${b.id}',this.value)" style="margin-top:4px;font-size:.72rem;padding:3px 6px;background:#0a1209;border:1px solid var(--border);border-radius:5px;color:var(--text);width:100%">
          <option value="">â€” Assign caption â€”</option>
          ${texts.filter(t=>t.lang===b.lang).map(t=>`<option value="${t.id}" ${t.id===b.assignedTextId?'selected':''}>${LS[t.lang]} #${texts.indexOf(t)+1}</option>`).join('')}
        </select>
      </td>
      <td><button class="btn r sm" onclick="delBanner('${b.id}')">ğŸ—‘ï¸</button></td>
    </tr>`;
  }));
  tb.innerHTML = rows.join('');
}

function assignText(bannerId, textId){
  const banners = gd('banners',[]);
  const b = banners.find(x=>x.id===bannerId);
  if(b){ b.assignedTextId = textId||null; sd('banners',banners); toast('Caption assigned'); }
}

async function delBanner(id){
  if(!confirm('Delete this banner?')) return;
  sd('banners', gd('banners',[]).filter(b=>b.id!==id));
  try{ await dbDel(STORE_IMGS, id); }catch(e){}
  renderBanners();
  toast('Deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEXTS / CAPTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let txtFilter='all';
function saveTxt(){
  const editId = document.getElementById('txt-edit-id').value;
  const content = document.getElementById('txt-body').value.trim();
  const lang = document.getElementById('txt-lang').value;
  if(!content){toast('Caption text required','err');return;}
  let texts = gd('texts',[]);
  const obj = {id:editId||uid(), lang, content};
  if(editId) texts = texts.map(t=>t.id===editId?obj:t);
  else texts.push(obj);
  sd('texts',texts);
  clearTxt();
  renderTxts();
  toast('âœ… Caption saved!');
}
function clearTxt(){
  document.getElementById('txt-body').value='';
  document.getElementById('txt-edit-id').value='';
  document.getElementById('txt-title').textContent='Add Caption';
  document.getElementById('txt-icon').textContent='â•';
  document.getElementById('txt-edit-note').style.display='none';
}
function editTxt(id){
  const t = gd('texts',[]).find(x=>x.id===id);
  if(!t) return;
  document.getElementById('txt-edit-id').value=t.id;
  document.getElementById('txt-lang').value=t.lang;
  document.getElementById('txt-body').value=t.content;
  document.getElementById('txt-title').textContent='Edit Caption';
  document.getElementById('txt-icon').textContent='âœï¸';
  document.getElementById('txt-edit-note').style.display='inline';
  window.scrollTo({top:0,behavior:'smooth'});
}
function delTxt(id){
  if(!confirm('Delete this caption?')) return;
  sd('texts', gd('texts',[]).filter(t=>t.id!==id));
  renderTxts();
  toast('Deleted');
}
function filterTxt(lang,el){
  txtFilter=lang;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  if(el) el.classList.add('on');
  renderTxts();
}
function renderTxts(){
  const texts = gd('texts',[]);
  const filtered = txtFilter==='all'?texts:texts.filter(t=>t.lang===txtFilter);
  document.getElementById('txt-cnt').textContent = texts.length;
  const c = document.getElementById('txt-list');
  if(!filtered.length){c.innerHTML='<div style="text-align:center;color:var(--muted);padding:24px">No captions found</div>';return;}
  c.innerHTML = filtered.map((t,i)=>`<div class="tc">
    <div class="tc-top">
      <div style="display:flex;align-items:center;gap:7px">
        <span class="bx bx-g">${LS[t.lang]||t.lang}</span>
        <span style="font-size:.7rem;color:var(--muted)">#${i+1}</span>
      </div>
      <div class="br">
        <button class="btn a sm" onclick="editTxt('${t.id}')">âœï¸ Edit</button>
        <button class="btn r sm" onclick="delTxt('${t.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>
    <pre>${eh(t.content)}</pre>
  </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULK DOWNLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateDlAffs(){
  const affs = gd('affiliates',[]);
  const sel = document.getElementById('dl-aff');
  sel.innerHTML = '<option value="all">All Affiliates</option>' +
    affs.map(a=>`<option value="${ea(a.id)}">${eh(a.id)} â€” ${eh(a.promoCode)}</option>`).join('');
}

async function previewDownload(){
  const {affs, banners} = getDlScope();
  const prev = document.getElementById('dl-preview-list');
  if(!banners.length || !affs.length){
    prev.style.display='block';
    prev.innerHTML='<div style="color:var(--muted);font-size:.83rem;padding:10px">No matching affiliates or banners found.</div>';
    return;
  }
  let lines = [];
  banners.forEach(b=>{
    affs.forEach(a=>{
      if(!b.promoConfig) return; // skip if no zone
      const fname = makeFilename(a.promoCode, b);
      lines.push(`<div style="font-size:.78rem;padding:4px 0;border-bottom:1px solid var(--border);color:var(--muted)">${eh(a.id)} / <strong style="color:var(--text)">${fname}</strong></div>`);
    });
  });
  prev.style.display='block';
  prev.innerHTML=`<div style="font-size:.75rem;color:var(--green);margin-bottom:8px;font-weight:700">${lines.length} file(s) will be generated:</div>`
    + `<div style="max-height:220px;overflow-y:auto;background:var(--card2);border-radius:8px;padding:8px 12px">${lines.join('')}</div>`;
}

function getDlScope(){
  const dlLang = document.getElementById('dl-lang').value;
  const dlType = document.getElementById('dl-type').value;
  const dlAff = document.getElementById('dl-aff').value;
  let affs = gd('affiliates',[]);
  let banners = gd('banners',[]);
  if(dlLang!=='all'){ affs=affs.filter(a=>a.lang===dlLang); banners=banners.filter(b=>b.lang===dlLang); }
  if(dlType==='dated') banners=banners.filter(b=>!b.evergreen);
  if(dlType==='evergreen') banners=banners.filter(b=>b.evergreen);
  if(dlAff!=='all') affs=affs.filter(a=>a.id===dlAff);
  return {affs, banners};
}

function makeFilename(promoCode, banner){
  const safe = s => String(s||'').replace(/[^a-zA-Z0-9_\-]/g,'_');
  if(banner.evergreen) return `${safe(promoCode)}_evergreen.png`;
  return `${safe(promoCode)}_${safe(banner.startDate)}_to_${safe(banner.endDate)}.png`;
}

function stampCanvasFull(ctx, banner, affiliatePromoCode){
  if(!banner.promoConfig || !affiliatePromoCode) return;
  const pc = banner.promoConfig;
  ctx.save();
  ctx.beginPath(); ctx.rect(pc.x, pc.y, pc.w, pc.h); ctx.clip();
  const fontFamily = pc.font ? `'${pc.font}'` : 'Arial Black';
  ctx.font = `bold ${pc.size||pc.fontSize||32}px ${fontFamily}, Arial, sans-serif`;
  ctx.fillStyle = pc.color||'#ffffff';
  const align = pc.align||'center';
  ctx.textAlign = align;
  ctx.textBaseline = 'middle';
  const textX = align==='center' ? pc.x+(pc.w/2) : align==='left' ? pc.x+4 : pc.x+pc.w-4;
  ctx.fillText(affiliatePromoCode, textX, pc.y+(pc.h/2), pc.w);
  ctx.restore();
}

async function startBulkDownload(){
  const {affs, banners} = getDlScope();
  if(!banners.length){toast('No banners match your filters','err');return;}
  if(!affs.length){toast('No affiliates match your filters','err');return;}

  const structure = document.getElementById('dl-structure').value;
  const progEl = document.getElementById('dl-progress');
  const progText = document.getElementById('dl-prog-text');
  const progFill = document.getElementById('dl-prog-fill');
  progEl.style.display='block';

  const total = affs.length * banners.length;
  let done = 0;

  // Load all banner images from IndexedDB upfront
  const imgCache = {};
  for(const b of banners){
    try{ imgCache[b.id] = await dbGet(STORE_IMGS, b.id); }catch(e){ imgCache[b.id]=null; }
  }

  function loadImg(src){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=()=>res(null); i.src=src; }); }

  if(structure==='perAff'){
    // One zip per affiliate
    for(const aff of affs){
      const zip = new JSZip();
      const folder = zip.folder(aff.id+'_'+aff.promoCode);
      for(const b of banners){
        const src = imgCache[b.id];
        if(!src){ done++; continue; }
        const img = await loadImg(src);
        if(!img){ done++; continue; }
        const c = document.createElement('canvas');
        c.width=img.width; c.height=img.height;
        const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
        stampCanvasFull(ctx, b, aff.promoCode);
        const blob = await new Promise(res=>c.toBlob(res,'image/png'));
        const fname = makeFilename(aff.promoCode, b);
        folder.file(fname, blob);
        done++;
        progText.textContent = `Processing ${done}/${total}â€¦`;
        progFill.style.width = Math.round(done/total*100)+'%';
        await new Promise(r=>setTimeout(r,10));
      }
      const zipBlob = await zip.generateAsync({type:'blob'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(zipBlob);
      a.download = `megapari_${aff.id}_${aff.promoCode}.zip`;
      a.click();
      await new Promise(r=>setTimeout(r,300));
    }
  } else {
    // One combined zip
    const zip = new JSZip();
    for(const aff of affs){
      const folder = zip.folder(aff.id+'_'+aff.promoCode);
      for(const b of banners){
        const src = imgCache[b.id];
        if(!src){ done++; continue; }
        const img = await loadImg(src);
        if(!img){ done++; continue; }
        const c = document.createElement('canvas');
        c.width=img.width; c.height=img.height;
        const ctx=c.getContext('2d'); ctx.drawImage(img,0,0);
        stampCanvasFull(ctx, b, aff.promoCode);
        const blob = await new Promise(res=>c.toBlob(res,'image/png'));
        const fname = makeFilename(aff.promoCode, b);
        folder.file(fname, blob);
        done++;
        progText.textContent = `Processing ${done}/${total}â€¦`;
        progFill.style.width = Math.round(done/total*100)+'%';
        await new Promise(r=>setTimeout(r,10));
      }
    }
    progText.textContent = 'Compressing ZIPâ€¦';
    const zipBlob = await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:6}});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(zipBlob);
    a.download = `megapari_banners_${new Date().toISOString().slice(0,10)}.zip`;
    a.click();
  }

  progText.textContent = 'âœ… Download complete!';
  setTimeout(()=>{ progEl.style.display='none'; },3000);
  toast('âœ… ZIP download ready!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changePw(){
  const cur=document.getElementById('cur-pw').value;
  const nw=document.getElementById('new-pw').value;
  const conf=document.getElementById('conf-pw').value;
  const stored=localStorage.getItem('adminPw')||'admin123';
  if(cur!==stored){toast('Current password wrong','err');return;}
  if(!nw||nw.length<4){toast('Min 4 characters','err');return;}
  if(nw!==conf){toast('Passwords do not match','err');return;}
  localStorage.setItem('adminPw',nw);
  ['cur-pw','new-pw','conf-pw'].forEach(f=>document.getElementById(f).value='');
  toast('âœ… Password updated!');
}
function exportData(){
  const d={affiliates:gd('affiliates',[]),texts:gd('texts',[]),exportedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='megapari-backup-'+new Date().toISOString().slice(0,10)+'.json'; a.click();
  toast('âœ… Exported!');
}
function importData(){
  const file=document.getElementById('imp-in').files[0]; if(!file) return;
  const r=new FileReader();
  r.onload=function(e){
    try{
      const d=JSON.parse(e.target.result);
      if(d.affiliates) sd('affiliates',d.affiliates);
      if(d.texts) sd('texts',d.texts);
      init(); toast('âœ… Imported!');
    }catch(err){toast('Invalid file','err');}
  };
  r.readAsText(file);
}
function clearAll(){
  if(!confirm('Delete ALL data? Cannot be undone.')) return;
  if(!confirm('FINAL: delete everything?')) return;
  ['affiliates','banners','texts'].forEach(k=>localStorage.removeItem(k));
  openDB().then(db=>{ try{ db.transaction(STORE_IMGS,'readwrite').objectStore(STORE_IMGS).clear(); }catch(e){} });
  init(); toast('All cleared');
}
function renderStats(){
  const a=gd('affiliates',[]).length;
  const b=gd('banners',[]);
  const t=gd('texts',[]);
  const byL={en:0,fr:0,ar:0,es:0,pt:0};
  t.forEach(x=>{if(byL[x.lang]!==undefined)byL[x.lang]++;});
  const sc=(v,l,c)=>`<div style="background:var(--card2);border:1px solid var(--border);border-radius:9px;padding:14px;text-align:center"><div style="font-size:1.7rem;font-weight:700;color:${c};font-family:'Bebas Neue',sans-serif">${v}</div><div style="font-size:.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:3px">${l}</div></div>`;
  document.getElementById('stats-area').innerHTML=
    sc(a,'Affiliates','var(--green)')+sc(b.length,'Banners','var(--amber)')+
    sc(t.length,'Captions','var(--blue)')+Object.entries(byL).map(([l,n])=>sc(n,LS[l]+' Capts','var(--muted)')).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,type){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.background=type==='err'?'var(--red)':'var(--green)';
  t.style.color=type==='err'?'#fff':'#000';
  t.classList.add('on'); setTimeout(()=>t.classList.remove('on'),2800);
}
function eh(s){const d=document.createElement('div');d.textContent=String(s||'');return d.innerHTML;}
function ea(s){return String(s||'').replace(/'/g,"\\'");}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEFAULT TEXTS â€” 7 per language (35 total)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDefTxts(){
  return [
    {id:'e1',lang:'en',content:"âš½ğŸ”¥ BIG MATCH ENERGY STARTS HERE!\nTurn every game into real winnings with Megapari. Odds are hot, payouts are fast, and the action never stops.\nğŸ¯ Register now: {{Player link}}\nğŸ“² Android APK: {{apk link}}\nğŸ iOS app: {{iOS link}}\nğŸ Use promo code: {{Promo code}}\nDon't just watch football â€” profit from it."},
    {id:'e2',lang:'en',content:"Smart bettors don't chase luck â€” they use the right platform.\nMegapari gives you competitive odds, live betting, and instant withdrawals so you stay ahead of the game.\nğŸ‘‰ Join here: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° Promo code: {{Promo code}}\nBet smarter. Win faster."},
    {id:'e3',lang:'en',content:"ğŸš¨ TODAY'S GAMES = TODAY'S PROFITS\nIf you're watching football without betting on Megapari, you're missing money.\nSign up now and activate your bonus instantly.\nğŸ”— Register: {{Player link}}\nğŸ“² Download APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Promo code: {{Promo code}}\nDon't sit out the action."},
    {id:'e4',lang:'en',content:"Our winning community is growing daily âš½ğŸ’¬\nJoin thousands turning predictions into cash with Megapari.\nStart here: {{Player link}}\nAndroid app: {{apk link}}\niOS app: {{iOS link}}\nPromo code: {{Promo code}}\nYou watch the games anyway â€” you might as well get paid."},
    {id:'e5',lang:'en',content:"Trusted odds. Fast payouts. Real results.\nMegapari is built for serious football bettors.\nRegister: {{Player link}}\nAPK download: {{apk link}}\niOS download: {{iOS link}}\nUse code: {{Promo code}}\nPlay like a pro."},
    {id:'e6',lang:'en',content:"Weekend football hits different when you've got money on the line ğŸ˜âš½\nMake every goal count with Megapari.\nSign up: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nPromo code: {{Promo code}}\nFun to watch. Better to win."},
    {id:'e7',lang:'en',content:"ğŸ Bonus unlocked. All that's missing is you.\nCreate your Megapari account and activate your promo reward today.\nğŸ‘‰ Register: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nPromo code: {{Promo code}}\nClaim it. Bet it. Win it."},
    {id:'f1',lang:'fr',content:"âš½ğŸ”¥ L'Ã‰NERGIE DES GRANDS MATCHS COMMENCE ICI!\nTransformez chaque match en vrais gains avec Megapari.\nğŸ¯ Inscrivez-vous: {{Player link}}\nğŸ“² APK Android: {{apk link}}\nğŸ App iOS: {{iOS link}}\nğŸ Code promo: {{Promo code}}\nNe regardez plus le football â€” profitez-en."},
    {id:'f2',lang:'fr',content:"Les parieurs intelligents ne courent pas aprÃ¨s la chance â€” ils utilisent la bonne plateforme.\nğŸ‘‰ Rejoignez ici: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° Code promo: {{Promo code}}\nPariez plus intelligemment. Gagnez plus vite."},
    {id:'f3',lang:'fr',content:"ğŸš¨ LES MATCHS D'AUJOURD'HUI = LES PROFITS D'AUJOURD'HUI\nğŸ”— S'inscrire: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code promo: {{Promo code}}\nNe ratez pas l'action."},
    {id:'f4',lang:'fr',content:"Notre communautÃ© de gagnants grandit chaque jour âš½ğŸ’¬\nCommencez ici: {{Player link}}\nApp Android: {{apk link}}\nApp iOS: {{iOS link}}\nCode promo: {{Promo code}}\nVous regardez les matchs de toute faÃ§on â€” autant Ãªtre payÃ©."},
    {id:'f5',lang:'fr',content:"Des cotes fiables. Des paiements rapides. De vrais rÃ©sultats.\nS'inscrire: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}\nJouez comme un pro."},
    {id:'f6',lang:'fr',content:"Le football du week-end est diffÃ©rent quand vous avez de l'argent en jeu ğŸ˜âš½\nS'inscrire: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCode promo: {{Promo code}}\nAmusant Ã  regarder. Meilleur Ã  gagner."},
    {id:'f7',lang:'fr',content:"ğŸ Bonus dÃ©bloquÃ©. Il ne manque que vous.\nğŸ‘‰ S'inscrire: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCode promo: {{Promo code}}\nRÃ©clamez-le. Pariez dessus. Gagnez-le."},
    {id:'a1',lang:'ar',content:"âš½ğŸ”¥ Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ØªØ¨Ø¯Ø£ Ù‡Ù†Ø§!\nØ­ÙˆÙ‘Ù„ ÙƒÙ„ Ù…Ø¨Ø§Ø±Ø§Ø© Ø¥Ù„Ù‰ Ø£Ø±Ø¨Ø§Ø­ Ù…Ø¹ Megapari.\nğŸ¯ Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù†: {{Player link}}\nğŸ“² Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ ÙƒÙˆØ¯: {{Promo code}}\nÙ„Ø§ ØªÙƒØªÙÙ Ø¨Ù…Ø´Ø§Ù‡Ø¯Ø© ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù… â€” Ø§Ø³ØªÙØ¯ Ù…Ù†Ù‡Ø§."},
    {id:'a2',lang:'ar',content:"Ø§Ù„Ù…Ø±Ø§Ù‡Ù†ÙˆÙ† Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ ÙŠØ³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØµØ­ÙŠØ­Ø©.\nğŸ‘‰ Ø§Ù†Ø¶Ù…: {{Player link}}\nğŸ“¥ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° ÙƒÙˆØ¯: {{Promo code}}\nØ±Ø§Ù‡Ù† Ø¨Ø°ÙƒØ§Ø¡. Ø§ÙÙˆØ² Ø¨Ø³Ø±Ø¹Ø©."},
    {id:'a3',lang:'ar',content:"ğŸš¨ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ… = Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…!\nğŸ”— Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ ÙƒÙˆØ¯: {{Promo code}}\nÙ„Ø§ ØªØºØ¨ Ø¹Ù† Ø§Ù„Ø¥Ø«Ø§Ø±Ø©."},
    {id:'a4',lang:'ar',content:"Ù…Ø¬ØªÙ…Ø¹Ù†Ø§ Ø§Ù„ÙØ§Ø¦Ø² ÙŠØªÙ†Ø§Ù…Ù‰ ÙŠÙˆÙ…ÙŠÙ‹Ø§ âš½ğŸ’¬\nØ§Ø¨Ø¯Ø£ Ù‡Ù†Ø§: {{Player link}}\nØ£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\niOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}\nØ£Ù†Øª ØªØ´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª â€” ÙÙ„Ù…Ø§Ø°Ø§ Ù„Ø§ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ù„ØŸ"},
    {id:'a5',lang:'ar',content:"Ø£ÙˆØ¶Ø§Ø¹ Ù…ÙˆØ«ÙˆÙ‚Ø©. Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø³Ø±ÙŠØ¹Ø©. Ù†ØªØ§Ø¦Ø¬ Ø­Ù‚ÙŠÙ‚ÙŠØ©.\nØ§Ù„ØªØ³Ø¬ÙŠÙ„: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}\nØ§Ù„Ø¹Ø¨ ÙƒØ§Ù„Ù…Ø­ØªØ±ÙÙŠÙ†."},
    {id:'a6',lang:'ar',content:"ÙƒØ±Ø© Ù‚Ø¯Ù… Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø£ÙƒØ«Ø± Ø¥Ø«Ø§Ø±Ø© Ø¨Ø£Ù…ÙˆØ§Ù„Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ùƒ ğŸ˜âš½\nØ³Ø¬Ù‘Ù„: {{Player link}}\nØ£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\niOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}\nÙ…Ù…ØªØ¹. Ø£ÙØ¶Ù„ Ù„Ù„ÙÙˆØ²."},
    {id:'a7',lang:'ar',content:"ğŸ ØªÙ… ÙØªØ­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©. ÙƒÙ„ Ù…Ø§ ÙŠÙ†Ù‚Øµ Ù‡Ùˆ Ø£Ù†Øª.\nğŸ‘‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}\nØ§Ø·Ù„Ø¨Ù‡Ø§. Ø±Ø§Ù‡Ù† Ø¹Ù„ÙŠÙ‡Ø§. Ø§ÙÙˆØ² Ø¨Ù‡Ø§."},
    {id:'s1',lang:'es',content:"âš½ğŸ”¥ Â¡LA ENERGÃA DE LOS GRANDES PARTIDOS EMPIEZA AQUÃ!\nğŸ¯ RegÃ­strate: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}\nNo solo mires el fÃºtbol â€” gana con Ã©l."},
    {id:'s2',lang:'es',content:"Los apostadores inteligentes usan la plataforma correcta.\nğŸ‘‰ Ãšnete: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° CÃ³digo: {{Promo code}}\nApuesta mÃ¡s inteligente. Gana mÃ¡s rÃ¡pido."},
    {id:'s3',lang:'es',content:"ğŸš¨ LOS PARTIDOS DE HOY = LAS GANANCIAS DE HOY\nğŸ”— Registro: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}\nNo te quedes fuera de la acciÃ³n."},
    {id:'s4',lang:'es',content:"Nuestra comunidad ganadora crece cada dÃ­a âš½ğŸ’¬\nEmpieza aquÃ­: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}\nDe todas formas ves los partidos â€” Â¿por quÃ© no cobrar?"},
    {id:'s5',lang:'es',content:"Cuotas confiables. Pagos rÃ¡pidos. Resultados reales.\nRegÃ­strate: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}\nJuega como un profesional."},
    {id:'s6',lang:'es',content:"El fÃºtbol del fin de semana es mejor cuando tienes dinero en juego ğŸ˜âš½\nRegÃ­strate: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}\nDivertido de ver. Mejor ganarlo."},
    {id:'s7',lang:'es',content:"ğŸ Bono desbloqueado. Solo faltas tÃº.\nğŸ‘‰ RegÃ­strate: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCÃ³digo: {{Promo code}}\nReclÃ¡malo. Apuesta. Gana."},
    {id:'p1',lang:'pt',content:"âš½ğŸ”¥ A ENERGIA DOS GRANDES JOGOS COMEÃ‡A AQUI!\nğŸ¯ Registre-se: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}\nNÃ£o apenas assista ao futebol â€” lucre com ele."},
    {id:'p2',lang:'pt',content:"Apostadores inteligentes usam a plataforma certa.\nğŸ‘‰ Junte-se: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° CÃ³digo: {{Promo code}}\nAposte mais inteligente. Ganhe mais rÃ¡pido."},
    {id:'p3',lang:'pt',content:"ğŸš¨ OS JOGOS DE HOJE = OS LUCROS DE HOJE\nğŸ”— Registro: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}\nNÃ£o fique de fora da aÃ§Ã£o."},
    {id:'p4',lang:'pt',content:"Nossa comunidade vencedora cresce diariamente âš½ğŸ’¬\nComece aqui: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}\nVocÃª assiste aos jogos â€” por que nÃ£o ser pago?"},
    {id:'p5',lang:'pt',content:"Odds confiÃ¡veis. Pagamentos rÃ¡pidos. Resultados reais.\nRegistre-se: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}\nJogue como um profissional."},
    {id:'p6',lang:'pt',content:"O futebol do fim de semana Ã© diferente com dinheiro em jogo ğŸ˜âš½\nRegistre-se: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}\nDivertido de assistir. Melhor ganhar."},
    {id:'p7',lang:'pt',content:"ğŸ BÃ´nus desbloqueado. SÃ³ falta vocÃª.\nğŸ‘‰ Registro: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCÃ³digo: {{Promo code}}\nReivindique. Aposte. Ganhe."},
  ];
}
function ensureDefTxts(){
  const t = gd('texts',[]);
  if(!t||t.length===0) sd('texts',getDefTxts());
}
</script>
</body>
</html>
