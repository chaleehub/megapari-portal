<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€” Megapari Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&family=Anton&family=Black+Han+Sans&family=Teko:wght@600;700&family=Barlow+Condensed:wght@700;800;900&family=Russo+One&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
:root{
  --ac:#e53935;--ac2:#c62828;--dark:#0a0a0f;
  --card:#12121a;--card2:#1a1a26;--border:rgba(229,57,53,0.18);
  --text:#f0f0f8;--muted:#8888aa;--red:#ff5252;--amber:#ffab40;--blue:#5c9fd4;--blue2:#82b1ff;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{background:var(--dark);color:var(--text);font-family:'Outfit',sans-serif;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 70% 50% at 5% 10%,rgba(229,57,53,.06) 0%,transparent 55%),radial-gradient(ellipse 50% 40% at 95% 90%,rgba(92,159,212,.05) 0%,transparent 50%);pointer-events:none;z-index:0;}

.wrap{display:flex;min-height:100vh;position:relative;z-index:1;}
.sidebar{width:235px;background:var(--card);border-right:1px solid var(--border);padding:22px 0;flex-shrink:0;position:fixed;top:0;left:0;height:100vh;overflow-y:auto;z-index:20;}
.sidebar-logo{padding:0 20px 22px;border-bottom:1px solid var(--border);margin-bottom:10px;}
.logo-t{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:var(--ac);letter-spacing:2px;cursor:pointer;}
.logo-t span{color:var(--text);}
.logo-s{font-size:.6rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.nav{display:flex;align-items:center;gap:9px;padding:12px 20px;cursor:pointer;font-size:.86rem;font-weight:500;color:var(--muted);transition:all .15s;border-left:3px solid transparent;user-select:none;}
.nav:hover{color:var(--text);background:rgba(229,57,53,.05);}
.nav.on{color:var(--ac);border-left-color:var(--ac);background:rgba(229,57,53,.08);}
.nav-badge{background:var(--ac);color:#fff;font-size:.6rem;padding:1px 6px;border-radius:10px;margin-left:auto;font-weight:700;}
.nav-sep{height:1px;background:var(--border);margin:6px 0;}
.main{flex:1;margin-left:235px;padding:30px 34px;min-height:100vh;}
.page{display:none;}.page.on{display:block;}

.ph{margin-bottom:26px;padding-bottom:14px;border-bottom:1px solid var(--border);}
.ph h1{font-family:'Bebas Neue',sans-serif;font-size:2.1rem;letter-spacing:4px;}
.ph p{color:var(--muted);font-size:.83rem;margin-top:4px;}

.card{background:var(--card);border:1px solid var(--border);border-radius:13px;padding:22px;margin-bottom:20px;}
.card-title{font-size:.78rem;font-weight:700;color:var(--ac);text-transform:uppercase;letter-spacing:2px;margin-bottom:16px;display:flex;align-items:center;gap:8px;}

.row{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:13px;margin-bottom:13px;}
.fg{display:flex;flex-direction:column;gap:5px;}
label{font-size:.68rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600;}
input[type=text],input[type=date],input[type=number],input[type=password],select,textarea{
  background:#0d0d15;border:1px solid var(--border);border-radius:8px;color:var(--text);
  padding:10px 13px;font-family:'Outfit',sans-serif;font-size:.87rem;outline:none;
  transition:border-color .2s;width:100%;
}
input[type=color]{background:#0d0d15;border:1px solid var(--border);border-radius:8px;height:40px;padding:3px 7px;width:100%;cursor:pointer;}
input:focus,select:focus,textarea:focus{border-color:var(--ac);}
textarea{resize:vertical;min-height:100px;line-height:1.6;}

.btn{padding:9px 18px;border:none;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.82rem;font-weight:700;cursor:pointer;transition:all .18s;letter-spacing:.4px;display:inline-flex;align-items:center;gap:6px;}
.g{background:var(--ac);color:#fff;}.g:hover{background:var(--ac2);transform:translateY(-1px);}
.r{background:rgba(255,82,82,.12);color:var(--red);border:1px solid rgba(255,82,82,.25);}.r:hover{background:rgba(255,82,82,.2);}
.a{background:rgba(255,171,64,.12);color:var(--amber);border:1px solid rgba(255,171,64,.25);}.a:hover{background:rgba(255,171,64,.2);}
.o{background:transparent;color:var(--ac);border:1px solid rgba(229,57,53,.35);}.o:hover{background:rgba(229,57,53,.07);}
.b{background:rgba(92,159,212,.12);color:var(--blue2);border:1px solid rgba(92,159,212,.25);}.b:hover{background:rgba(92,159,212,.2);}
.sm{padding:4px 11px;font-size:.72rem;}
.br{display:flex;gap:9px;flex-wrap:wrap;align-items:center;margin-top:6px;}

.tw{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:.82rem;}
th{padding:9px 13px;background:var(--card2);color:var(--muted);text-align:left;font-weight:700;font-size:.66rem;text-transform:uppercase;letter-spacing:1.5px;}
td{padding:10px 13px;border-bottom:1px solid rgba(229,57,53,.06);vertical-align:middle;}
tr:last-child td{border-bottom:none;}tr:hover td{background:rgba(229,57,53,.02);}
.bx{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.67rem;font-weight:700;letter-spacing:.4px;}
.bx-r{background:rgba(229,57,53,.12);color:var(--ac);border:1px solid rgba(229,57,53,.25);}
.bx-a{background:rgba(255,171,64,.1);color:var(--amber);border:1px solid rgba(255,171,64,.2);}
.bx-b{background:rgba(92,159,212,.1);color:var(--blue2);border:1px solid rgba(92,159,212,.2);}

.dropzone{border:2px dashed rgba(229,57,53,.25);border-radius:10px;padding:24px;text-align:center;background:rgba(229,57,53,.02);transition:all .2s;cursor:pointer;}
.dropzone:hover,.dropzone.drag{border-color:var(--ac);background:rgba(229,57,53,.05);}
.dropzone .dz-icon{font-size:2.4rem;margin-bottom:8px;}
.dropzone p{color:var(--muted);font-size:.83rem;line-height:1.6;}
.dropzone strong{color:var(--ac);}

#banner-queue{display:flex;flex-direction:column;gap:14px;margin-top:16px;}
.bq-item{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:14px;}
.bq-top{display:flex;align-items:center;gap:12px;margin-bottom:8px;flex-wrap:wrap;}
.bq-thumb{width:80px;height:48px;object-fit:cover;border-radius:6px;border:1px solid var(--border);flex-shrink:0;}
.bq-name{font-size:.82rem;font-weight:600;color:var(--text);flex:1;min-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.bq-status{font-size:.7rem;padding:3px 8px;border-radius:4px;white-space:nowrap;}
.bq-status.pending{background:rgba(255,171,64,.12);color:var(--amber);}
.bq-status.done{background:rgba(92,159,212,.12);color:var(--blue2);}

/* â”€â”€ ZONE EDITOR â”€â”€ */
.ze-outer{width:100%;overflow:auto;max-height:70vh;border-radius:10px;background:#000;border:2px solid rgba(229,57,53,.4);margin-bottom:10px;cursor:crosshair;user-select:none;position:relative;}
.ze-inner{position:relative;display:inline-block;}
#ze-canvas{display:block;}
.drag-rect{position:absolute;border:3px solid #ff5252;background:rgba(229,57,53,.15);pointer-events:none;box-shadow:0 0 0 1px rgba(229,57,53,.4);display:none;}
.drag-label{position:absolute;top:-22px;left:0;background:var(--ac);color:#fff;font-size:.63rem;font-weight:700;padding:2px 7px;border-radius:3px;white-space:nowrap;}

/* â”€â”€ FONT PREVIEW â”€â”€ */
.font-prev-box{background:#0d0d15;border:1px solid var(--border);border-radius:8px;margin-top:8px;min-height:64px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.font-prev-box canvas{display:block;max-width:100%;height:auto;}

/* â”€â”€ GRADIENT ROW â”€â”€ */
.grad-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.grad-check-label{display:flex;align-items:center;gap:6px;font-size:.78rem;color:var(--muted);cursor:pointer;user-select:none;}
.grad-check-label input[type=checkbox]{accent-color:var(--ac);width:15px;height:15px;}

.ib{background:rgba(229,57,53,.04);border:1px solid rgba(229,57,53,.18);border-radius:8px;padding:11px 15px;font-size:.81rem;color:var(--muted);margin-bottom:13px;line-height:1.7;}
.ib strong{color:var(--ac);}
.ib.blue{background:rgba(92,159,212,.05);border-color:rgba(92,159,212,.2);}
.ib.blue strong{color:var(--blue2);}

.ip{background:#0d0d15;border:1px solid var(--border);border-radius:8px;padding:13px;margin-top:13px;max-height:210px;overflow-y:auto;}
.ip table{font-size:.77rem;}
.ip th{background:#141420;padding:6px 10px;}
.ip td{padding:6px 10px;}

.tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:15px;}
.tab{padding:5px 13px;border-radius:20px;font-size:.74rem;font-weight:600;cursor:pointer;border:1px solid var(--border);color:var(--muted);transition:all .14s;background:transparent;font-family:'Outfit',sans-serif;}
.tab:hover{border-color:var(--ac);color:var(--ac);}
.tab.on{background:var(--ac);color:#fff;border-color:var(--ac);}

.tc{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:15px;margin-bottom:11px;transition:border-color .2s;}
.tc:hover{border-color:rgba(229,57,53,.3);}
.tc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px;gap:10px;flex-wrap:wrap;}
.tc pre{white-space:pre-wrap;font-family:'Outfit',sans-serif;font-size:.8rem;color:var(--text);line-height:1.65;max-height:90px;overflow:hidden;position:relative;}
.tc pre::after{content:'';position:absolute;bottom:0;left:0;right:0;height:22px;background:linear-gradient(transparent,var(--card2));}

/* â”€â”€ PENDING REGISTRATIONS â”€â”€ */
.reg-card{background:var(--card2);border:1px solid rgba(255,171,64,.3);border-radius:10px;padding:15px;margin-bottom:11px;}
.reg-card .reg-info{font-size:.82rem;margin-bottom:10px;line-height:1.8;}
.reg-card .reg-info strong{color:var(--ac);}

#login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--dark);z-index:999;}
.lc{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:42px;width:100%;max-width:390px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.7);}
.ll{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;letter-spacing:3px;}
.ll span{color:var(--ac);}
.ls{font-size:.82rem;color:var(--muted);margin-bottom:30px;letter-spacing:1px;}
.le{color:var(--red);font-size:.79rem;margin-bottom:10px;padding:8px 12px;background:rgba(255,82,82,.1);border-radius:6px;display:none;}

#toast{position:fixed;bottom:26px;right:26px;z-index:9999;padding:10px 20px;border-radius:30px;font-weight:700;font-size:.83rem;opacity:0;transform:translateY(12px);transition:all .28s;pointer-events:none;}
#toast.on{opacity:1;transform:translateY(0);}

.prog-bar{width:100%;background:var(--card2);border-radius:4px;height:6px;margin-top:8px;overflow:hidden;}
.prog-fill{height:100%;background:var(--ac);transition:width .3s;border-radius:4px;}

.cd-warn{font-size:.7rem;color:var(--amber);font-weight:700;margin-top:3px;}

@media(max-width:700px){.sidebar{width:200px;}.main{margin-left:200px;padding:18px;}}
@media(max-width:560px){.wrap{flex-direction:column;}.sidebar{position:relative;width:100%;height:auto;}.main{margin-left:0;}}
</style>
</head>
<body>

<div id="login-screen">
  <div class="lc">
    <div class="ll"><span>MEGA</span>PARI</div>
    <div class="ls">Admin Panel â€” Authorised Access Only</div>
    <div class="fg" style="text-align:left;margin-bottom:13px">
      <label>Password</label>
      <input type="password" id="pw-in" placeholder="Enter admin password" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <div class="le" id="pw-err">âŒ Incorrect password. Try again.</div>
    <button class="btn g" style="width:100%;justify-content:center;padding:12px" onclick="doLogin()">ENTER â†’</button>
    <p style="margin-top:14px;font-size:.7rem;color:var(--muted)">Default: <strong style="color:var(--text)">admin123</strong></p>
  </div>
</div>

<div class="wrap" id="panel" style="display:none">
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-t" onclick="window.open('index.html','_blank')">MEGA<span>PARI</span></div>
      <div class="logo-s">Admin Panel</div>
    </div>
    <div class="nav on" onclick="go('affiliates',this)">ğŸ‘¥ Affiliates</div>
    <div class="nav" onclick="go('banners',this)">ğŸ–¼ï¸ Banners</div>
    <div class="nav" onclick="go('texts',this)">âœï¸ Post Captions</div>
    <div class="nav" onclick="go('download',this)">ğŸ“¥ Bulk Download</div>
    <div class="nav" id="nav-regs" onclick="go('registrations',this)">ğŸ“‹ Registrations <span class="nav-badge" id="reg-badge" style="display:none">0</span></div>
    <div class="nav-sep"></div>
    <div class="nav" onclick="go('settings',this)">âš™ï¸ Settings</div>
    <div class="nav" onclick="window.open('index.html','_blank')">ğŸ”— View Portal</div>
    <div class="nav" onclick="doLogout()">ğŸšª Logout</div>
  </nav>

  <main class="main">

    <!-- â•â•â• AFFILIATES â•â•â• -->
    <div class="page on" id="page-affiliates">
      <div class="ph"><h1>ğŸ‘¥ AFFILIATES</h1><p>Add, edit, or bulk-import affiliates</p></div>
      <div class="card">
        <div class="card-title">â• <span id="aff-form-title">Add Affiliate</span></div>
        <input type="hidden" id="aff-orig-id">
        <div class="row">
          <div class="fg"><label>Affiliate ID *</label><input type="text" id="a-id" placeholder="AFF12345"/></div>
          <div class="fg"><label>Display Name</label><input type="text" id="a-name" placeholder="John Doe"/></div>
          <div class="fg"><label>Promo Code *</label><input type="text" id="a-promo" placeholder="JOHN50"/></div>
        </div>
        <div class="row">
          <div class="fg"><label>Player / Referral Link</label><input type="text" id="a-player" placeholder="https://..."/></div>
          <div class="fg"><label>Android APK Link</label><input type="text" id="a-apk" placeholder="https://..."/></div>
          <div class="fg"><label>iOS App Link</label><input type="text" id="a-ios" placeholder="https://..."/></div>
        </div>
        <div class="row">
          <div class="fg"><label>Preferred Language</label>
            <select id="a-lang"><option value="en">English</option><option value="fr">French</option><option value="ar">Arabic</option><option value="es">Spanish</option><option value="pt">Portuguese</option></select>
          </div>
        </div>
        <div class="br"><button class="btn g" onclick="saveAff()">ğŸ’¾ Save Affiliate</button><button class="btn o" onclick="clearAff()">âœ• Clear</button></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“Š Bulk Import from Excel</div>
        <div class="ib">Columns: <strong>A</strong>=ID Â· <strong>B</strong>=Name Â· <strong>C</strong>=Promo Code Â· <strong>D</strong>=Player Link Â· <strong>E</strong>=APK Â· <strong>F</strong>=iOS Â· <strong>G</strong>=Lang</div>
        <div class="dropzone" onclick="document.getElementById('xl-in').click()"><div class="dz-icon">ğŸ“‚</div><p><strong>Click to choose Excel file</strong><br>.xlsx or .xls</p></div>
        <input type="file" id="xl-in" accept=".xlsx,.xls" style="display:none" onchange="xlImport()"/>
        <div id="xl-prev" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:14px;flex-wrap:wrap;gap:9px">
            <span id="xl-count" style="color:var(--ac);font-weight:700;font-size:.87rem"></span>
            <div class="br"><button class="btn g sm" onclick="xlConfirm()">âœ… Import</button><button class="btn r sm" onclick="xlCancel()">âœ•</button></div>
          </div>
          <div class="ip" id="xl-table"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ All Affiliates (<span id="aff-cnt">0</span>)</div>
        <div class="tw"><table><thead><tr><th>ID</th><th>Name</th><th>Promo</th><th>Lang</th><th>Link</th><th>Shareable Link</th><th>Actions</th></tr></thead><tbody id="aff-tbody"></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• BANNERS â•â•â• -->
    <div class="page" id="page-banners">
      <div class="ph"><h1>ğŸ–¼ï¸ BANNERS</h1><p>Upload multiple banners â€” set promo code zone on each</p></div>
      <div class="card">
        <div class="card-title">âš™ï¸ Batch Settings</div>
        <div class="row">
          <div class="fg"><label>Language *</label>
            <select id="ban-lang"><option value="en">English</option><option value="fr">French</option><option value="ar">Arabic</option><option value="es">Spanish</option><option value="pt">Portuguese</option></select>
          </div>
          <div class="fg"><label>Banner Type *</label>
            <select id="ban-type" onchange="toggleDates()"><option value="dated">ğŸ“… Dated (has expiry)</option><option value="evergreen">â™¾ï¸ Evergreen</option></select>
          </div>
          <div class="fg" id="sg-start"><label>Start Date</label><input type="date" id="ban-start"/></div>
          <div class="fg" id="sg-end"><label>End Date</label><input type="date" id="ban-end"/></div>
        </div>
        <div class="ib" style="margin-bottom:0">ğŸ“Œ Dated banners auto-remove <strong>35 hours</strong> after the end date. Users see a live countdown.</div>
      </div>
      <div class="card">
        <div class="card-title">â¬†ï¸ Upload Images</div>
        <div class="dropzone" id="banner-dz" onclick="document.getElementById('ban-files').click()" ondragover="dzDrag(event,true)" ondragleave="dzDrag(event,false)" ondrop="dzDrop(event)">
          <div class="dz-icon">ğŸ–¼ï¸</div><p><strong>Click or drag & drop</strong><br>PNG / JPG â€” select multiple at once</p>
        </div>
        <input type="file" id="ban-files" accept="image/*" multiple style="display:none" onchange="addBanners()"/>
        <div id="banner-queue"></div>
        <div class="br" style="margin-top:14px;display:none" id="save-all-row">
          <button class="btn g" onclick="saveAllBanners()">ğŸ’¾ Save All to Portal</button>
          <button class="btn r" onclick="clearQueue()">ğŸ—‘ï¸ Clear Queue</button>
          <span id="save-prog" style="font-size:.8rem;color:var(--muted)"></span>
        </div>
      </div>

      <!-- Zone editor -->
      <div id="zone-editor" style="display:none">
        <div class="card" style="border-color:rgba(229,57,53,.5)">
          <div class="card-title" style="margin-bottom:8px">ğŸ¯ Set Promo Zone â€” <span id="ze-banner-name" style="color:var(--text);text-transform:none;letter-spacing:0;font-weight:400"></span></div>
          <div class="ib" style="margin-bottom:10px"><strong>Drag a rectangle</strong> on the image to mark the promo code area. Text will auto-fit to fill the zone perfectly.</div>
          <div class="ze-outer" id="ze-outer">
            <div class="ze-inner" id="ze-inner">
              <canvas id="ze-canvas"></canvas>
              <div class="drag-rect" id="drag-rect"><div class="drag-label">PROMO CODE ZONE</div></div>
            </div>
          </div>
          <div id="ze-controls" style="display:none">
            <div class="row" style="margin-top:12px">
              <div class="fg">
                <label>Font Family</label>
                <select id="ze-font" onchange="updateFontPreview()">
                  <option value="Bebas Neue">Bebas Neue</option>
                  <option value="Anton">Anton</option>
                  <option value="Russo One">Russo One</option>
                  <option value="Teko">Teko Bold</option>
                  <option value="Barlow Condensed">Barlow Condensed</option>
                  <option value="Black Han Sans">Black Han Sans</option>
                  <option value="Arial Black">Arial Black</option>
                  <option value="Impact">Impact</option>
                </select>
              </div>
              <div class="fg">
                <label>Font Size (px) <span style="color:var(--blue2);font-size:.6rem">â€” or enable Auto-fit</span></label>
                <input type="number" id="ze-size" value="36" min="6" max="400" onchange="updateFontPreview()"/>
              </div>
              <div class="fg">
                <label>Text Align</label>
                <select id="ze-align" onchange="updateFontPreview()"><option value="center">Center</option><option value="left">Left</option><option value="right">Right</option></select>
              </div>
            </div>
            <!-- Auto-fit toggle -->
            <div style="margin-bottom:13px">
              <label class="grad-check-label">
                <input type="checkbox" id="ze-autofit" checked onchange="updateFontPreview()"/>
                <strong style="color:var(--blue2)">Auto-fit text to zone</strong> â€” resizes font so text fills the marked area perfectly
              </label>
            </div>
            <!-- Color / Gradient -->
            <div class="row" style="margin-bottom:6px">
              <div class="fg">
                <label>Text Color</label>
                <input type="color" id="ze-color" value="#ffffff" onchange="updateFontPreview()"/>
              </div>
              <div class="fg">
                <label>Gradient? <span style="font-size:.6rem;color:var(--muted)">Enable for gradient text</span></label>
                <div class="grad-row" style="margin-top:6px">
                  <label class="grad-check-label">
                    <input type="checkbox" id="ze-gradient" onchange="toggleGradientUI()"/>
                    Enable Gradient
                  </label>
                </div>
              </div>
              <div class="fg" id="grad-color2-row" style="display:none">
                <label>Gradient End Color</label>
                <input type="color" id="ze-color2" value="#ff9800" onchange="updateFontPreview()"/>
              </div>
              <div class="fg" id="grad-dir-row" style="display:none">
                <label>Gradient Direction</label>
                <select id="ze-grad-dir" onchange="updateFontPreview()">
                  <option value="lr">Left â†’ Right</option>
                  <option value="tb">Top â†’ Bottom</option>
                  <option value="diag">Diagonal</option>
                </select>
              </div>
            </div>
            <!-- Live preview â€” canvas-rendered so it exactly matches what will appear on banner -->
            <div class="font-prev-box" id="font-preview-wrap">
              <canvas id="font-preview" width="400" height="70"></canvas>
            </div>
            <div class="fg" style="margin-top:10px;margin-bottom:12px">
              <label>Zone Info (set by drag)</label>
              <input type="text" id="ze-info" readonly style="cursor:default;font-size:.76rem;color:var(--muted)"/>
            </div>
          </div>
          <div class="br">
            <button class="btn g" onclick="confirmZone()">âœ… Confirm Zone</button>
            <button class="btn o" onclick="clearZoneRect()">â†©ï¸ Redo</button>
            <button class="btn r sm" onclick="closeZoneEditor()">âœ• Close</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“‹ Saved Banners (<span id="ban-cnt">0</span>)</div>
        <div class="tw"><table><thead><tr><th>Preview</th><th>Type</th><th>Lang</th><th>Dates / Expiry</th><th>Zone</th><th>Assigned Caption</th><th>Actions</th></tr></thead><tbody id="ban-tbody"></tbody></table></div>
      </div>
    </div>

    <!-- â•â•â• TEXTS â•â•â• -->
    <div class="page" id="page-texts">
      <div class="ph"><h1>âœï¸ POST CAPTIONS</h1><p>Manage caption templates for all 5 languages</p></div>
      <div class="card">
        <div class="card-title"><span id="txt-icon">â•</span> <span id="txt-title">Add Caption</span></div>
        <input type="hidden" id="txt-edit-id">
        <div class="ib">Placeholders: <strong>{{Player link}}</strong> Â· <strong>{{apk link}}</strong> Â· <strong>{{iOS link}}</strong> Â· <strong>{{Promo code}}</strong></div>
        <div class="row"><div class="fg"><label>Language *</label>
          <select id="txt-lang"><option value="en">English</option><option value="fr">French</option><option value="ar">Arabic</option><option value="es">Spanish</option><option value="pt">Portuguese</option></select>
        </div></div>
        <div class="fg" style="margin-bottom:14px"><label>Caption Text</label><textarea id="txt-body" rows="8"></textarea></div>
        <div class="br">
          <button class="btn g" onclick="saveTxt()">ğŸ’¾ Save</button>
          <button class="btn o" onclick="clearTxt()">âœ• Clear</button>
          <span id="txt-edit-note" style="display:none;font-size:.77rem;color:var(--amber)">âœï¸ Editing</span>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ All Captions (<span id="txt-cnt">0</span>)</div>
        <div class="tabs">
          <button class="tab on" onclick="filterTxt('all',this)">All</button>
          <button class="tab" onclick="filterTxt('en',this)">ğŸ‡¬ğŸ‡§ EN</button>
          <button class="tab" onclick="filterTxt('fr',this)">ğŸ‡«ğŸ‡· FR</button>
          <button class="tab" onclick="filterTxt('ar',this)">ğŸ‡¸ğŸ‡¦ AR</button>
          <button class="tab" onclick="filterTxt('es',this)">ğŸ‡ªğŸ‡¸ ES</button>
          <button class="tab" onclick="filterTxt('pt',this)">ğŸ‡§ğŸ‡· PT</button>
        </div>
        <div id="txt-list"></div>
      </div>
    </div>

    <!-- â•â•â• BULK DOWNLOAD â•â•â• -->
    <div class="page" id="page-download">
      <div class="ph"><h1>ğŸ“¥ BULK DOWNLOAD</h1><p>Download all affiliates' banners with promo codes stamped</p></div>
      <div class="card">
        <div class="card-title">âš™ï¸ Filters</div>
        <div class="ib blue">Banners match affiliates by <strong>language</strong>. Files named: <strong>PROMOCODE_STARTDATE_to_ENDDATE.png</strong></div>
        <div class="row">
          <div class="fg"><label>Language</label>
            <select id="dl-lang" onchange="populateDlAffs()"><option value="all">All</option><option value="en">English</option><option value="fr">French</option><option value="ar">Arabic</option><option value="es">Spanish</option><option value="pt">Portuguese</option></select>
          </div>
          <div class="fg"><label>Banner Type</label>
            <select id="dl-type"><option value="all">All</option><option value="dated">Dated</option><option value="evergreen">Evergreen</option></select>
          </div>
          <div class="fg"><label>Affiliate</label>
            <select id="dl-aff"><option value="all">All</option></select>
          </div>
          <div class="fg"><label>ZIP Structure</label>
            <select id="dl-structure"><option value="flat">One ZIP</option><option value="perAff">Per affiliate</option></select>
          </div>
        </div>
        <div class="br">
          <button class="btn g" onclick="startBulkDownload()">ğŸ“¦ Generate & Download</button>
          <button class="btn b" onclick="previewDownload()">ğŸ‘ Preview List</button>
        </div>
        <div id="dl-progress" style="display:none;margin-top:14px">
          <div style="font-size:.82rem;color:var(--muted);margin-bottom:6px" id="dl-prog-text">Preparingâ€¦</div>
          <div class="prog-bar"><div class="prog-fill" id="dl-prog-fill" style="width:0"></div></div>
        </div>
        <div id="dl-preview-list" style="margin-top:14px;display:none"></div>
      </div>
    </div>

    <!-- â•â•â• REGISTRATIONS â•â•â• -->
    <div class="page" id="page-registrations">
      <div class="ph"><h1>ğŸ“‹ SELF-REGISTRATIONS</h1><p>Affiliates who registered themselves on the portal â€” approve to activate</p></div>
      <div class="card">
        <div class="card-title">â³ Pending Approvals (<span id="pending-cnt">0</span>)</div>
        <div id="pending-list"><div style="color:var(--muted);text-align:center;padding:24px">No pending registrations</div></div>
      </div>
      <div class="card">
        <div class="card-title">âœ… Approved Registrations (<span id="approved-cnt">0</span>)</div>
        <div id="approved-list"></div>
      </div>
    </div>

    <!-- â•â•â• SETTINGS â•â•â• -->
    <div class="page" id="page-settings">
      <div class="ph"><h1>âš™ï¸ SETTINGS</h1></div>
      <div class="card">
        <div class="card-title">ğŸ” Change Password</div>
        <div class="row">
          <div class="fg"><label>Current</label><input type="password" id="cur-pw"/></div>
          <div class="fg"><label>New (min 4)</label><input type="password" id="new-pw"/></div>
          <div class="fg"><label>Confirm</label><input type="password" id="conf-pw"/></div>
        </div>
        <button class="btn g" onclick="changePw()">ğŸ”’ Update Password</button>
      </div>
      <div class="card">
        <div class="card-title">ğŸ’¾ Data Backup</div>
        <div class="br">
          <button class="btn g" onclick="exportData()">ğŸ“¤ Export JSON</button>
          <button class="btn a" onclick="document.getElementById('imp-in').click()">ğŸ“¥ Import JSON</button>
          <button class="btn r" onclick="clearAll()">ğŸ—‘ï¸ Clear All</button>
        </div>
        <input type="file" id="imp-in" accept=".json" style="display:none" onchange="importData()"/>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“Š Stats</div>
        <div id="stats-area" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px;margin-top:4px"></div>
      </div>
    </div>

  </main>
</div>
<div id="toast"></div>

<script>
// â•â•â• INDEXED DB â•â•â•
const IDB_NAME='megapari_v2',IDB_VER=1,IDB_STORE='banner_images';
let _db=null;
function openDB(){return new Promise((res,rej)=>{if(_db){res(_db);return;}const req=indexedDB.open(IDB_NAME,IDB_VER);req.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains(IDB_STORE))d.createObjectStore(IDB_STORE);};req.onsuccess=e=>{_db=e.target.result;res(_db);};req.onerror=e=>rej(e.target.error);});}
async function idbPut(key,val){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(IDB_STORE,'readwrite');tx.objectStore(IDB_STORE).put(val,key);tx.oncomplete=()=>res();tx.onerror=e=>rej(e.target.error);});}
async function idbGet(key){const db=await openDB();return new Promise((res,rej)=>{const req=db.transaction(IDB_STORE,'readonly').objectStore(IDB_STORE).get(key);req.onsuccess=()=>res(req.result);req.onerror=e=>rej(e.target.error);});}
async function idbDel(key){const db=await openDB();return new Promise((res,rej)=>{const tx=db.transaction(IDB_STORE,'readwrite');tx.objectStore(IDB_STORE).delete(key);tx.oncomplete=()=>res();tx.onerror=e=>rej(e.target.error);});}

// â•â•â• LOCALSTORAGE â•â•â•
function gd(k,d){try{const v=JSON.parse(localStorage.getItem(k));return v!==null?v:d;}catch(e){return d;}}
function sd(k,v){localStorage.setItem(k,JSON.stringify(v));}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8);}
const LS={en:'English',fr:'French',ar:'Arabic',es:'Spanish',pt:'Portuguese'};

// â•â•â• LOGIN â•â•â•
function doLogin(){
  const pw=document.getElementById('pw-in').value;
  const stored=localStorage.getItem('adminPw')||'admin123';
  if(pw===stored){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('panel').style.display='flex';
    ensureDefTxts();renderAffs();renderBanners();renderTxts();renderRegs();updateRegBadge();
  } else {
    const el=document.getElementById('pw-err');el.style.display='block';
    setTimeout(()=>el.style.display='none',3000);
  }
}
document.getElementById('pw-in').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
function doLogout(){document.getElementById('login-screen').style.display='flex';document.getElementById('panel').style.display='none';document.getElementById('pw-in').value='';}

// â•â•â• NAVIGATION â•â•â•
function go(p,el){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.nav').forEach(x=>x.classList.remove('on'));
  document.getElementById('page-'+p).classList.add('on');
  if(el)el.classList.add('on');
  if(p==='settings')renderStats();
  if(p==='texts'){txtFilter='all';renderTxts();}
  if(p==='banners')renderBanners();
  if(p==='download')populateDlAffs();
  if(p==='registrations')renderRegs();
}

// â•â•â• AFFILIATES â•â•â•
function saveAff(){
  const origId=document.getElementById('aff-orig-id').value;
  const id=document.getElementById('a-id').value.trim();
  const promo=document.getElementById('a-promo').value.trim();
  if(!id||!promo){toast('ID and Promo Code required','err');return;}
  let affs=gd('affiliates',[]);
  const obj={id,name:document.getElementById('a-name').value.trim(),promoCode:promo,
    playerLink:document.getElementById('a-player').value.trim(),
    apkLink:document.getElementById('a-apk').value.trim(),
    iosLink:document.getElementById('a-ios').value.trim(),
    lang:document.getElementById('a-lang').value};
  if(origId){affs=affs.map(a=>a.id===origId?obj:a);}
  else{if(affs.find(a=>a.id.toLowerCase()===id.toLowerCase())){toast('ID already exists','err');return;}affs.push(obj);}
  sd('affiliates',affs);clearAff();renderAffs();toast('âœ… Saved!');
}
function clearAff(){['a-id','a-name','a-promo','a-player','a-apk','a-ios'].forEach(f=>document.getElementById(f).value='');document.getElementById('aff-orig-id').value='';document.getElementById('aff-form-title').textContent='Add Affiliate';}
function editAff(id){
  const a=gd('affiliates',[]).find(x=>x.id===id);if(!a)return;
  document.getElementById('aff-orig-id').value=a.id;
  document.getElementById('a-id').value=a.id;
  document.getElementById('a-name').value=a.name||'';
  document.getElementById('a-promo').value=a.promoCode||'';
  document.getElementById('a-player').value=a.playerLink||'';
  document.getElementById('a-apk').value=a.apkLink||'';
  document.getElementById('a-ios').value=a.iosLink||'';
  document.getElementById('a-lang').value=a.lang||'en';
  document.getElementById('aff-form-title').textContent='Edit: '+id;
  window.scrollTo({top:0,behavior:'smooth'});
}
function delAff(id){if(!confirm('Delete "'+id+'"?'))return;sd('affiliates',gd('affiliates',[]).filter(a=>a.id!==id));renderAffs();toast('Deleted');}

function getShareLink(affId){
  const base=window.location.href.replace('admin.html','index.html');
  return base+'?aff='+encodeURIComponent(affId);
}

function renderAffs(){
  const affs=gd('affiliates',[]);
  document.getElementById('aff-cnt').textContent=affs.length;
  const tb=document.getElementById('aff-tbody');
  if(!affs.length){tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">No affiliates yet</td></tr>';return;}
  tb.innerHTML=affs.map(a=>{
    const link=getShareLink(a.id);
    return`<tr>
      <td><strong style="color:var(--ac)">${eh(a.id)}</strong></td>
      <td>${eh(a.name||'â€”')}</td>
      <td><span class="bx bx-r">${eh(a.promoCode)}</span></td>
      <td><span class="bx bx-b">${LS[a.lang]||a.lang}</span></td>
      <td style="font-size:.74rem">${a.playerLink?`<a href="${eh(a.playerLink)}" target="_blank" style="color:var(--muted)">â†—</a>`:'â€”'}</td>
      <td>
        <div style="display:flex;align-items:center;gap:6px">
          <input type="text" value="${eh(link)}" readonly style="font-size:.68rem;padding:4px 8px;width:160px;color:var(--muted)" onclick="this.select()"/>
          <button class="btn b sm" onclick="copyShareLink('${ea(link)}')">ğŸ“‹ Copy</button>
        </div>
      </td>
      <td><div class="br"><button class="btn a sm" onclick="editAff('${ea(a.id)}')">âœï¸</button><button class="btn r sm" onclick="delAff('${ea(a.id)}')">ğŸ—‘ï¸</button></div></td>
    </tr>`;
  }).join('');
}
function copyShareLink(link){
  navigator.clipboard.writeText(link).then(()=>toast('ğŸ“‹ Link copied!'));
}

// Excel
let xlRows=[];
function xlImport(){
  const file=document.getElementById('xl-in').files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const wb=XLSX.read(e.target.result,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      const isHdr=r=>r[0]&&String(r[0]).toLowerCase().match(/id|affiliate|name/);
      const data=rows.filter((r,i)=>!(i===0&&isHdr(r))).filter(r=>String(r[0]||'').trim());
      xlRows=data.map(r=>({id:String(r[0]||'').trim(),name:String(r[1]||'').trim(),promoCode:String(r[2]||'').trim(),playerLink:String(r[3]||'').trim(),apkLink:String(r[4]||'').trim(),iosLink:String(r[5]||'').trim(),lang:String(r[6]||'en').trim().toLowerCase()||'en'})).filter(r=>r.id&&r.promoCode);
      if(!xlRows.length){toast('No valid rows','err');return;}
      document.getElementById('xl-count').textContent=`âœ… ${xlRows.length} ready`;
      const prev=xlRows.slice(0,15).map(r=>`<tr><td>${eh(r.id)}</td><td>${eh(r.name||'â€”')}</td><td>${eh(r.promoCode)}</td><td>${eh(r.lang)}</td></tr>`).join('');
      document.getElementById('xl-table').innerHTML=`<table><thead><tr><th>ID</th><th>Name</th><th>Promo</th><th>Lang</th></tr></thead><tbody>${prev}</tbody></table>`;
      document.getElementById('xl-prev').style.display='block';
    }catch(err){toast('Error: '+err.message,'err');}
  };
  reader.readAsArrayBuffer(file);
}
function xlConfirm(){let affs=gd('affiliates',[]);let added=0,upd=0;xlRows.forEach(r=>{const i=affs.findIndex(a=>a.id.toLowerCase()===r.id.toLowerCase());if(i>=0){affs[i]=r;upd++;}else{affs.push(r);added++;}});sd('affiliates',affs);xlCancel();renderAffs();toast(`âœ… ${added} added, ${upd} updated`);}
function xlCancel(){xlRows=[];document.getElementById('xl-in').value='';document.getElementById('xl-prev').style.display='none';}

// â•â•â• BANNERS â•â•â•
let queue=[];
let activeQIdx=null;
let zeState={isDragging:false,start:{x:0,y:0},zone:null};
let zeScale=1;
let _zeL={};

function dzDrag(e,on){e.preventDefault();document.getElementById('banner-dz').classList.toggle('drag',on);}
function dzDrop(e){e.preventDefault();document.getElementById('banner-dz').classList.remove('drag');handleFiles(e.dataTransfer.files);}
function addBanners(){handleFiles(document.getElementById('ban-files').files);}

function handleFiles(files){
  if(!files||!files.length)return;
  Array.from(files).forEach(f=>{
    if(!f.type.startsWith('image/'))return;
    const id=uid();
    const entry={id,name:f.name,dataURL:null,zone:null,status:'pending'};
    queue.push(entry);
    const reader=new FileReader();
    reader.onload=ev=>{entry.dataURL=ev.target.result;renderQueue();};
    reader.readAsDataURL(f);
  });
  renderQueue();
}

function renderQueue(){
  const qEl=document.getElementById('banner-queue');
  const saveRow=document.getElementById('save-all-row');
  if(!queue.length){qEl.innerHTML='';saveRow.style.display='none';return;}
  saveRow.style.display='flex';
  qEl.innerHTML=queue.map((item,i)=>`
    <div class="bq-item">
      <div class="bq-top">
        ${item.dataURL?`<img class="bq-thumb" src="${item.dataURL}"/>`:'<div class="bq-thumb" style="background:var(--card);display:flex;align-items:center;justify-content:center;font-size:.7rem;color:var(--muted)">â€¦</div>'}
        <span class="bq-name">${eh(item.name)}</span>
        <span class="bq-status ${item.status}">${item.status==='pending'?'â³ Pending':'âœ… Zone Set'}</span>
        <div class="br" style="margin:0">
          ${item.dataURL?`<button class="btn ${item.zone?'a':'g'} sm" onclick="openZoneEditor(${i})">${item.zone?'âœï¸ Edit Zone':'ğŸ¯ Set Zone'}</button>`:''}
          <button class="btn r sm" onclick="removeFromQueue(${i})">âœ•</button>
        </div>
      </div>
      ${item.zone?`<div style="font-size:.72rem;color:var(--blue2);padding:2px 0">âœ… Zone: ${item.zone.x},${item.zone.y} ${item.zone.w}Ã—${item.zone.h}px Â· ${item.zone.font} Â· ${item.zone.autofit?'Auto-fit':'Size '+item.zone.size+'px'} Â· ${item.zone.gradient?'Gradient':'Solid'}</div>`:'<div style="font-size:.72rem;color:var(--amber);padding:2px 0">âš ï¸ No zone â€” saved without promo overlay</div>'}
    </div>`).join('');
}
function removeFromQueue(i){queue.splice(i,1);renderQueue();}
function clearQueue(){queue=[];renderQueue();closeZoneEditor();}

// â”€â”€ ZONE EDITOR â”€â”€
function openZoneEditor(i){
  activeQIdx=i;
  const item=queue[i];
  if(!item.dataURL){toast('Image loadingâ€¦','err');return;}
  const edEl=document.getElementById('zone-editor');
  edEl.style.display='block';
  setTimeout(()=>edEl.scrollIntoView({behavior:'smooth',block:'start'}),50);
  document.getElementById('ze-banner-name').textContent=item.name;
  document.getElementById('ze-controls').style.display='none';
  document.getElementById('drag-rect').style.display='none';
  zeState={isDragging:false,start:{x:0,y:0},zone:null};
  drawZECanvas(item);
  if(item.zone){
    document.getElementById('ze-font').value=item.zone.font||'Bebas Neue';
    document.getElementById('ze-size').value=item.zone.size||36;
    document.getElementById('ze-color').value=item.zone.color||'#ffffff';
    document.getElementById('ze-align').value=item.zone.align||'center';
    document.getElementById('ze-autofit').checked=item.zone.autofit!==false;
    document.getElementById('ze-gradient').checked=!!item.zone.gradient;
    if(item.zone.gradient){
      document.getElementById('ze-color2').value=item.zone.color2||'#ff9800';
      document.getElementById('ze-grad-dir').value=item.zone.gradDir||'lr';
      toggleGradientUI();
    }
    showZoneRect(item.zone);
    document.getElementById('ze-controls').style.display='block';
    updateFontPreview();
  }
}

function drawZECanvas(item){
  const img=new Image();
  img.onload=function(){
    const outer=document.getElementById('ze-outer');
    const inner=document.getElementById('ze-inner');
    const canvas=document.getElementById('ze-canvas');
    const availW=outer.clientWidth||Math.min(window.innerWidth-280,900);
    zeScale=Math.min(1,availW/img.width);
    const dW=Math.round(img.width*zeScale);
    const dH=Math.round(img.height*zeScale);
    canvas.width=img.width;canvas.height=img.height;
    canvas.style.width=dW+'px';canvas.style.height=dH+'px';canvas.style.display='block';
    inner.style.width=dW+'px';inner.style.height=dH+'px';
    canvas.getContext('2d').drawImage(img,0,0);
    attachZEDrag(canvas,inner);
  };
  img.src=item.dataURL;
}

function attachZEDrag(canvas,inner){
  if(_zeL.move)document.removeEventListener('mousemove',_zeL.move);
  if(_zeL.up)document.removeEventListener('mouseup',_zeL.up);
  if(_zeL.tm)document.removeEventListener('touchmove',_zeL.tm);
  if(_zeL.tu)document.removeEventListener('touchend',_zeL.tu);
  const rect=document.getElementById('drag-rect');
  function getPos(e){
    const cr=canvas.getBoundingClientRect();
    const src=e.touches?e.touches[0]:e;
    const cx=Math.max(0,Math.min(src.clientX-cr.left,cr.width));
    const cy=Math.max(0,Math.min(src.clientY-cr.top,cr.height));
    return{x:cx/zeScale,y:cy/zeScale};
  }
  function onDown(e){if(e.target!==canvas)return;e.preventDefault();zeState.isDragging=true;zeState.start=getPos(e);zeState.zone=null;rect.style.display='block';rect.style.left='0';rect.style.top='0';rect.style.width='0';rect.style.height='0';document.getElementById('ze-controls').style.display='none';}
  function onMove(e){
    if(!zeState.isDragging)return;e.preventDefault();
    const cur=getPos(e);
    const ix=Math.min(zeState.start.x,cur.x),iy=Math.min(zeState.start.y,cur.y);
    const iw=Math.abs(cur.x-zeState.start.x),ih=Math.abs(cur.y-zeState.start.y);
    zeState.zone={x:Math.round(ix),y:Math.round(iy),w:Math.round(iw),h:Math.round(ih)};
    const cr=canvas.getBoundingClientRect(),ir=inner.getBoundingClientRect();
    rect.style.left=(cr.left-ir.left+ix*zeScale)+'px';
    rect.style.top=(cr.top-ir.top+iy*zeScale)+'px';
    rect.style.width=(iw*zeScale)+'px';rect.style.height=(ih*zeScale)+'px';
  }
  function onUp(){
    if(!zeState.isDragging)return;zeState.isDragging=false;
    if(zeState.zone&&zeState.zone.w>5&&zeState.zone.h>5){
      document.getElementById('ze-info').value=`X:${zeState.zone.x} Y:${zeState.zone.y} W:${zeState.zone.w} H:${zeState.zone.h}`;
      document.getElementById('ze-controls').style.display='block';
      updateFontPreview();
    }
  }
  canvas.addEventListener('mousedown',onDown);
  canvas.addEventListener('touchstart',e=>{if(e.target===canvas){e.preventDefault();onDown(e);}},{passive:false});
  _zeL.move=onMove;_zeL.up=onUp;
  _zeL.tm=e=>{if(zeState.isDragging){e.preventDefault();onMove(e);}};
  _zeL.tu=onUp;
  document.addEventListener('mousemove',_zeL.move);
  document.addEventListener('mouseup',_zeL.up);
  document.addEventListener('touchmove',_zeL.tm,{passive:false});
  document.addEventListener('touchend',_zeL.tu);
}

function showZoneRect(z){
  const rect=document.getElementById('drag-rect');
  rect.style.display='block';
  rect.style.left=(z.x*zeScale)+'px';rect.style.top=(z.y*zeScale)+'px';
  rect.style.width=(z.w*zeScale)+'px';rect.style.height=(z.h*zeScale)+'px';
  document.getElementById('ze-info').value=`X:${z.x} Y:${z.y} W:${z.w} H:${z.h}`;
}

function toggleGradientUI(){
  const on=document.getElementById('ze-gradient').checked;
  document.getElementById('grad-color2-row').style.display=on?'':'none';
  document.getElementById('grad-dir-row').style.display=on?'':'none';
  updateFontPreview();
}

// â”€â”€ AUTO-FIT: binary-search for largest font that fits zone â”€â”€
function calcAutoFitSize(ctx,text,zonW,zonH,fontFamily,maxSize){
  const hi0=Math.min(maxSize||400, Math.floor(zonH*1.1), 500);
  let lo=6,hi=hi0,best=lo;
  for(let iter=0;iter<24;iter++){
    if(lo>hi)break;
    const mid=Math.floor((lo+hi)/2);
    ctx.font=`bold ${mid}px '${fontFamily}',Arial,sans-serif`;
    const m=ctx.measureText(text);
    const tw=m.width;
    // Use actual text height from metrics if available, fallback to mid*1.2
    const th=(m.actualBoundingBoxAscent!==undefined&&m.actualBoundingBoxDescent!==undefined)
      ?(m.actualBoundingBoxAscent+m.actualBoundingBoxDescent)
      :mid*1.15;
    if(tw<=zonW&&th<=zonH){best=mid;lo=mid+1;}else{hi=mid-1;}
  }
  return Math.max(best,6);
}

function updateFontPreview(){
  const font=document.getElementById('ze-font').value;
  const manualSize=parseInt(document.getElementById('ze-size').value)||36;
  const color=document.getElementById('ze-color').value;
  const gradient=document.getElementById('ze-gradient').checked;
  const color2=document.getElementById('ze-color2').value;
  const gradDir=document.getElementById('ze-grad-dir').value;
  const autofit=document.getElementById('ze-autofit').checked;
  const align=document.getElementById('ze-align').value;

  const canvas=document.getElementById('font-preview');
  const ctx=canvas.getContext('2d');

  // Use the actual zone dimensions for accurate preview if zone is set
  const zoneW=zeState.zone?zeState.zone.w:380;
  const zoneH=zeState.zone?zeState.zone.h:60;

  canvas.width=Math.max(400, zoneW<400?400:zoneW);
  canvas.height=Math.max(70, zoneH<40?40:zoneH+10);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Background
  ctx.fillStyle='#0d0d15';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const sampleText='PROMO50';
  const previewW=canvas.width-20;
  const previewH=canvas.height-10;

  let fsize=manualSize;
  if(autofit){
    fsize=calcAutoFitSize(ctx,sampleText,previewW,previewH,font,400);
  }

  ctx.font=`bold ${fsize}px '${font}',Arial,sans-serif`;

  // Fill style
  if(gradient&&color2){
    const dir=gradDir||'lr';
    let grd;
    if(dir==='lr')grd=ctx.createLinearGradient(10,0,canvas.width-10,0);
    else if(dir==='tb')grd=ctx.createLinearGradient(0,5,0,canvas.height-5);
    else grd=ctx.createLinearGradient(10,5,canvas.width-10,canvas.height-5);
    grd.addColorStop(0,color);grd.addColorStop(1,color2);
    ctx.fillStyle=grd;
  } else {
    ctx.fillStyle=color;
  }

  ctx.textAlign=align||'center';
  ctx.textBaseline='middle';
  const tx=align==='left'?14:align==='right'?canvas.width-14:canvas.width/2;
  ctx.fillText(sampleText,tx,canvas.height/2,previewW);
}

function confirmZone(){
  const zone=zeState.zone||(()=>{
    const p=document.getElementById('ze-info').value.match(/X:(\d+) Y:(\d+) W:(\d+) H:(\d+)/);
    return p?{x:+p[1],y:+p[2],w:+p[3],h:+p[4]}:null;
  })();
  if(!zone||zone.w<5){toast('Drag a zone first','err');return;}
  zone.font=document.getElementById('ze-font').value;
  zone.size=parseInt(document.getElementById('ze-size').value)||36;
  zone.color=document.getElementById('ze-color').value;
  zone.align=document.getElementById('ze-align').value;
  zone.autofit=document.getElementById('ze-autofit').checked;
  zone.gradient=document.getElementById('ze-gradient').checked;
  zone.color2=document.getElementById('ze-color2').value;
  zone.gradDir=document.getElementById('ze-grad-dir').value;
  if(activeQIdx!==null){queue[activeQIdx].zone=zone;queue[activeQIdx].status='done';}
  closeZoneEditor();renderQueue();toast('âœ… Zone confirmed!');
}

function clearZoneRect(){zeState.zone=null;document.getElementById('drag-rect').style.display='none';document.getElementById('ze-controls').style.display='none';document.getElementById('ze-info').value='';}

function closeZoneEditor(){
  document.getElementById('zone-editor').style.display='none';activeQIdx=null;
  if(_zeL.move)document.removeEventListener('mousemove',_zeL.move);
  if(_zeL.up)document.removeEventListener('mouseup',_zeL.up);
  if(_zeL.tm)document.removeEventListener('touchmove',_zeL.tm);
  if(_zeL.tu)document.removeEventListener('touchend',_zeL.tu);
  _zeL={};
}

// â”€â”€ STAMP CANVAS: auto-fit + gradient â”€â”€
function stampCanvas(ctx,banner,promoCode){
  if(!banner.promoConfig||!promoCode)return;
  const pc=banner.promoConfig;
  ctx.save();
  ctx.beginPath();ctx.rect(pc.x,pc.y,pc.w,pc.h);ctx.clip();
  const ff=pc.font?`'${pc.font}'`:'Arial Black';
  // Calculate font size
  let fsize=pc.size||36;
  if(pc.autofit!==false){
    // Auto-fit: find largest size that fits the zone
    fsize=calcAutoFitSize(ctx,promoCode,pc.w,pc.h,pc.font||'Arial Black',pc.size||400);
  }
  ctx.font=`bold ${fsize}px ${ff},Arial,sans-serif`;
  // Fill style: gradient or solid
  if(pc.gradient&&pc.color2){
    let grd;
    const dir=pc.gradDir||'lr';
    if(dir==='lr') grd=ctx.createLinearGradient(pc.x,pc.y,pc.x+pc.w,pc.y);
    else if(dir==='tb') grd=ctx.createLinearGradient(pc.x,pc.y,pc.x,pc.y+pc.h);
    else grd=ctx.createLinearGradient(pc.x,pc.y,pc.x+pc.w,pc.y+pc.h);
    grd.addColorStop(0,pc.color||'#ffffff');
    grd.addColorStop(1,pc.color2);
    ctx.fillStyle=grd;
  } else {
    ctx.fillStyle=pc.color||'#ffffff';
  }
  const align=pc.align||'center';
  ctx.textAlign=align;ctx.textBaseline='middle';
  const tx=align==='center'?pc.x+(pc.w/2):align==='left'?pc.x+4:pc.x+pc.w-4;
  ctx.fillText(promoCode,tx,pc.y+(pc.h/2));
  ctx.restore();
}

// â”€â”€ SAVE ALL BANNERS â”€â”€
async function saveAllBanners(){
  if(!queue.length){toast('No banners in queue','err');return;}
  const evergreen=document.getElementById('ban-type').value==='evergreen';
  const startDate=document.getElementById('ban-start').value;
  const endDate=document.getElementById('ban-end').value;
  if(!evergreen&&(!startDate||!endDate)){toast('Set start and end dates','err');return;}
  const lang=document.getElementById('ban-lang').value;
  const prog=document.getElementById('save-prog');
  let saved=0;
  const banners=gd('banners',[]);
  const texts=gd('texts',[]).filter(t=>t.lang===lang);
  for(const item of queue){
    if(!item.dataURL){toast(item.name+' loadingâ€¦','err');continue;}
    try{
      await idbPut(item.id,item.dataURL);
      const b={id:item.id,lang,evergreen,startDate:evergreen?null:startDate,endDate:evergreen?null:endDate,name:item.name,promoConfig:item.zone||null,assignedTextId:texts.length?texts[saved%texts.length].id:null,createdAt:Date.now()};
      banners.push(b);saved++;
      prog.textContent=`Saving ${saved}/${queue.length}â€¦`;
    }catch(err){toast('Error: '+err.message,'err');}
  }
  sd('banners',banners);clearQueue();renderBanners();prog.textContent='';
  toast(`âœ… ${saved} saved!`);
}

function toggleDates(){const ev=document.getElementById('ban-type').value==='evergreen';document.getElementById('sg-start').style.display=ev?'none':'';document.getElementById('sg-end').style.display=ev?'none':'';}

// â”€â”€ EXPIRY: 35 hours after end date â”€â”€
function bannerExpired(b){
  if(b.evergreen)return false;
  if(!b.endDate)return false;
  const expiry=new Date(b.endDate);expiry.setHours(23,59,59,999);
  const removeAt=new Date(expiry.getTime()+35*60*60*1000);
  return Date.now()>removeAt.getTime();
}
function msUntilRemoval(b){
  if(b.evergreen||!b.endDate)return Infinity;
  const expiry=new Date(b.endDate);expiry.setHours(23,59,59,999);
  const removeAt=new Date(expiry.getTime()+35*60*60*1000);
  return Math.max(0,removeAt.getTime()-Date.now());
}
function fmtCountdown(ms){
  if(ms<=0)return'Removingâ€¦';
  const h=Math.floor(ms/3600000);const m=Math.floor((ms%3600000)/60000);const s=Math.floor((ms%60000)/1000);
  return`${h}h ${m}m ${s}s until removal`;
}
function pruneExpiredBanners(){
  const banners=gd('banners',[]);
  const active=banners.filter(b=>!bannerExpired(b));
  if(active.length!==banners.length){
    sd('banners',active);
    // Clean up IDB for expired ones
    const removed=banners.filter(b=>bannerExpired(b));
    removed.forEach(b=>{idbDel(b.id).catch(()=>{});});
  }
  return active;
}

let _cdTimers=[];
async function renderBanners(){
  _cdTimers.forEach(clearInterval);_cdTimers=[];
  const banners=pruneExpiredBanners();
  document.getElementById('ban-cnt').textContent=banners.length;
  const tb=document.getElementById('ban-tbody');
  if(!banners.length){tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">No banners</td></tr>';return;}
  const texts=gd('texts',[]);
  tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:10px;font-size:.78rem">Loadingâ€¦</td></tr>';
  const rows=await Promise.all(banners.map(async b=>{
    let thumbSrc='';
    try{const d=await idbGet(b.id);if(d)thumbSrc=d;}catch(e){}
    const thumb=thumbSrc?`<img src="${thumbSrc}" style="height:50px;width:80px;object-fit:cover;border-radius:6px;border:1px solid var(--border)"/>`:`<div style="width:80px;height:50px;background:var(--card2);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.65rem;color:var(--muted)">No img</div>`;
    const txt=texts.find(t=>t.id===b.assignedTextId);
    const assign=txt?`<span style="font-size:.72rem;color:var(--blue2)">${LS[txt.lang]} Caption</span>`:'<span style="color:var(--muted);font-size:.72rem">None</span>';
    const ms=msUntilRemoval(b);
    const cdId='cd-'+b.id;
    const expiryRow=b.evergreen?'No expiry':`${b.startDate} â†’ ${b.endDate}<div class="cd-warn" id="${cdId}">${fmtCountdown(ms)}</div>`;
    return`<tr>
      <td>${thumb}</td>
      <td><span class="bx ${b.evergreen?'bx-a':'bx-r'}">${b.evergreen?'â™¾ï¸ Evergreen':'ğŸ“… Dated'}</span></td>
      <td>${LS[b.lang]||b.lang}</td>
      <td style="font-size:.76rem;color:var(--muted)">${expiryRow}</td>
      <td>${b.promoConfig?'<span class="bx bx-r">âœ“ Set</span>':'<span style="color:var(--muted);font-size:.73rem">None</span>'}</td>
      <td>${assign}
        <select onchange="assignText('${b.id}',this.value)" style="margin-top:4px;font-size:.72rem;padding:3px 6px;background:#0d0d15;border:1px solid var(--border);border-radius:5px;color:var(--text);width:100%">
          <option value="">â€” Assign caption â€”</option>
          ${texts.filter(t=>t.lang===b.lang).map((t,ti)=>`<option value="${t.id}" ${t.id===b.assignedTextId?'selected':''}>${LS[t.lang]} #${ti+1}</option>`).join('')}
        </select>
      </td>
      <td><button class="btn r sm" onclick="delBanner('${b.id}')">ğŸ—‘ï¸</button></td>
    </tr>`;
  }));
  tb.innerHTML=rows.join('');
  // Start countdown timers for dated banners
  banners.filter(b=>!b.evergreen).forEach(b=>{
    const el=document.getElementById('cd-'+b.id);
    if(!el)return;
    const t=setInterval(()=>{
      const ms2=msUntilRemoval(b);
      if(ms2<=0){clearInterval(t);pruneExpiredBanners();renderBanners();return;}
      el.textContent=fmtCountdown(ms2);
    },1000);
    _cdTimers.push(t);
  });
}

function assignText(bannerId,textId){const banners=gd('banners',[]);const b=banners.find(x=>x.id===bannerId);if(b){b.assignedTextId=textId||null;sd('banners',banners);toast('Caption assigned');}}
async function delBanner(id){if(!confirm('Delete?'))return;sd('banners',gd('banners',[]).filter(b=>b.id!==id));try{await idbDel(id);}catch(e){}renderBanners();toast('Deleted');}

// â•â•â• TEXTS â•â•â•
let txtFilter='all';
function saveTxt(){const editId=document.getElementById('txt-edit-id').value;const content=document.getElementById('txt-body').value.trim();const lang=document.getElementById('txt-lang').value;if(!content){toast('Required','err');return;}let texts=gd('texts',[]);const obj={id:editId||uid(),lang,content};if(editId)texts=texts.map(t=>t.id===editId?obj:t);else texts.push(obj);sd('texts',texts);clearTxt();renderTxts();toast('âœ… Saved!');}
function clearTxt(){document.getElementById('txt-body').value='';document.getElementById('txt-edit-id').value='';document.getElementById('txt-title').textContent='Add Caption';document.getElementById('txt-icon').textContent='â•';document.getElementById('txt-edit-note').style.display='none';}
function editTxt(id){const t=gd('texts',[]).find(x=>x.id===id);if(!t)return;document.getElementById('txt-edit-id').value=t.id;document.getElementById('txt-lang').value=t.lang;document.getElementById('txt-body').value=t.content;document.getElementById('txt-title').textContent='Edit';document.getElementById('txt-icon').textContent='âœï¸';document.getElementById('txt-edit-note').style.display='inline';window.scrollTo({top:0,behavior:'smooth'});}
function delTxt(id){if(!confirm('Delete?'))return;sd('texts',gd('texts',[]).filter(t=>t.id!==id));renderTxts();toast('Deleted');}
function filterTxt(lang,el){txtFilter=lang;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));if(el)el.classList.add('on');renderTxts();}
function renderTxts(){
  const texts=gd('texts',[]);
  const filtered=txtFilter==='all'?texts:texts.filter(t=>t.lang===txtFilter);
  document.getElementById('txt-cnt').textContent=texts.length;
  const c=document.getElementById('txt-list');
  if(!filtered.length){c.innerHTML='<div style="text-align:center;color:var(--muted);padding:24px">No captions</div>';return;}
  c.innerHTML=filtered.map((t,i)=>`<div class="tc">
    <div class="tc-top">
      <div style="display:flex;align-items:center;gap:7px"><span class="bx bx-r">${LS[t.lang]||t.lang}</span><span style="font-size:.7rem;color:var(--muted)">#${i+1}</span></div>
      <div class="br"><button class="btn a sm" onclick="editTxt('${t.id}')">âœï¸</button><button class="btn r sm" onclick="delTxt('${t.id}')">ğŸ—‘ï¸</button></div>
    </div><pre>${eh(t.content)}</pre>
  </div>`).join('');
}

// â•â•â• BULK DOWNLOAD â•â•â•
function populateDlAffs(){
  const dlLang=document.getElementById('dl-lang').value;
  let affs=gd('affiliates',[]);
  if(dlLang!=='all')affs=affs.filter(a=>a.lang===dlLang);
  const sel=document.getElementById('dl-aff');
  sel.innerHTML='<option value="all">All</option>'+affs.map(a=>`<option value="${ea(a.id)}">${eh(a.id)} â€” ${eh(a.promoCode)}</option>`).join('');
}
function getDlScope(){
  const dlLang=document.getElementById('dl-lang').value;
  const dlType=document.getElementById('dl-type').value;
  const dlAffId=document.getElementById('dl-aff').value;
  let allAffs=gd('affiliates',[]);
  let allBanners=pruneExpiredBanners();
  if(dlType==='dated')allBanners=allBanners.filter(b=>!b.evergreen);
  if(dlType==='evergreen')allBanners=allBanners.filter(b=>b.evergreen);
  if(dlAffId!=='all')allAffs=allAffs.filter(a=>a.id===dlAffId);
  const pairs=[];
  for(const aff of allAffs){
    const affLang=aff.lang||'en';
    const matchBanners=allBanners.filter(b=>dlLang!=='all'?b.lang===dlLang&&b.lang===affLang:b.lang===affLang);
    for(const b of matchBanners)pairs.push({aff,banner:b});
  }
  return pairs;
}
function makeFilename(promoCode,banner){
  const s=v=>String(v||'').replace(/[^a-zA-Z0-9_\-]/g,'_');
  if(banner.evergreen)return`${s(promoCode)}_evergreen.png`;
  return`${s(promoCode)}_${s(banner.startDate)}_to_${s(banner.endDate)}.png`;
}
async function previewDownload(){
  const pairs=getDlScope();
  const prev=document.getElementById('dl-preview-list');
  prev.style.display='block';
  if(!pairs.length){prev.innerHTML='<div style="color:var(--muted);font-size:.83rem;padding:10px">No matching pairs. Check language settings.</div>';return;}
  const lines=pairs.map(({aff,banner})=>`<div style="font-size:.78rem;padding:4px 0;border-bottom:1px solid var(--border)"><strong style="color:var(--ac)">${eh(aff.id)}</strong> â†’ <strong style="color:var(--text)">${makeFilename(aff.promoCode,banner)}</strong></div>`);
  prev.innerHTML=`<div style="font-size:.75rem;color:var(--ac);margin-bottom:8px;font-weight:700">${pairs.length} file(s):</div><div style="max-height:220px;overflow-y:auto;background:var(--card2);border-radius:8px;padding:8px 12px">${lines.join('')}</div>`;
}
async function startBulkDownload(){
  const pairs=getDlScope();
  if(!pairs.length){toast('No matching pairs. Check filters.','err');return;}
  const structure=document.getElementById('dl-structure').value;
  const progEl=document.getElementById('dl-progress');
  const progText=document.getElementById('dl-prog-text');
  const progFill=document.getElementById('dl-prog-fill');
  progEl.style.display='block';
  function loadImg(src){return new Promise(res=>{const i=new Image();i.onload=()=>res(i);i.onerror=()=>res(null);i.src=src;});}
  const bannerIds=[...new Set(pairs.map(p=>p.banner.id))];
  const imgCache={};
  for(const bid of bannerIds){try{const d=await idbGet(bid);imgCache[bid]=d||null;}catch(e){imgCache[bid]=null;}}
  const total=pairs.length;let done=0;
  async function renderPair(aff,banner){
    const src=imgCache[banner.id];if(!src)return null;
    const img=await loadImg(src);if(!img)return null;
    const c=document.createElement('canvas');c.width=img.width;c.height=img.height;
    const ctx=c.getContext('2d');ctx.drawImage(img,0,0);
    stampCanvas(ctx,banner,aff.promoCode);
    return new Promise(res=>c.toBlob(res,'image/png'));
  }
  if(structure==='perAff'){
    const byAff={};
    pairs.forEach(p=>{if(!byAff[p.aff.id])byAff[p.aff.id]={aff:p.aff,pairs:[]};byAff[p.aff.id].pairs.push(p);});
    for(const affId of Object.keys(byAff)){
      const{aff,pairs:ap}=byAff[affId];
      const zip=new JSZip();
      for(const{banner}of ap){const blob=await renderPair(aff,banner);if(blob)zip.file(makeFilename(aff.promoCode,banner),blob);done++;progText.textContent=`Processing ${done}/${total}â€¦`;progFill.style.width=Math.round(done/total*100)+'%';await new Promise(r=>setTimeout(r,5));}
      const zb=await zip.generateAsync({type:'blob'});
      const a=document.createElement('a');a.href=URL.createObjectURL(zb);a.download=`megapari_${aff.id}_${aff.promoCode}.zip`;a.click();
      await new Promise(r=>setTimeout(r,400));
    }
  } else {
    const zip=new JSZip();
    for(const{aff,banner}of pairs){const folder=zip.folder(aff.id+'_'+aff.promoCode);const blob=await renderPair(aff,banner);if(blob)folder.file(makeFilename(aff.promoCode,banner),blob);done++;progText.textContent=`Processing ${done}/${total}â€¦`;progFill.style.width=Math.round(done/total*100)+'%';await new Promise(r=>setTimeout(r,5));}
    progText.textContent='Compressingâ€¦';
    const zb=await zip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:6}});
    const a=document.createElement('a');a.href=URL.createObjectURL(zb);a.download=`megapari_banners_${new Date().toISOString().slice(0,10)}.zip`;a.click();
  }
  progText.textContent='âœ… Done!';setTimeout(()=>progEl.style.display='none',4000);toast('âœ… ZIP ready!');
}

// â•â•â• SELF-REGISTRATIONS â•â•â•
function updateRegBadge(){
  const pending=gd('pendingRegs',[]).length;
  const badge=document.getElementById('reg-badge');
  badge.textContent=pending;badge.style.display=pending?'inline':'none';
}
function renderRegs(){
  const pending=gd('pendingRegs',[]);
  const approved=gd('approvedRegs',[]);
  document.getElementById('pending-cnt').textContent=pending.length;
  document.getElementById('approved-cnt').textContent=approved.length;
  const pEl=document.getElementById('pending-list');
  if(!pending.length){pEl.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px">No pending registrations</div>';}
  else{
    pEl.innerHTML=pending.map((r,i)=>`<div class="reg-card">
      <div class="reg-info">
        <strong>${eh(r.id)}</strong> â€” ${eh(r.name||'â€”')}<br>
        Promo: <strong>${eh(r.promoCode||'â€”')}</strong> Â· Lang: ${LS[r.lang]||r.lang} Â· ${new Date(r.submittedAt||0).toLocaleString()}<br>
        <span style="font-size:.77rem;color:var(--muted)">Links: ${r.playerLink||'â€”'}</span>
      </div>
      <div class="br">
        <button class="btn g sm" onclick="approveReg(${i})">âœ… Approve</button>
        <button class="btn a sm" onclick="editAndApproveReg(${i})">âœï¸ Edit & Approve</button>
        <button class="btn r sm" onclick="rejectReg(${i})">âœ• Reject</button>
      </div>
    </div>`).join('');
  }
  const aEl=document.getElementById('approved-list');
  if(!approved.length){aEl.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px">None yet</div>';}
  else{aEl.innerHTML='<div class="tw"><table><thead><tr><th>ID</th><th>Name</th><th>Promo</th><th>Lang</th><th>Date</th></tr></thead><tbody>'+approved.map(r=>`<tr><td>${eh(r.id)}</td><td>${eh(r.name||'â€”')}</td><td>${eh(r.promoCode||'â€”')}</td><td>${LS[r.lang]||r.lang}</td><td style="font-size:.75rem;color:var(--muted)">${new Date(r.submittedAt||0).toLocaleDateString()}</td></tr>`).join('')+'</tbody></table></div>';}
  updateRegBadge();
}
function approveReg(i){
  const pending=gd('pendingRegs',[]);
  const r=pending[i];if(!r)return;
  // Add to affiliates
  let affs=gd('affiliates',[]);
  const existing=affs.findIndex(a=>a.id.toLowerCase()===r.id.toLowerCase());
  if(existing>=0)affs[existing]=r;else affs.push(r);
  sd('affiliates',affs);
  // Move to approved
  const approved=gd('approvedRegs',[]);approved.push(r);sd('approvedRegs',approved);
  pending.splice(i,1);sd('pendingRegs',pending);
  renderRegs();renderAffs();toast('âœ… Approved & activated!');
}
function editAndApproveReg(i){
  const pending=gd('pendingRegs',[]);
  const r=pending[i];if(!r)return;
  // Pre-fill the affiliates form for editing
  go('affiliates',document.querySelector('.nav'));
  document.getElementById('a-id').value=r.id||'';
  document.getElementById('a-name').value=r.name||'';
  document.getElementById('a-promo').value=r.promoCode||'';
  document.getElementById('a-player').value=r.playerLink||'';
  document.getElementById('a-apk').value=r.apkLink||'';
  document.getElementById('a-ios').value=r.iosLink||'';
  document.getElementById('a-lang').value=r.lang||'en';
  document.getElementById('aff-form-title').textContent='Approve Registration';
  // Remove from pending
  pending.splice(i,1);sd('pendingRegs',pending);
  updateRegBadge();
  window.scrollTo({top:0,behavior:'smooth'});
  toast('Edit details then click Save Affiliate');
}
function rejectReg(i){
  if(!confirm('Reject this registration?'))return;
  const pending=gd('pendingRegs',[]);pending.splice(i,1);sd('pendingRegs',pending);renderRegs();toast('Rejected');
}

// â•â•â• SETTINGS â•â•â•
function changePw(){const cur=document.getElementById('cur-pw').value;const nw=document.getElementById('new-pw').value;const conf=document.getElementById('conf-pw').value;const stored=localStorage.getItem('adminPw')||'admin123';if(cur!==stored){toast('Wrong password','err');return;}if(!nw||nw.length<4){toast('Min 4 chars','err');return;}if(nw!==conf){toast('No match','err');return;}localStorage.setItem('adminPw',nw);['cur-pw','new-pw','conf-pw'].forEach(f=>document.getElementById(f).value='');toast('âœ… Updated!');}
function exportData(){const d={affiliates:gd('affiliates',[]),texts:gd('texts',[]),exportedAt:new Date().toISOString()};const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='megapari-backup-'+new Date().toISOString().slice(0,10)+'.json';a.click();toast('âœ… Exported!');}
function importData(){const file=document.getElementById('imp-in').files[0];if(!file)return;const r=new FileReader();r.onload=function(e){try{const d=JSON.parse(e.target.result);if(d.affiliates)sd('affiliates',d.affiliates);if(d.texts)sd('texts',d.texts);ensureDefTxts();renderAffs();renderTxts();toast('âœ… Imported!');}catch(err){toast('Invalid','err');}};r.readAsText(file);}
function clearAll(){if(!confirm('Delete ALL?'))return;if(!confirm('Final confirm?'))return;['affiliates','banners','texts','pendingRegs','approvedRegs'].forEach(k=>localStorage.removeItem(k));openDB().then(db=>{try{db.transaction(IDB_STORE,'readwrite').objectStore(IDB_STORE).clear();}catch(e){}});renderAffs();renderBanners();renderTxts();renderRegs();toast('Cleared');}
function renderStats(){
  const a=gd('affiliates',[]).length,b=gd('banners',[]),t=gd('texts',[]),pr=gd('pendingRegs',[]).length;
  const byL={en:0,fr:0,ar:0,es:0,pt:0};t.forEach(x=>{if(byL[x.lang]!==undefined)byL[x.lang]++;});
  const sc=(v,l,c)=>`<div style="background:var(--card2);border:1px solid var(--border);border-radius:9px;padding:14px;text-align:center"><div style="font-size:1.6rem;font-weight:700;color:${c};font-family:'Bebas Neue',sans-serif">${v}</div><div style="font-size:.67rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px">${l}</div></div>`;
  document.getElementById('stats-area').innerHTML=sc(a,'Affiliates','var(--ac)')+sc(b.length,'Banners','var(--amber)')+sc(t.length,'Captions','var(--blue2)')+sc(pr,'Pending Regs','var(--amber)')+Object.entries(byL).map(([l,n])=>sc(n,LS[l],'var(--muted)')).join('');
}

// â•â•â• HELPERS â•â•â•
function toast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.style.background=type==='err'?'var(--red)':'var(--ac)';t.style.color='#fff';t.classList.add('on');setTimeout(()=>t.classList.remove('on'),2800);}
function eh(s){const d=document.createElement('div');d.textContent=String(s||'');return d.innerHTML;}
function ea(s){return String(s||'').replace(/'/g,"\\'");}

// â•â•â• DEFAULT TEXTS â•â•â•
function getDefTxts(){return[
  {id:'e1',lang:'en',content:"âš½ğŸ”¥ BIG MATCH ENERGY STARTS HERE!\nğŸ¯ Register: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code: {{Promo code}}"},
  {id:'e2',lang:'en',content:"Smart bettors use the right platform.\nğŸ‘‰ Join: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° Code: {{Promo code}}"},
  {id:'e3',lang:'en',content:"ğŸš¨ TODAY'S GAMES = TODAY'S PROFITS\nğŸ”— Register: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code: {{Promo code}}"},
  {id:'e4',lang:'en',content:"Winning community growing daily âš½\nStart: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
  {id:'e5',lang:'en',content:"Trusted odds. Fast payouts.\nRegister: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
  {id:'e6',lang:'en',content:"Weekend football hits different ğŸ˜\nSign up: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
  {id:'e7',lang:'en',content:"ğŸ Bonus unlocked â€” just register.\nğŸ‘‰ Register: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCode: {{Promo code}}"},
  {id:'f1',lang:'fr',content:"âš½ğŸ”¥ MATCHS DE RÃŠVE = PROFITS RÃ‰ELS!\nğŸ¯ Inscription: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code: {{Promo code}}"},
  {id:'f2',lang:'fr',content:"Les parieurs intelligents choisissent Megapari.\nğŸ‘‰ Rejoignez: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° Code: {{Promo code}}"},
  {id:'f3',lang:'fr',content:"ğŸš¨ LES MATCHS D'AUJOURD'HUI = PROFITS\nğŸ”— S'inscrire: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code: {{Promo code}}"},
  {id:'f4',lang:'fr',content:"Notre communautÃ© gagnante âš½\nCommencez: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
  {id:'f5',lang:'fr',content:"Cotes fiables. Paiements rapides.\nS'inscrire: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
  {id:'f6',lang:'fr',content:"Football du week-end ğŸ˜\nS'inscrire: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCode: {{Promo code}}"},
  {id:'f7',lang:'fr',content:"ğŸ Bonus dÃ©bloquÃ©.\nğŸ‘‰ S'inscrire: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCode: {{Promo code}}"},
  {id:'a1',lang:'ar',content:"âš½ğŸ”¥ Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©!\nğŸ¯ Ø³Ø¬Ù‘Ù„: {{Player link}}\nğŸ“² Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ ÙƒÙˆØ¯: {{Promo code}}"},
  {id:'a2',lang:'ar',content:"Ø§Ù„Ù…Ø±Ø§Ù‡Ù†ÙˆÙ† Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ ÙŠØ®ØªØ§Ø±ÙˆÙ† Megapari.\nğŸ‘‰ Ø§Ù†Ø¶Ù…: {{Player link}}\nğŸ“¥ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° ÙƒÙˆØ¯: {{Promo code}}"},
  {id:'a3',lang:'ar',content:"ğŸš¨ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ… = Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…!\nğŸ”— Ø³Ø¬Ù‘Ù„: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ ÙƒÙˆØ¯: {{Promo code}}"},
  {id:'a4',lang:'ar',content:"Ù…Ø¬ØªÙ…Ø¹ ÙØ§Ø¦Ø² Ù…ØªÙ†Ø§Ù…Ù âš½\nØ§Ø¨Ø¯Ø£: {{Player link}}\nØ£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\niOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}"},
  {id:'a5',lang:'ar',content:"Ø£ÙˆØ¶Ø§Ø¹ Ù…ÙˆØ«ÙˆÙ‚Ø©. Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø³Ø±ÙŠØ¹Ø©.\nØ³Ø¬Ù‘Ù„: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}"},
  {id:'a6',lang:'ar',content:"ÙƒØ±Ø© Ù‚Ø¯Ù… Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ğŸ˜\nØ³Ø¬Ù‘Ù„: {{Player link}}\nØ£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\niOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}"},
  {id:'a7',lang:'ar',content:"ğŸ Ù…ÙƒØ§ÙØ£Ø© Ù…ØªØ§Ø­Ø©.\nğŸ‘‰ Ø³Ø¬Ù‘Ù„: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nÙƒÙˆØ¯: {{Promo code}}"},
  {id:'s1',lang:'es',content:"âš½ğŸ”¥ Â¡GRANDES PARTIDOS = GRANDES GANANCIAS!\nğŸ¯ RegÃ­strate: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}"},
  {id:'s2',lang:'es',content:"Los apostadores inteligentes eligen Megapari.\nğŸ‘‰ Ãšnete: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° CÃ³digo: {{Promo code}}"},
  {id:'s3',lang:'es',content:"ğŸš¨ PARTIDOS DE HOY = GANANCIAS DE HOY\nğŸ”— Registro: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}"},
  {id:'s4',lang:'es',content:"Comunidad ganadora creciendo âš½\nEmpieza: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
  {id:'s5',lang:'es',content:"Cuotas confiables. Pagos rÃ¡pidos.\nRegÃ­strate: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
  {id:'s6',lang:'es',content:"FÃºtbol de fin de semana ğŸ˜\nRegÃ­strate: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
  {id:'s7',lang:'es',content:"ğŸ Bono disponible.\nğŸ‘‰ RegÃ­strate: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
  {id:'p1',lang:'pt',content:"âš½ğŸ”¥ GRANDES JOGOS = GRANDES LUCROS!\nğŸ¯ Registre-se: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}"},
  {id:'p2',lang:'pt',content:"Apostadores inteligentes escolhem Megapari.\nğŸ‘‰ Junte-se: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° CÃ³digo: {{Promo code}}"},
  {id:'p3',lang:'pt',content:"ğŸš¨ JOGOS DE HOJE = LUCROS DE HOJE\nğŸ”— Registro: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}"},
  {id:'p4',lang:'pt',content:"Comunidade vencedora crescendo âš½\nComece: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
  {id:'p5',lang:'pt',content:"Odds confiÃ¡veis. Pagamentos rÃ¡pidos.\nRegistre-se: {{Player link}}\nAPK: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
  {id:'p6',lang:'pt',content:"Futebol de fim de semana ğŸ˜\nRegistre-se: {{Player link}}\nAndroid: {{apk link}}\niOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
  {id:'p7',lang:'pt',content:"ğŸ BÃ´nus disponÃ­vel.\nğŸ‘‰ Registro: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nCÃ³digo: {{Promo code}}"},
];}
function ensureDefTxts(){const t=gd('texts',[]);if(!t||t.length===0)sd('texts',getDefTxts());}
</script>
</body>
</html>
