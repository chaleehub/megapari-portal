<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Admin â€” Megapari Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&family=Anton&family=Black+Han+Sans&family=Teko:wght@600;700&family=Barlow+Condensed:wght@700;800;900&family=Russo+One&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
:root{--ac:#e53935;--ac2:#c62828;--dark:#0a0a0f;--card:#12121a;--card2:#1a1a26;--border:rgba(229,57,53,.18);--text:#f0f0f8;--muted:#8888aa;--red:#ff5252;--amber:#ffab40;--blue2:#82b1ff;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dark);color:var(--text);font-family:'Outfit',sans-serif;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 70% 50% at 5% 10%,rgba(229,57,53,.06) 0%,transparent 55%),radial-gradient(ellipse 50% 40% at 95% 90%,rgba(92,159,212,.05) 0%,transparent 50%);pointer-events:none;z-index:0;}
.wrap{display:flex;min-height:100vh;position:relative;z-index:1;}
.sidebar{width:240px;background:var(--card);border-right:1px solid var(--border);padding:20px 0;flex-shrink:0;position:fixed;top:0;left:0;height:100vh;overflow-y:auto;z-index:20;}
.sidebar-logo{padding:0 20px 20px;border-bottom:1px solid var(--border);margin-bottom:10px;}
.logo-t{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:var(--ac);letter-spacing:2px;cursor:pointer;}
.logo-t span{color:var(--text);}
.logo-s{font-size:.58rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.cloud-status{margin-top:8px;font-size:.62rem;padding:4px 8px;border-radius:4px;display:inline-block;}
.cs-ok{background:rgba(92,159,212,.12);color:var(--blue2);border:1px solid rgba(92,159,212,.2);}
.cs-err{background:rgba(255,82,82,.1);color:var(--red);border:1px solid rgba(255,82,82,.2);}
.nav{display:flex;align-items:center;gap:8px;padding:11px 20px;cursor:pointer;font-size:.85rem;font-weight:500;color:var(--muted);transition:all .15s;border-left:3px solid transparent;user-select:none;}
.nav:hover{color:var(--text);background:rgba(229,57,53,.05);}
.nav.on{color:var(--ac);border-left-color:var(--ac);background:rgba(229,57,53,.08);}
.nav-badge{background:var(--ac);color:#fff;font-size:.58rem;padding:1px 5px;border-radius:10px;margin-left:auto;font-weight:700;}
.nav-sep{height:1px;background:var(--border);margin:6px 0;}
.main{flex:1;margin-left:240px;padding:28px 32px;min-height:100vh;}
.page{display:none;}.page.on{display:block;}
.ph{margin-bottom:24px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.ph h1{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:4px;}
.ph p{color:var(--muted);font-size:.82rem;margin-top:4px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:13px;padding:20px;margin-bottom:18px;}
.card-title{font-size:.76rem;font-weight:700;color:var(--ac);text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.row{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:12px;}
.fg{display:flex;flex-direction:column;gap:4px;}
label{font-size:.66rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);font-weight:600;}
input[type=text],input[type=date],input[type=number],input[type=password],select,textarea{background:#0d0d15;border:1px solid var(--border);border-radius:8px;color:var(--text);padding:9px 12px;font-family:'Outfit',sans-serif;font-size:.86rem;outline:none;transition:border-color .2s;width:100%;}
input[type=color]{background:#0d0d15;border:1px solid var(--border);border-radius:8px;height:38px;padding:3px 6px;width:100%;cursor:pointer;}
input:focus,select:focus,textarea:focus{border-color:var(--ac);}
textarea{resize:vertical;min-height:90px;line-height:1.6;}
.btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Outfit',sans-serif;font-size:.81rem;font-weight:700;cursor:pointer;transition:all .18s;letter-spacing:.3px;display:inline-flex;align-items:center;gap:5px;}
.g{background:var(--ac);color:#fff;}.g:hover{background:var(--ac2);transform:translateY(-1px);}
.r{background:rgba(255,82,82,.12);color:var(--red);border:1px solid rgba(255,82,82,.25);}.r:hover{background:rgba(255,82,82,.2);}
.a{background:rgba(255,171,64,.12);color:var(--amber);border:1px solid rgba(255,171,64,.25);}.a:hover{background:rgba(255,171,64,.2);}
.o{background:transparent;color:var(--ac);border:1px solid rgba(229,57,53,.35);}.o:hover{background:rgba(229,57,53,.07);}
.b{background:rgba(92,159,212,.12);color:var(--blue2);border:1px solid rgba(92,159,212,.25);}.b:hover{background:rgba(92,159,212,.2);}
.sm{padding:4px 10px;font-size:.7rem;}
.br{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:6px;}
.tw{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:.81rem;}
th{padding:8px 12px;background:var(--card2);color:var(--muted);text-align:left;font-weight:700;font-size:.64rem;text-transform:uppercase;letter-spacing:1.5px;}
td{padding:9px 12px;border-bottom:1px solid rgba(229,57,53,.06);vertical-align:middle;}
tr:last-child td{border-bottom:none;}tr:hover td{background:rgba(229,57,53,.02);}
.bx{display:inline-block;padding:2px 7px;border-radius:4px;font-size:.65rem;font-weight:700;letter-spacing:.3px;}
.bx-r{background:rgba(229,57,53,.12);color:var(--ac);border:1px solid rgba(229,57,53,.25);}
.bx-a{background:rgba(255,171,64,.1);color:var(--amber);border:1px solid rgba(255,171,64,.2);}
.bx-b{background:rgba(92,159,212,.1);color:var(--blue2);border:1px solid rgba(92,159,212,.2);}
.dropzone{border:2px dashed rgba(229,57,53,.25);border-radius:10px;padding:22px;text-align:center;background:rgba(229,57,53,.02);transition:all .2s;cursor:pointer;}
.dropzone:hover,.dropzone.drag{border-color:var(--ac);background:rgba(229,57,53,.05);}
.dropzone .dz-icon{font-size:2.2rem;margin-bottom:7px;}
.dropzone p{color:var(--muted);font-size:.82rem;line-height:1.6;}
.dropzone strong{color:var(--ac);}
#banner-queue{display:flex;flex-direction:column;gap:12px;margin-top:14px;}
.bq-item{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:12px;}
.bq-top{display:flex;align-items:center;gap:10px;margin-bottom:7px;flex-wrap:wrap;}
.bq-thumb{width:75px;height:45px;object-fit:cover;border-radius:5px;border:1px solid var(--border);flex-shrink:0;}
.bq-name{font-size:.8rem;font-weight:600;color:var(--text);flex:1;min-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.bq-status{font-size:.68rem;padding:3px 7px;border-radius:4px;white-space:nowrap;}
.bq-status.pending{background:rgba(255,171,64,.12);color:var(--amber);}
.bq-status.done{background:rgba(92,159,212,.12);color:var(--blue2);}
.ze-outer{width:100%;overflow:auto;max-height:68vh;border-radius:10px;background:#000;border:2px solid rgba(229,57,53,.4);margin-bottom:10px;cursor:crosshair;user-select:none;position:relative;}
.ze-inner{position:relative;display:inline-block;}
#ze-canvas{display:block;}
.drag-rect{position:absolute;border:3px solid #ff5252;background:rgba(229,57,53,.15);pointer-events:none;box-shadow:0 0 0 1px rgba(229,57,53,.4);display:none;}
.drag-label{position:absolute;top:-22px;left:0;background:var(--ac);color:#fff;font-size:.62rem;font-weight:700;padding:2px 6px;border-radius:3px;white-space:nowrap;}
.font-prev-box{background:#0d0d15;border:1px solid var(--border);border-radius:8px;margin-top:8px;min-height:60px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.font-prev-box canvas{display:block;max-width:100%;height:auto;}
.grad-check-label{display:flex;align-items:center;gap:6px;font-size:.77rem;color:var(--muted);cursor:pointer;user-select:none;}
.grad-check-label input[type=checkbox]{accent-color:var(--ac);width:14px;height:14px;}
.ib{background:rgba(229,57,53,.04);border:1px solid rgba(229,57,53,.18);border-radius:8px;padding:10px 14px;font-size:.8rem;color:var(--muted);margin-bottom:12px;line-height:1.7;}
.ib strong{color:var(--ac);}
.ib.blue{background:rgba(92,159,212,.04);border-color:rgba(92,159,212,.18);}
.ib.blue strong{color:var(--blue2);}
.ip{background:#0d0d15;border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:12px;max-height:200px;overflow-y:auto;}
.ip table{font-size:.75rem;}.ip th{background:#141420;padding:5px 9px;}.ip td{padding:5px 9px;}
.tabs{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:13px;}
.tab{padding:5px 12px;border-radius:20px;font-size:.72rem;font-weight:600;cursor:pointer;border:1px solid var(--border);color:var(--muted);transition:all .13s;background:transparent;font-family:'Outfit',sans-serif;}
.tab:hover{border-color:var(--ac);color:var(--ac);}
.tab.on{background:var(--ac);color:#fff;border-color:var(--ac);}
.tc{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;transition:border-color .2s;}
.tc:hover{border-color:rgba(229,57,53,.3);}
.tc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:9px;flex-wrap:wrap;}
.tc pre{white-space:pre-wrap;font-family:'Outfit',sans-serif;font-size:.79rem;color:var(--text);line-height:1.65;max-height:85px;overflow:hidden;position:relative;}
.tc pre::after{content:'';position:absolute;bottom:0;left:0;right:0;height:20px;background:linear-gradient(transparent,var(--card2));}
.reg-card{background:var(--card2);border:1px solid rgba(255,171,64,.3);border-radius:10px;padding:14px;margin-bottom:10px;}
#login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--dark);z-index:999;}
.lc{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:40px;width:100%;max-width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.7);}
.ll{font-family:'Bebas Neue',sans-serif;font-size:2.4rem;letter-spacing:3px;}
.ll span{color:var(--ac);}
.ls{font-size:.8rem;color:var(--muted);margin-bottom:26px;letter-spacing:1px;}
.le{color:var(--red);font-size:.77rem;margin-bottom:9px;padding:7px 11px;background:rgba(255,82,82,.1);border-radius:6px;display:none;}
#toast{position:fixed;bottom:24px;right:24px;z-index:9999;padding:9px 18px;border-radius:30px;font-weight:700;font-size:.81rem;opacity:0;transform:translateY(12px);transition:all .28s;pointer-events:none;}
#toast.on{opacity:1;transform:translateY(0);}
.prog-bar{width:100%;background:var(--card2);border-radius:4px;height:5px;margin-top:7px;overflow:hidden;}
.prog-fill{height:100%;background:var(--ac);transition:width .3s;border-radius:4px;}
.cd-warn{font-size:.68rem;color:var(--amber);font-weight:700;margin-top:2px;}
.saving-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;display:flex;align-items:center;justify-content:center;display:none;}
.saving-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:28px 36px;text-align:center;}
.saving-box .sb-icon{font-size:2rem;margin-bottom:8px;}
.saving-box .sb-msg{font-size:.88rem;color:var(--muted);}
@media(max-width:700px){.sidebar{width:200px;}.main{margin-left:200px;padding:16px;}}
@media(max-width:560px){.wrap{flex-direction:column;}.sidebar{position:relative;width:100%;height:auto;}.main{margin-left:0;}}
</style>
</head>
<body>

<div id="login-screen">
  <div class="lc">
    <div class="ll"><span>MEGA</span>PARI</div>
    <div class="ls">Admin Panel â€” Cloud Connected</div>
    <div class="fg" style="text-align:left;margin-bottom:12px">
      <label>Password</label>
      <input type="password" id="pw-in" placeholder="Enter admin password" onkeydown="if(event.key==='Enter')doLogin()"/>
    </div>
    <div class="le" id="pw-err">âŒ Incorrect password</div>
    <button class="btn g" style="width:100%;justify-content:center;padding:11px" onclick="doLogin()">ENTER â†’</button>
    <p style="margin-top:12px;font-size:.68rem;color:var(--muted)">Default: <strong style="color:var(--text)">admin123</strong></p>
  </div>
</div>

<div id="saving-overlay" class="saving-overlay">
  <div class="saving-box">
    <div class="sb-icon">â˜ï¸</div>
    <div class="sb-msg" id="saving-msg">Saving to cloudâ€¦</div>
    <div class="prog-bar" style="margin-top:12px;width:200px"><div class="prog-fill" id="saving-fill" style="width:0"></div></div>
  </div>
</div>

<div class="wrap" id="panel" style="display:none">
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-t" onclick="window.open('index.html','_blank')">MEGA<span>PARI</span></div>
      <div class="logo-s">Admin Panel</div>
      <div class="cloud-status cs-ok" id="cloud-status">â˜ï¸ Cloud Connected</div>
    </div>
    <div class="nav on" onclick="go('affiliates',this)">ğŸ‘¥ Affiliates</div>
    <div class="nav" onclick="go('banners',this)">ğŸ–¼ï¸ Banners</div>
    <div class="nav" onclick="go('texts',this)">âœï¸ Post Captions</div>
    <div class="nav" onclick="go('download',this)">ğŸ“¥ Bulk Download</div>
    <div class="nav" id="nav-regs" onclick="go('registrations',this)">ğŸ“‹ Registrations <span class="nav-badge" id="reg-badge" style="display:none">0</span></div>
    <div class="nav-sep"></div>
    <div class="nav" onclick="go('settings',this)">âš™ï¸ Settings</div>
    <div class="nav" onclick="window.open('index.html','_blank')">ğŸ”— View Portal</div>
    <div class="nav" onclick="doLogout()">ğŸšª Logout</div>
  </nav>

  <main class="main">

    <!-- AFFILIATES -->
    <div class="page on" id="page-affiliates">
      <div class="ph"><h1>ğŸ‘¥ AFFILIATES</h1><p>All data saves to cloud â€” accessible from any device instantly</p></div>
      <div class="card">
        <div class="card-title">â• <span id="aff-form-title">Add Affiliate</span></div>
        <input type="hidden" id="aff-orig-id">
        <div class="row">
          <div class="fg"><label>Affiliate ID *</label><input type="text" id="a-id" placeholder="AFF12345"/></div>
          <div class="fg"><label>Display Name</label><input type="text" id="a-name" placeholder="John Doe"/></div>
          <div class="fg"><label>Promo Code *</label><input type="text" id="a-promo" placeholder="JOHN50"/></div>
        </div>
        <div class="row">
          <div class="fg"><label>Player / Referral Link</label><input type="text" id="a-player" placeholder="https://..."/></div>
          <div class="fg"><label>Android APK Link</label><input type="text" id="a-apk" placeholder="https://..."/></div>
          <div class="fg"><label>iOS App Link</label><input type="text" id="a-ios" placeholder="https://..."/></div>
        </div>
        <div class="row">
          <div class="fg"><label>Language</label>
            <select id="a-lang"><option value="en">ğŸ‡¬ğŸ‡§ English</option><option value="fr">ğŸ‡«ğŸ‡· French</option><option value="ar">ğŸ‡¸ğŸ‡¦ Arabic</option><option value="es">ğŸ‡ªğŸ‡¸ Spanish</option><option value="pt">ğŸ‡§ğŸ‡· Portuguese</option></select>
          </div>
        </div>
        <div class="br"><button class="btn g" onclick="saveAff()">ğŸ’¾ Save Affiliate</button><button class="btn o" onclick="clearAff()">âœ• Clear</button></div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“Š Bulk Import from Excel</div>
        <div class="ib">Columns: <strong>A</strong>=ID Â· <strong>B</strong>=Name Â· <strong>C</strong>=Promo Code Â· <strong>D</strong>=Player Link Â· <strong>E</strong>=APK Â· <strong>F</strong>=iOS Â· <strong>G</strong>=Language</div>
        <div class="dropzone" onclick="document.getElementById('xl-in').click()"><div class="dz-icon">ğŸ“‚</div><p><strong>Click to choose Excel file</strong><br>.xlsx or .xls</p></div>
        <input type="file" id="xl-in" accept=".xlsx,.xls" style="display:none" onchange="xlImport()"/>
        <div id="xl-prev" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap;gap:8px">
            <span id="xl-count" style="color:var(--ac);font-weight:700;font-size:.85rem"></span>
            <div class="br"><button class="btn g sm" onclick="xlConfirm()">âœ… Import All</button><button class="btn r sm" onclick="xlCancel()">âœ• Cancel</button></div>
          </div>
          <div class="ip" id="xl-table"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ All Affiliates (<span id="aff-cnt">0</span>)</div>
        <div class="tw"><table><thead><tr><th>ID</th><th>Name</th><th>Promo</th><th>Lang</th><th>Player Link</th><th>Portal Link</th><th>Actions</th></tr></thead><tbody id="aff-tbody"><tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">Loadingâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- BANNERS -->
    <div class="page" id="page-banners">
      <div class="ph"><h1>ğŸ–¼ï¸ BANNERS</h1><p>Upload banners â€” set promo code zone â€” auto-removed 35h after expiry</p></div>
      <div class="card">
        <div class="card-title">âš™ï¸ Batch Settings</div>
        <div class="row">
          <div class="fg"><label>Language *</label>
            <select id="ban-lang"><option value="en">English</option><option value="fr">French</option><option value="ar">Arabic</option><option value="es">Spanish</option><option value="pt">Portuguese</option></select>
          </div>
          <div class="fg"><label>Banner Type *</label>
            <select id="ban-type" onchange="toggleDates()"><option value="dated">ğŸ“… Dated (has expiry)</option><option value="evergreen">â™¾ï¸ Evergreen</option></select>
          </div>
          <div class="fg" id="sg-start"><label>Start Date</label><input type="date" id="ban-start"/></div>
          <div class="fg" id="sg-end"><label>End Date</label><input type="date" id="ban-end"/></div>
        </div>
        <div class="ib" style="margin-bottom:0">ğŸ“Œ Dated banners auto-remove <strong>35 hours</strong> after end date. Users see a live countdown timer.</div>
      </div>
      <div class="card">
        <div class="card-title">â¬†ï¸ Upload Images</div>
        <div class="dropzone" id="banner-dz" onclick="document.getElementById('ban-files').click()" ondragover="dzDrag(event,true)" ondragleave="dzDrag(event,false)" ondrop="dzDrop(event)">
          <div class="dz-icon">ğŸ–¼ï¸</div><p><strong>Click or drag & drop</strong><br>PNG / JPG â€” multiple files at once</p>
        </div>
        <input type="file" id="ban-files" accept="image/*" multiple style="display:none" onchange="addBanners()"/>
        <div id="banner-queue"></div>
        <div class="br" style="margin-top:12px;display:none" id="save-all-row">
          <button class="btn g" onclick="saveAllBanners()">ğŸ’¾ Save All to Cloud</button>
          <button class="btn r" onclick="clearQueue()">ğŸ—‘ï¸ Clear Queue</button>
          <span id="save-prog" style="font-size:.79rem;color:var(--muted)"></span>
        </div>
      </div>

      <!-- Zone editor -->
      <div id="zone-editor" style="display:none">
        <div class="card" style="border-color:rgba(229,57,53,.5)">
          <div class="card-title" style="margin-bottom:7px">ğŸ¯ Set Promo Zone â€” <span id="ze-banner-name" style="color:var(--text);text-transform:none;letter-spacing:0;font-weight:400"></span></div>
          <div class="ib" style="margin-bottom:9px"><strong>Drag a rectangle</strong> on the image to mark where the promo code will appear. Text auto-fits to fill the zone perfectly.</div>
          <div class="ze-outer" id="ze-outer"><div class="ze-inner" id="ze-inner"><canvas id="ze-canvas"></canvas><div class="drag-rect" id="drag-rect"><div class="drag-label">PROMO CODE ZONE</div></div></div></div>
          <div id="ze-controls" style="display:none">
            <div class="row" style="margin-top:11px">
              <div class="fg">
                <label>Font Family</label>
                <select id="ze-font" onchange="updateFontPreview()">
                  <option value="Bebas Neue">Bebas Neue</option><option value="Anton">Anton</option>
                  <option value="Russo One">Russo One</option><option value="Teko">Teko Bold</option>
                  <option value="Barlow Condensed">Barlow Condensed</option><option value="Black Han Sans">Black Han Sans</option>
                  <option value="Arial Black">Arial Black</option><option value="Impact">Impact</option>
                </select>
              </div>
              <div class="fg">
                <label>Font Size (px) <span style="color:var(--blue2);font-size:.58rem">â€” ignored if Auto-fit on</span></label>
                <input type="number" id="ze-size" value="36" min="6" max="400" onchange="updateFontPreview()"/>
              </div>
              <div class="fg">
                <label>Text Align</label>
                <select id="ze-align" onchange="updateFontPreview()"><option value="center">Center</option><option value="left">Left</option><option value="right">Right</option></select>
              </div>
            </div>
            <div style="margin-bottom:12px">
              <label class="grad-check-label"><input type="checkbox" id="ze-autofit" checked onchange="updateFontPreview()"/><strong style="color:var(--blue2)">Auto-fit text to zone</strong> â€” text automatically resizes to fill the marked area</label>
            </div>
            <div class="row" style="margin-bottom:6px">
              <div class="fg"><label>Text Color</label><input type="color" id="ze-color" value="#ffffff" onchange="updateFontPreview()"/></div>
              <div class="fg">
                <label>Gradient Fill</label>
                <div style="margin-top:6px"><label class="grad-check-label"><input type="checkbox" id="ze-gradient" onchange="toggleGradUI()"/>Enable gradient</label></div>
              </div>
              <div class="fg" id="grad-c2" style="display:none"><label>Gradient End Color</label><input type="color" id="ze-color2" value="#ff9800" onchange="updateFontPreview()"/></div>
              <div class="fg" id="grad-dir" style="display:none"><label>Direction</label>
                <select id="ze-grad-dir" onchange="updateFontPreview()"><option value="lr">Left â†’ Right</option><option value="tb">Top â†’ Bottom</option><option value="diag">Diagonal</option></select>
              </div>
            </div>
            <div class="font-prev-box" id="font-preview-wrap"><canvas id="font-preview" width="400" height="70"></canvas></div>
            <div class="fg" style="margin-top:9px;margin-bottom:11px">
              <label>Zone (set by drag)</label>
              <input type="text" id="ze-info" readonly style="cursor:default;font-size:.74rem;color:var(--muted)"/>
            </div>
          </div>
          <div class="br">
            <button class="btn g" onclick="confirmZone()">âœ… Confirm Zone</button>
            <button class="btn o" onclick="clearZoneRect()">â†©ï¸ Redo Zone</button>
            <button class="btn r sm" onclick="closeZoneEditor()">âœ• Close</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">ğŸ“‹ Saved Banners (<span id="ban-cnt">0</span>)</div>
        <div class="tw"><table><thead><tr><th>Preview</th><th>Type</th><th>Language</th><th>Dates / Countdown</th><th>Promo Zone</th><th>Assigned Caption</th><th>Actions</th></tr></thead><tbody id="ban-tbody"><tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">Loadingâ€¦</td></tr></tbody></table></div>
      </div>
    </div>

    <!-- TEXTS -->
    <div class="page" id="page-texts">
      <div class="ph"><h1>âœï¸ POST CAPTIONS</h1><p>Manage caption templates for all languages</p></div>
      <div class="card">
        <div class="card-title"><span id="txt-icon">â•</span> <span id="txt-title">Add Caption</span></div>
        <input type="hidden" id="txt-edit-id">
        <div class="ib">Placeholders: <strong>{{Player link}}</strong> Â· <strong>{{apk link}}</strong> Â· <strong>{{iOS link}}</strong> Â· <strong>{{Promo code}}</strong></div>
        <div class="row"><div class="fg"><label>Language *</label>
          <select id="txt-lang"><option value="en">ğŸ‡¬ğŸ‡§ English</option><option value="fr">ğŸ‡«ğŸ‡· French</option><option value="ar">ğŸ‡¸ğŸ‡¦ Arabic</option><option value="es">ğŸ‡ªğŸ‡¸ Spanish</option><option value="pt">ğŸ‡§ğŸ‡· Portuguese</option></select>
        </div></div>
        <div class="fg" style="margin-bottom:12px"><label>Caption Text</label><textarea id="txt-body" rows="8"></textarea></div>
        <div class="br">
          <button class="btn g" onclick="saveTxt()">ğŸ’¾ Save Caption</button>
          <button class="btn o" onclick="clearTxt()">âœ• Clear</button>
          <span id="txt-edit-note" style="display:none;font-size:.75rem;color:var(--amber)">âœï¸ Editing â€” Save to update</span>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“Š Bulk Import Captions from Excel</div>
        <div class="ib">
          Excel format: <strong>Column A</strong> = Post Name/Label Â· <strong>B</strong> = EN Â· <strong>C</strong> = FR Â· <strong>D</strong> = AR Â· <strong>E</strong> = ES Â· <strong>F</strong> = PT<br>
          Each row = one post template. Leave a cell blank to skip that language.
        </div>
        <div class="dropzone" onclick="document.getElementById('txt-xl-in').click()"><div class="dz-icon">ğŸ“Š</div><p><strong>Click to import captions Excel</strong><br>Columns: POST | EN | FR | AR | ES | PT</p></div>
        <input type="file" id="txt-xl-in" accept=".xlsx,.xls" style="display:none" onchange="txtXlImport()"/>
        <div id="txt-xl-prev" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap;gap:8px">
            <span id="txt-xl-count" style="color:var(--ac);font-weight:700;font-size:.85rem"></span>
            <div class="br"><button class="btn g sm" onclick="txtXlConfirm()">âœ… Import</button><button class="btn r sm" onclick="txtXlCancel()">âœ• Cancel</button></div>
          </div>
          <div class="ip" id="txt-xl-table"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“‹ All Captions (<span id="txt-cnt">0</span>)</div>
        <div class="tabs">
          <button class="tab on" onclick="filterTxt('all',this)">All</button>
          <button class="tab" onclick="filterTxt('en',this)">ğŸ‡¬ğŸ‡§ EN</button>
          <button class="tab" onclick="filterTxt('fr',this)">ğŸ‡«ğŸ‡· FR</button>
          <button class="tab" onclick="filterTxt('ar',this)">ğŸ‡¸ğŸ‡¦ AR</button>
          <button class="tab" onclick="filterTxt('es',this)">ğŸ‡ªğŸ‡¸ ES</button>
          <button class="tab" onclick="filterTxt('pt',this)">ğŸ‡§ğŸ‡· PT</button>
        </div>
        <div id="txt-list"></div>
      </div>
    </div>

    <!-- BULK DOWNLOAD -->
    <div class="page" id="page-download">
      <div class="ph"><h1>ğŸ“¥ BULK DOWNLOAD</h1><p>Download affiliates' banners with promo codes stamped</p></div>
      <div class="card">
        <div class="card-title">âš™ï¸ Filters</div>
        <div class="ib blue">Banners match affiliates by <strong>language</strong>. Files named: <strong>PROMOCODE_START_to_END.png</strong></div>
        <div class="row">
          <div class="fg"><label>Language</label><select id="dl-lang" onchange="populateDlAffs()"><option value="all">All</option><option value="en">English</option><option value="fr">French</option><option value="ar">Arabic</option><option value="es">Spanish</option><option value="pt">Portuguese</option></select></div>
          <div class="fg"><label>Banner Type</label><select id="dl-type"><option value="all">All</option><option value="dated">Dated</option><option value="evergreen">Evergreen</option></select></div>
          <div class="fg"><label>Affiliate</label><select id="dl-aff"><option value="all">All</option></select></div>
          <div class="fg"><label>ZIP Structure</label><select id="dl-structure"><option value="flat">One ZIP</option><option value="perAff">Per affiliate</option></select></div>
        </div>
        <div class="br">
          <button class="btn g" onclick="startBulkDownload()">ğŸ“¦ Generate & Download</button>
          <button class="btn b" onclick="previewDownload()">ğŸ‘ Preview List</button>
        </div>
        <div id="dl-progress" style="display:none;margin-top:13px">
          <div style="font-size:.8rem;color:var(--muted);margin-bottom:5px" id="dl-prog-text">Preparingâ€¦</div>
          <div class="prog-bar"><div class="prog-fill" id="dl-prog-fill" style="width:0"></div></div>
        </div>
        <div id="dl-preview-list" style="margin-top:13px;display:none"></div>
      </div>
    </div>

    <!-- REGISTRATIONS -->
    <div class="page" id="page-registrations">
      <div class="ph"><h1>ğŸ“‹ SELF-REGISTRATIONS</h1><p>Users who registered on the portal â€” approve to activate their account</p></div>
      <div class="card">
        <div class="card-title">â³ Pending Approvals (<span id="pending-cnt">0</span>)</div>
        <div id="pending-list"><div style="color:var(--muted);text-align:center;padding:24px">No pending registrations</div></div>
      </div>
      <div class="card">
        <div class="card-title">âœ… Approved (<span id="approved-cnt">0</span>)</div>
        <div id="approved-list"></div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="page" id="page-settings">
      <div class="ph"><h1>âš™ï¸ SETTINGS</h1></div>
      <div class="card">
        <div class="card-title">ğŸ” Change Admin Password</div>
        <div class="row">
          <div class="fg"><label>Current</label><input type="password" id="cur-pw"/></div>
          <div class="fg"><label>New (min 4)</label><input type="password" id="new-pw"/></div>
          <div class="fg"><label>Confirm</label><input type="password" id="conf-pw"/></div>
        </div>
        <button class="btn g" onclick="changePw()">ğŸ”’ Update Password</button>
      </div>
      <div class="card">
        <div class="card-title">ğŸ’¾ Data Backup</div>
        <p style="color:var(--muted);font-size:.82rem;margin-bottom:14px">Export all cloud data as a JSON backup file.</p>
        <div class="br">
          <button class="btn g" onclick="exportData()">ğŸ“¤ Export Backup</button>
          <button class="btn a" onclick="document.getElementById('imp-in').click()">ğŸ“¥ Import Backup</button>
          <button class="btn r" onclick="clearAll()">ğŸ—‘ï¸ Clear All Data</button>
        </div>
        <input type="file" id="imp-in" accept=".json" style="display:none" onchange="importData()"/>
      </div>
      <div class="card">
        <div class="card-title">ğŸ“Š Stats</div>
        <div id="stats-area" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:11px;margin-top:4px"></div>
      </div>
    </div>
  </main>
</div>
<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOUD STORAGE â€” window.storage (shared=true = cross-device)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLOUD={
  async get(k){
    try{const r=await window.storage.get(k,true);return r?JSON.parse(r.value):null;}
    catch(e){return null;}
  },
  async set(k,v){
    try{await window.storage.set(k,JSON.stringify(v),true);return true;}
    catch(e){console.error('cloud set error',k,e);return false;}
  },
  async del(k){
    try{await window.storage.delete(k,true);return true;}
    catch(e){return false;}
  }
};

// Keys
const K={
  pw:'mp:adminpw',
  affs:'mp:affiliates',
  banners:'mp:banners',
  texts:'mp:texts',
  regs:'mp:pendingregs',
  approvedregs:'mp:approvedregs',
  img:id=>'mp:img:'+id
};

// â”€â”€ Cache helpers (avoid repeated cloud reads) â”€â”€
let _cache={};
async function cGet(k,def){
  if(_cache[k]!==undefined)return _cache[k];
  const v=await CLOUD.get(k);
  _cache[k]=v!==null?v:def;
  return _cache[k];
}
async function cSet(k,v){
  _cache[k]=v;
  return CLOUD.set(k,v);
}

function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8);}
const LS_LANGS={en:'English',fr:'French',ar:'Arabic',es:'Spanish',pt:'Portuguese'};

// â”€â”€ Saving overlay â”€â”€
function showSaving(msg,pct){
  const o=document.getElementById('saving-overlay');
  o.style.display='flex';
  document.getElementById('saving-msg').textContent=msg||'Saving to cloudâ€¦';
  document.getElementById('saving-fill').style.width=(pct||30)+'%';
}
function hideSaving(){document.getElementById('saving-overlay').style.display='none';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin(){
  const pw=document.getElementById('pw-in').value;
  const stored=(await CLOUD.get(K.pw))||'admin123';
  if(pw===stored){
    document.getElementById('login-screen').style.display='none';
    document.getElementById('panel').style.display='flex';
    initPanel();
  } else {
    const el=document.getElementById('pw-err');el.style.display='block';
    setTimeout(()=>el.style.display='none',3000);
  }
}
document.getElementById('pw-in').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
function doLogout(){document.getElementById('login-screen').style.display='flex';document.getElementById('panel').style.display='none';document.getElementById('pw-in').value='';_cache={};}

async function initPanel(){
  await ensureDefTxts();
  renderAffs();renderBanners();renderTxts();renderRegs();updateRegBadge();
  // Test cloud connection
  try{
    await CLOUD.get(K.pw);
    document.getElementById('cloud-status').className='cloud-status cs-ok';
    document.getElementById('cloud-status').textContent='â˜ï¸ Cloud Connected';
  }catch(e){
    document.getElementById('cloud-status').className='cloud-status cs-err';
    document.getElementById('cloud-status').textContent='âš ï¸ Cloud Error';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(p,el){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.nav').forEach(x=>x.classList.remove('on'));
  document.getElementById('page-'+p).classList.add('on');
  if(el)el.classList.add('on');
  if(p==='settings')renderStats();
  if(p==='texts'){txtFilter='all';renderTxts();}
  if(p==='banners')renderBanners();
  if(p==='download')populateDlAffs();
  if(p==='registrations')renderRegs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AFFILIATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveAff(){
  const origId=document.getElementById('aff-orig-id').value;
  const id=document.getElementById('a-id').value.trim();
  const promo=document.getElementById('a-promo').value.trim();
  if(!id||!promo){toast('ID and Promo Code required','err');return;}
  showSaving('Saving affiliateâ€¦',40);
  let affs=await cGet(K.affs,[])||[];
  const obj={id,name:document.getElementById('a-name').value.trim(),promoCode:promo,
    playerLink:document.getElementById('a-player').value.trim(),
    apkLink:document.getElementById('a-apk').value.trim(),
    iosLink:document.getElementById('a-ios').value.trim(),
    lang:document.getElementById('a-lang').value};
  if(origId){affs=affs.map(a=>a.id===origId?obj:a);}
  else{if(affs.find(a=>a.id.toLowerCase()===id.toLowerCase())){hideSaving();toast('ID already exists','err');return;}affs.push(obj);}
  await cSet(K.affs,affs);
  hideSaving();clearAff();renderAffs();toast('âœ… Saved to cloud!');
}
function clearAff(){['a-id','a-name','a-promo','a-player','a-apk','a-ios'].forEach(f=>document.getElementById(f).value='');document.getElementById('aff-orig-id').value='';document.getElementById('aff-form-title').textContent='Add Affiliate';}
async function editAff(id){
  const affs=await cGet(K.affs,[])||[];
  const a=affs.find(x=>x.id===id);if(!a)return;
  document.getElementById('aff-orig-id').value=a.id;
  document.getElementById('a-id').value=a.id;
  document.getElementById('a-name').value=a.name||'';
  document.getElementById('a-promo').value=a.promoCode||'';
  document.getElementById('a-player').value=a.playerLink||'';
  document.getElementById('a-apk').value=a.apkLink||'';
  document.getElementById('a-ios').value=a.iosLink||'';
  document.getElementById('a-lang').value=a.lang||'en';
  document.getElementById('aff-form-title').textContent='Edit: '+id;
  window.scrollTo({top:0,behavior:'smooth'});
}
async function delAff(id){
  if(!confirm('Delete "'+id+'"?'))return;
  showSaving('Deletingâ€¦',40);
  const affs=await cGet(K.affs,[])||[];
  await cSet(K.affs,affs.filter(a=>a.id!==id));
  hideSaving();renderAffs();toast('Deleted');
}
function getShareLink(affId){
  return window.location.href.replace('admin.html','index.html')+'?aff='+encodeURIComponent(affId);
}
async function renderAffs(){
  const affs=await cGet(K.affs,[])||[];
  document.getElementById('aff-cnt').textContent=affs.length;
  const tb=document.getElementById('aff-tbody');
  if(!affs.length){tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">No affiliates yet</td></tr>';return;}
  tb.innerHTML=affs.map(a=>{
    const link=getShareLink(a.id);
    return`<tr>
      <td><strong style="color:var(--ac)">${eh(a.id)}</strong></td>
      <td>${eh(a.name||'â€”')}</td>
      <td><span class="bx bx-r">${eh(a.promoCode)}</span></td>
      <td><span class="bx bx-b">${LS_LANGS[a.lang]||a.lang}</span></td>
      <td style="font-size:.72rem">${a.playerLink?`<a href="${eh(a.playerLink)}" target="_blank" style="color:var(--muted)">â†— link</a>`:'â€”'}</td>
      <td><div style="display:flex;align-items:center;gap:5px">
        <input type="text" value="${eh(link)}" readonly style="font-size:.65rem;padding:3px 7px;width:150px;color:var(--muted)" onclick="this.select()"/>
        <button class="btn b sm" onclick="navigator.clipboard.writeText('${ea(link)}').then(()=>toast('Copied!'))">ğŸ“‹</button>
      </div></td>
      <td><div class="br"><button class="btn a sm" onclick="editAff('${ea(a.id)}')">âœï¸</button><button class="btn r sm" onclick="delAff('${ea(a.id)}')">ğŸ—‘ï¸</button></div></td>
    </tr>`;
  }).join('');
}

// Excel import for affiliates
let xlRows=[];
function xlImport(){
  const file=document.getElementById('xl-in').files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const wb=XLSX.read(e.target.result,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      const isHdr=r=>r[0]&&String(r[0]).toLowerCase().match(/id|affiliate|name/);
      const data=rows.filter((r,i)=>!(i===0&&isHdr(r))).filter(r=>String(r[0]||'').trim());
      xlRows=data.map(r=>({id:String(r[0]||'').trim(),name:String(r[1]||'').trim(),promoCode:String(r[2]||'').trim(),playerLink:String(r[3]||'').trim(),apkLink:String(r[4]||'').trim(),iosLink:String(r[5]||'').trim(),lang:String(r[6]||'en').trim().toLowerCase()||'en'})).filter(r=>r.id&&r.promoCode);
      if(!xlRows.length){toast('No valid rows','err');return;}
      document.getElementById('xl-count').textContent=`âœ… ${xlRows.length} ready`;
      document.getElementById('xl-table').innerHTML=`<table><thead><tr><th>ID</th><th>Name</th><th>Promo</th><th>Lang</th></tr></thead><tbody>${xlRows.slice(0,15).map(r=>`<tr><td>${eh(r.id)}</td><td>${eh(r.name||'â€”')}</td><td>${eh(r.promoCode)}</td><td>${eh(r.lang)}</td></tr>`).join('')}</tbody></table>`;
      document.getElementById('xl-prev').style.display='block';
    }catch(err){toast('Error: '+err.message,'err');}
  };
  reader.readAsArrayBuffer(file);
}
async function xlConfirm(){
  showSaving('Importing affiliatesâ€¦',20);
  let affs=await cGet(K.affs,[])||[];
  let added=0,upd=0;
  xlRows.forEach(r=>{const i=affs.findIndex(a=>a.id.toLowerCase()===r.id.toLowerCase());if(i>=0){affs[i]=r;upd++;}else{affs.push(r);added++;}});
  await cSet(K.affs,affs);
  xlCancel();hideSaving();renderAffs();toast(`âœ… ${added} added, ${upd} updated`);
}
function xlCancel(){xlRows=[];document.getElementById('xl-in').value='';document.getElementById('xl-prev').style.display='none';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BANNERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let queue=[];
let activeQIdx=null;
let zeState={isDragging:false,start:{x:0,y:0},zone:null};
let zeScale=1;
let _zeL={};

function dzDrag(e,on){e.preventDefault();document.getElementById('banner-dz').classList.toggle('drag',on);}
function dzDrop(e){e.preventDefault();document.getElementById('banner-dz').classList.remove('drag');handleFiles(e.dataTransfer.files);}
function addBanners(){handleFiles(document.getElementById('ban-files').files);}

function handleFiles(files){
  if(!files||!files.length)return;
  let loaded=0;
  const total=files.length;
  Array.from(files).forEach(f=>{
    if(!f.type.startsWith('image/'))return;
    const id=uid();
    const entry={id,name:f.name,dataURL:null,zone:null,status:'pending'};
    queue.push(entry);
    const reader=new FileReader();
    reader.onload=ev=>{
      entry.dataURL=ev.target.result;
      loaded++;
      renderQueue();
    };
    reader.readAsDataURL(f);
  });
  renderQueue();
}

function renderQueue(){
  const qEl=document.getElementById('banner-queue');
  const saveRow=document.getElementById('save-all-row');
  if(!queue.length){qEl.innerHTML='';saveRow.style.display='none';return;}
  saveRow.style.display='flex';
  qEl.innerHTML=queue.map((item,i)=>`
    <div class="bq-item">
      <div class="bq-top">
        ${item.dataURL?`<img class="bq-thumb" src="${item.dataURL}"/>`:'<div class="bq-thumb" style="background:var(--card);display:flex;align-items:center;justify-content:center;font-size:.7rem;color:var(--muted)">â€¦</div>'}
        <span class="bq-name">${eh(item.name)}</span>
        <span class="bq-status ${item.dataURL?item.status:'pending'}">${!item.dataURL?'â³ Loadingâ€¦':item.status==='pending'?'â³ Pending':'âœ… Zone Set'}</span>
        <div class="br" style="margin:0">
          ${item.dataURL?`<button class="btn ${item.zone?'a':'g'} sm" onclick="openZoneEditor(${i})">${item.zone?'âœï¸ Edit Zone':'ğŸ¯ Set Zone'}</button>`:''}
          <button class="btn r sm" onclick="removeFromQueue(${i})">âœ•</button>
        </div>
      </div>
      ${item.zone?`<div style="font-size:.71rem;color:var(--blue2);padding:2px 0">âœ… Zone: ${item.zone.x},${item.zone.y} ${item.zone.w}Ã—${item.zone.h}px Â· ${item.zone.font} Â· ${item.zone.autofit?'Auto-fit':'Size '+item.zone.size+'px'} Â· ${item.zone.gradient?'Gradient':'Solid'}</div>`:'<div style="font-size:.71rem;color:var(--amber);padding:2px 0">âš ï¸ No zone set â€” will save without promo overlay</div>'}
    </div>`).join('');
}
function removeFromQueue(i){queue.splice(i,1);if(activeQIdx===i){closeZoneEditor();} renderQueue();}
function clearQueue(){queue=[];renderQueue();closeZoneEditor();}

// â”€â”€ ZONE EDITOR â”€â”€
function openZoneEditor(i){
  if(!queue[i]||!queue[i].dataURL){toast('Image not ready yet','err');return;}
  activeQIdx=i;
  const item=queue[i];
  const edEl=document.getElementById('zone-editor');
  edEl.style.display='block';
  setTimeout(()=>edEl.scrollIntoView({behavior:'smooth',block:'start'}),50);
  document.getElementById('ze-banner-name').textContent=item.name;
  document.getElementById('ze-controls').style.display='none';
  document.getElementById('drag-rect').style.display='none';
  zeState={isDragging:false,start:{x:0,y:0},zone:null};
  drawZECanvas(item);
  if(item.zone){
    document.getElementById('ze-font').value=item.zone.font||'Bebas Neue';
    document.getElementById('ze-size').value=item.zone.size||36;
    document.getElementById('ze-color').value=item.zone.color||'#ffffff';
    document.getElementById('ze-align').value=item.zone.align||'center';
    document.getElementById('ze-autofit').checked=item.zone.autofit!==false;
    document.getElementById('ze-gradient').checked=!!item.zone.gradient;
    if(item.zone.gradient){document.getElementById('ze-color2').value=item.zone.color2||'#ff9800';document.getElementById('ze-grad-dir').value=item.zone.gradDir||'lr';toggleGradUI();}
    showZoneRect(item.zone);
    document.getElementById('ze-controls').style.display='block';
    updateFontPreview();
  }
}

function drawZECanvas(item){
  const img=new Image();
  img.onload=function(){
    const outer=document.getElementById('ze-outer');
    const inner=document.getElementById('ze-inner');
    const canvas=document.getElementById('ze-canvas');
    const availW=Math.max(300,(outer.clientWidth||600)-4);
    zeScale=Math.min(1,availW/img.width);
    const dW=Math.round(img.width*zeScale),dH=Math.round(img.height*zeScale);
    canvas.width=img.width;canvas.height=img.height;
    canvas.style.width=dW+'px';canvas.style.height=dH+'px';canvas.style.display='block';
    inner.style.width=dW+'px';inner.style.height=dH+'px';
    canvas.getContext('2d').drawImage(img,0,0);
    attachZEDrag(canvas,inner);
  };
  img.onerror=()=>toast('Image load error','err');
  img.src=item.dataURL;
}

function attachZEDrag(canvas,inner){
  if(_zeL.move)document.removeEventListener('mousemove',_zeL.move);
  if(_zeL.up)document.removeEventListener('mouseup',_zeL.up);
  if(_zeL.tm)document.removeEventListener('touchmove',_zeL.tm);
  if(_zeL.tu)document.removeEventListener('touchend',_zeL.tu);
  const rect=document.getElementById('drag-rect');
  function getPos(e){
    const cr=canvas.getBoundingClientRect();
    const src=e.touches?e.touches[0]:e;
    const cx=Math.max(0,Math.min(src.clientX-cr.left,cr.width));
    const cy=Math.max(0,Math.min(src.clientY-cr.top,cr.height));
    return{x:cx/zeScale,y:cy/zeScale};
  }
  function onDown(e){if(e.target!==canvas)return;e.preventDefault();zeState.isDragging=true;zeState.start=getPos(e);zeState.zone=null;rect.style.display='block';rect.style.left='0';rect.style.top='0';rect.style.width='0';rect.style.height='0';document.getElementById('ze-controls').style.display='none';}
  function onMove(e){
    if(!zeState.isDragging)return;e.preventDefault();
    const cur=getPos(e);
    const ix=Math.min(zeState.start.x,cur.x),iy=Math.min(zeState.start.y,cur.y);
    const iw=Math.abs(cur.x-zeState.start.x),ih=Math.abs(cur.y-zeState.start.y);
    zeState.zone={x:Math.round(ix),y:Math.round(iy),w:Math.round(iw),h:Math.round(ih)};
    const cr=canvas.getBoundingClientRect(),ir=inner.getBoundingClientRect();
    rect.style.left=(cr.left-ir.left+ix*zeScale)+'px';rect.style.top=(cr.top-ir.top+iy*zeScale)+'px';
    rect.style.width=(iw*zeScale)+'px';rect.style.height=(ih*zeScale)+'px';
  }
  function onUp(){
    if(!zeState.isDragging)return;zeState.isDragging=false;
    if(zeState.zone&&zeState.zone.w>5&&zeState.zone.h>5){
      document.getElementById('ze-info').value=`X:${zeState.zone.x} Y:${zeState.zone.y} W:${zeState.zone.w} H:${zeState.zone.h}`;
      document.getElementById('ze-controls').style.display='block';
      updateFontPreview();
    }
  }
  canvas.addEventListener('mousedown',onDown);
  canvas.addEventListener('touchstart',e=>{if(e.target===canvas){e.preventDefault();onDown(e);}},{passive:false});
  _zeL.move=onMove;_zeL.up=onUp;
  _zeL.tm=e=>{if(zeState.isDragging){e.preventDefault();onMove(e);}};
  _zeL.tu=onUp;
  document.addEventListener('mousemove',_zeL.move);
  document.addEventListener('mouseup',_zeL.up);
  document.addEventListener('touchmove',_zeL.tm,{passive:false});
  document.addEventListener('touchend',_zeL.tu);
}

function showZoneRect(z){
  const rect=document.getElementById('drag-rect');
  rect.style.display='block';
  rect.style.left=(z.x*zeScale)+'px';rect.style.top=(z.y*zeScale)+'px';
  rect.style.width=(z.w*zeScale)+'px';rect.style.height=(z.h*zeScale)+'px';
  document.getElementById('ze-info').value=`X:${z.x} Y:${z.y} W:${z.w} H:${z.h}`;
}

function toggleGradUI(){
  const on=document.getElementById('ze-gradient').checked;
  document.getElementById('grad-c2').style.display=on?'':'none';
  document.getElementById('grad-dir').style.display=on?'':'none';
  updateFontPreview();
}

function calcAutoFitSize(ctx,text,zonW,zonH,fontFamily){
  const maxH=Math.min(Math.floor(zonH*1.05),400);
  let lo=6,hi=maxH,best=lo;
  for(let i=0;i<26;i++){
    if(lo>hi)break;
    const mid=Math.floor((lo+hi)/2);
    ctx.font=`bold ${mid}px '${fontFamily}',Arial,sans-serif`;
    const m=ctx.measureText(text);
    const tw=m.width;
    const th=(m.actualBoundingBoxAscent!==undefined)?(m.actualBoundingBoxAscent+m.actualBoundingBoxDescent):mid*1.1;
    if(tw<=zonW&&th<=zonH){best=mid;lo=mid+1;}else{hi=mid-1;}
  }
  return Math.max(best,6);
}

function updateFontPreview(){
  const font=document.getElementById('ze-font').value;
  const manualSize=parseInt(document.getElementById('ze-size').value)||36;
  const color=document.getElementById('ze-color').value;
  const gradient=document.getElementById('ze-gradient').checked;
  const color2=document.getElementById('ze-color2').value;
  const gradDir=document.getElementById('ze-grad-dir').value;
  const autofit=document.getElementById('ze-autofit').checked;
  const align=document.getElementById('ze-align').value;
  const canvas=document.getElementById('font-preview');
  const ctx=canvas.getContext('2d');
  const zW=zeState.zone?Math.max(zeState.zone.w,80):380;
  const zH=zeState.zone?Math.max(zeState.zone.h,40):60;
  canvas.width=Math.max(400,zW);canvas.height=Math.max(70,zH+10);
  ctx.fillStyle='#0d0d15';ctx.fillRect(0,0,canvas.width,canvas.height);
  const sampleText='PROMO50';
  let fsize=manualSize;
  if(autofit)fsize=calcAutoFitSize(ctx,sampleText,canvas.width-20,canvas.height-10,font);
  ctx.font=`bold ${fsize}px '${font}',Arial,sans-serif`;
  if(gradient&&color2){
    const dir=gradDir||'lr';let grd;
    if(dir==='lr')grd=ctx.createLinearGradient(10,0,canvas.width-10,0);
    else if(dir==='tb')grd=ctx.createLinearGradient(0,5,0,canvas.height-5);
    else grd=ctx.createLinearGradient(10,5,canvas.width-10,canvas.height-5);
    grd.addColorStop(0,color);grd.addColorStop(1,color2);ctx.fillStyle=grd;
  } else {ctx.fillStyle=color;}
  ctx.textAlign=align||'center';ctx.textBaseline='middle';
  const tx=align==='left'?12:align==='right'?canvas.width-12:canvas.width/2;
  ctx.fillText(sampleText,tx,canvas.height/2);
}

function confirmZone(){
  const zone=zeState.zone||(()=>{const p=document.getElementById('ze-info').value.match(/X:(\d+) Y:(\d+) W:(\d+) H:(\d+)/);return p?{x:+p[1],y:+p[2],w:+p[3],h:+p[4]}:null;})();
  if(!zone||zone.w<5){toast('Drag a zone on the image first','err');return;}
  zone.font=document.getElementById('ze-font').value;
  zone.size=parseInt(document.getElementById('ze-size').value)||36;
  zone.color=document.getElementById('ze-color').value;
  zone.align=document.getElementById('ze-align').value;
  zone.autofit=document.getElementById('ze-autofit').checked;
  zone.gradient=document.getElementById('ze-gradient').checked;
  zone.color2=document.getElementById('ze-color2').value;
  zone.gradDir=document.getElementById('ze-grad-dir').value;
  if(activeQIdx!==null){queue[activeQIdx].zone=zone;queue[activeQIdx].status='done';}
  closeZoneEditor();renderQueue();toast('âœ… Zone confirmed!');
}
function clearZoneRect(){zeState.zone=null;document.getElementById('drag-rect').style.display='none';document.getElementById('ze-controls').style.display='none';document.getElementById('ze-info').value='';}
function closeZoneEditor(){
  document.getElementById('zone-editor').style.display='none';activeQIdx=null;
  if(_zeL.move)document.removeEventListener('mousemove',_zeL.move);
  if(_zeL.up)document.removeEventListener('mouseup',_zeL.up);
  if(_zeL.tm)document.removeEventListener('touchmove',_zeL.tm);
  if(_zeL.tu)document.removeEventListener('touchend',_zeL.tu);
  _zeL={};
}

// â”€â”€ STAMP (used by bulk download) â”€â”€
function stampCanvas(ctx,banner,promoCode){
  if(!banner.promoConfig||!promoCode)return;
  const pc=banner.promoConfig;
  ctx.save();ctx.beginPath();ctx.rect(pc.x,pc.y,pc.w,pc.h);ctx.clip();
  const ff=pc.font?`'${pc.font}'`:'Arial Black';
  let fsize=pc.size||36;
  if(pc.autofit!==false)fsize=calcAutoFitSize(ctx,promoCode,pc.w,pc.h,pc.font||'Arial Black');
  ctx.font=`bold ${fsize}px ${ff},Arial,sans-serif`;
  if(pc.gradient&&pc.color2){
    const dir=pc.gradDir||'lr';let grd;
    if(dir==='lr')grd=ctx.createLinearGradient(pc.x,pc.y,pc.x+pc.w,pc.y);
    else if(dir==='tb')grd=ctx.createLinearGradient(pc.x,pc.y,pc.x,pc.y+pc.h);
    else grd=ctx.createLinearGradient(pc.x,pc.y,pc.x+pc.w,pc.y+pc.h);
    grd.addColorStop(0,pc.color||'#fff');grd.addColorStop(1,pc.color2);ctx.fillStyle=grd;
  } else {ctx.fillStyle=pc.color||'#ffffff';}
  const align=pc.align||'center';ctx.textAlign=align;ctx.textBaseline='middle';
  const tx=align==='center'?pc.x+pc.w/2:align==='left'?pc.x+4:pc.x+pc.w-4;
  ctx.fillText(promoCode,tx,pc.y+pc.h/2);ctx.restore();
}

// â”€â”€ SAVE ALL BANNERS â”€â”€
async function saveAllBanners(){
  // Check if any banners are ready
  const ready=queue.filter(item=>item.dataURL);
  if(!queue.length){toast('No banners in queue','err');return;}
  if(!ready.length){toast('Please wait for images to finish loading','err');return;}

  const evergreen=document.getElementById('ban-type').value==='evergreen';
  const startDate=document.getElementById('ban-start').value;
  const endDate=document.getElementById('ban-end').value;
  if(!evergreen&&(!startDate||!endDate)){toast('Set start and end dates','err');return;}
  const lang=document.getElementById('ban-lang').value;
  const prog=document.getElementById('save-prog');

  let saved=0;
  let banners=await cGet(K.banners,[])||[];
  const texts=await cGet(K.texts,[])||[];
  const langTexts=texts.filter(t=>t.lang===lang);

  for(let i=0;i<queue.length;i++){
    const item=queue[i];
    if(!item.dataURL){
      toast(`${item.name}: not loaded, skipping`,'err');
      continue;
    }
    try{
      showSaving(`Uploading image ${i+1}/${queue.length} to cloudâ€¦`, Math.round((i/queue.length)*80)+10);
      prog.textContent=`Uploading ${i+1}/${queue.length}â€¦`;

      // Save image to cloud
      const ok=await CLOUD.set(K.img(item.id),item.dataURL);
      if(!ok){
        toast(`Failed to save ${item.name} to cloud`,'err');
        continue;
      }

      const b={
        id:item.id,lang,evergreen,
        startDate:evergreen?null:startDate,endDate:evergreen?null:endDate,
        name:item.name,promoConfig:item.zone||null,
        assignedTextId:langTexts.length?langTexts[saved%langTexts.length].id:null,
        createdAt:Date.now()
      };
      banners.push(b);
      saved++;
    }catch(err){
      toast('Error saving '+item.name+': '+err.message,'err');
    }
  }

  if(saved>0){
    showSaving('Saving banner list to cloudâ€¦',90);
    await cSet(K.banners,banners);
  }

  hideSaving();clearQueue();renderBanners();
  prog.textContent='';
  toast(saved>0?`âœ… ${saved} banner(s) saved to cloud!`:'âŒ No banners saved â€” check errors','err');
}

function toggleDates(){const ev=document.getElementById('ban-type').value==='evergreen';document.getElementById('sg-start').style.display=ev?'none':'';document.getElementById('sg-end').style.display=ev?'none':'';}

// â”€â”€ EXPIRY â”€â”€
function bannerExpired(b){if(b.evergreen||!b.endDate)return false;const e=new Date(b.endDate);e.setHours(23,59,59,999);return Date.now()>e.getTime()+35*3600000;}
function msUntilRemoval(b){if(b.evergreen||!b.endDate)return Infinity;const e=new Date(b.endDate);e.setHours(23,59,59,999);return Math.max(0,e.getTime()+35*3600000-Date.now());}
function fmtCountdown(ms){if(ms<=0)return'Removingâ€¦';const h=Math.floor(ms/3600000),m=Math.floor((ms%3600000)/60000),s=Math.floor((ms%60000)/1000);return`${h}h ${m}m ${s}s until removal`;}

let _cdTimers=[];
async function renderBanners(){
  _cdTimers.forEach(clearInterval);_cdTimers=[];
  let banners=await cGet(K.banners,[])||[];
  // Prune expired
  const active=banners.filter(b=>!bannerExpired(b));
  if(active.length!==banners.length){
    const expired=banners.filter(b=>bannerExpired(b));
    await cSet(K.banners,active);
    delete _cache[K.banners];
    expired.forEach(b=>CLOUD.del(K.img(b.id)).catch(()=>{}));
    banners=active;
  }
  document.getElementById('ban-cnt').textContent=banners.length;
  const tb=document.getElementById('ban-tbody');
  if(!banners.length){tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">No banners saved</td></tr>';return;}
  tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:10px;font-size:.77rem">Loading previewsâ€¦</td></tr>';
  const texts=await cGet(K.texts,[])||[];

  const rows=await Promise.all(banners.map(async b=>{
    let thumbSrc='';
    try{thumbSrc=await CLOUD.get(K.img(b.id))||'';}catch(e){}
    const thumb=thumbSrc
      ?`<img src="${thumbSrc}" style="height:50px;width:80px;object-fit:cover;border-radius:6px;border:1px solid var(--border)"/>`
      :`<div style="width:80px;height:50px;background:var(--card2);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.62rem;color:var(--muted)">No img</div>`;
    const txt=texts.find(t=>t.id===b.assignedTextId);
    const assign=txt?`<span style="font-size:.71rem;color:var(--blue2)">${LS_LANGS[txt.lang]} Caption</span>`:'<span style="color:var(--muted);font-size:.71rem">None</span>';
    const ms=msUntilRemoval(b);
    const cdId='cd-'+b.id;
    const expiryRow=b.evergreen?'No expiry':`${b.startDate} â†’ ${b.endDate}<div class="cd-warn" id="${cdId}">${fmtCountdown(ms)}</div>`;
    return`<tr>
      <td>${thumb}</td>
      <td><span class="bx ${b.evergreen?'bx-a':'bx-r'}">${b.evergreen?'â™¾ï¸':'ğŸ“…'} ${b.evergreen?'Evergreen':'Dated'}</span></td>
      <td>${LS_LANGS[b.lang]||b.lang}</td>
      <td style="font-size:.74rem;color:var(--muted)">${expiryRow}</td>
      <td>${b.promoConfig?'<span class="bx bx-r">âœ“ Set</span>':'<span style="color:var(--muted);font-size:.71rem">None</span>'}</td>
      <td>${assign}
        <select onchange="assignText('${b.id}',this.value)" style="margin-top:4px;font-size:.71rem;padding:3px 6px;background:#0d0d15;border:1px solid var(--border);border-radius:5px;color:var(--text);width:100%">
          <option value="">â€” Assign caption â€”</option>
          ${texts.filter(t=>t.lang===b.lang).map((t,ti)=>`<option value="${t.id}" ${t.id===b.assignedTextId?'selected':''}>${LS_LANGS[t.lang]} #${ti+1}</option>`).join('')}
        </select>
      </td>
      <td><button class="btn r sm" onclick="delBanner('${b.id}')">ğŸ—‘ï¸</button></td>
    </tr>`;
  }));
  tb.innerHTML=rows.join('');
  banners.filter(b=>!b.evergreen).forEach(b=>{
    const el=document.getElementById('cd-'+b.id);if(!el)return;
    const t=setInterval(()=>{const ms2=msUntilRemoval(b);if(ms2<=0){clearInterval(t);renderBanners();return;}el.textContent=fmtCountdown(ms2);},1000);
    _cdTimers.push(t);
  });
}

async function assignText(bannerId,textId){
  let banners=await cGet(K.banners,[])||[];
  const b=banners.find(x=>x.id===bannerId);
  if(b){b.assignedTextId=textId||null;await cSet(K.banners,banners);toast('Caption assigned');}
}
async function delBanner(id){
  if(!confirm('Delete this banner?'))return;
  showSaving('Deletingâ€¦',40);
  let banners=await cGet(K.banners,[])||[];
  await cSet(K.banners,banners.filter(b=>b.id!==id));
  await CLOUD.del(K.img(id));
  hideSaving();renderBanners();toast('Deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEXTS / CAPTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let txtFilter='all';
async function saveTxt(){
  const editId=document.getElementById('txt-edit-id').value;
  const content=document.getElementById('txt-body').value.trim();
  const lang=document.getElementById('txt-lang').value;
  if(!content){toast('Caption text required','err');return;}
  showSaving('Saving captionâ€¦',40);
  let texts=await cGet(K.texts,[])||[];
  const obj={id:editId||uid(),lang,content};
  if(editId)texts=texts.map(t=>t.id===editId?obj:t);else texts.push(obj);
  await cSet(K.texts,texts);
  hideSaving();clearTxt();renderTxts();toast('âœ… Saved!');
}
function clearTxt(){document.getElementById('txt-body').value='';document.getElementById('txt-edit-id').value='';document.getElementById('txt-title').textContent='Add Caption';document.getElementById('txt-icon').textContent='â•';document.getElementById('txt-edit-note').style.display='none';}
async function editTxt(id){
  const texts=await cGet(K.texts,[])||[];
  const t=texts.find(x=>x.id===id);if(!t)return;
  document.getElementById('txt-edit-id').value=t.id;
  document.getElementById('txt-lang').value=t.lang;
  document.getElementById('txt-body').value=t.content;
  document.getElementById('txt-title').textContent='Edit Caption';
  document.getElementById('txt-icon').textContent='âœï¸';
  document.getElementById('txt-edit-note').style.display='inline';
  window.scrollTo({top:0,behavior:'smooth'});
}
async function delTxt(id){
  if(!confirm('Delete?'))return;
  showSaving('Deletingâ€¦',40);
  let texts=await cGet(K.texts,[])||[];
  await cSet(K.texts,texts.filter(t=>t.id!==id));
  hideSaving();renderTxts();toast('Deleted');
}
function filterTxt(lang,el){txtFilter=lang;document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));if(el)el.classList.add('on');renderTxts();}
async function renderTxts(){
  const texts=await cGet(K.texts,[])||[];
  const filtered=txtFilter==='all'?texts:texts.filter(t=>t.lang===txtFilter);
  document.getElementById('txt-cnt').textContent=texts.length;
  const c=document.getElementById('txt-list');
  if(!filtered.length){c.innerHTML='<div style="text-align:center;color:var(--muted);padding:24px">No captions found</div>';return;}
  c.innerHTML=filtered.map((t,i)=>`<div class="tc">
    <div class="tc-top">
      <div style="display:flex;align-items:center;gap:6px"><span class="bx bx-r">${LS_LANGS[t.lang]||t.lang}</span><span style="font-size:.68rem;color:var(--muted)">#${i+1}</span></div>
      <div class="br"><button class="btn a sm" onclick="editTxt('${t.id}')">âœï¸ Edit</button><button class="btn r sm" onclick="delTxt('${t.id}')">ğŸ—‘ï¸</button></div>
    </div><pre>${eh(t.content)}</pre>
  </div>`).join('');
}

// â”€â”€ CAPTION EXCEL IMPORT (POST | EN | FR | AR | ES | PT) â”€â”€
let txtXlRows=[];
function txtXlImport(){
  const file=document.getElementById('txt-xl-in').files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const wb=XLSX.read(e.target.result,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      // Detect header row
      const isHdr=r=>r[0]&&String(r[0]).toLowerCase().match(/post|name|caption|label/);
      const data=rows.filter((r,i)=>!(i===0&&isHdr(r))).filter(r=>String(r[0]||'').trim()||String(r[1]||'').trim());
      // Each row: [postName, EN, FR, AR, ES, PT]
      const langs=['en','fr','ar','es','pt'];
      txtXlRows=[];
      let previewRows=[];
      data.forEach((r,ri)=>{
        const label=String(r[0]||'Post '+(ri+1)).trim();
        const groupId='pg_'+uid();
        langs.forEach((lang,li)=>{
          const content=String(r[li+1]||'').trim();
          if(!content)return;
          txtXlRows.push({id:uid(),lang,content,group:groupId,label});
          previewRows.push({label,lang,content:content.slice(0,40)+'â€¦'});
        });
      });
      if(!txtXlRows.length){toast('No valid caption rows','err');return;}
      document.getElementById('txt-xl-count').textContent=`âœ… ${txtXlRows.length} captions ready (${data.length} post groups)`;
      document.getElementById('txt-xl-table').innerHTML=`<table><thead><tr><th>Post</th><th>Lang</th><th>Preview</th></tr></thead><tbody>${previewRows.slice(0,15).map(r=>`<tr><td>${eh(r.label)}</td><td>${r.lang.toUpperCase()}</td><td>${eh(r.content)}</td></tr>`).join('')}</tbody></table>`;
      document.getElementById('txt-xl-prev').style.display='block';
    }catch(err){toast('Error: '+err.message,'err');}
  };
  reader.readAsArrayBuffer(file);
}
async function txtXlConfirm(){
  showSaving('Importing captionsâ€¦',30);
  let texts=await cGet(K.texts,[])||[];
  let added=0;
  txtXlRows.forEach(r=>{
    if(!texts.find(t=>t.content===r.content&&t.lang===r.lang)){texts.push(r);added++;}
  });
  await cSet(K.texts,texts);
  txtXlCancel();hideSaving();renderTxts();toast(`âœ… ${added} captions imported!`);
}
function txtXlCancel(){txtXlRows=[];document.getElementById('txt-xl-in').value='';document.getElementById('txt-xl-prev').style.display='none';}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULK DOWNLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function populateDlAffs(){
  const dlLang=document.getElementById('dl-lang').value;
  let affs=await cGet(K.affs,[])||[];
  if(dlLang!=='all')affs=affs.filter(a=>a.lang===dlLang);
  const sel=document.getElementById('dl-aff');
  sel.innerHTML='<option value="all">All</option>'+affs.map(a=>`<option value="${ea(a.id)}">${eh(a.id)} â€” ${eh(a.promoCode)}</option>`).join('');
}
async function getDlScope(){
  const dlLang=document.getElementById('dl-lang').value;
  const dlType=document.getElementById('dl-type').value;
  const dlAffId=document.getElementById('dl-aff').value;
  let allAffs=await cGet(K.affs,[])||[];
  let allBanners=await cGet(K.banners,[])||[];
  allBanners=allBanners.filter(b=>!bannerExpired(b));
  if(dlType==='dated')allBanners=allBanners.filter(b=>!b.evergreen);
  if(dlType==='evergreen')allBanners=allBanners.filter(b=>b.evergreen);
  if(dlAffId!=='all')allAffs=allAffs.filter(a=>a.id===dlAffId);
  const pairs=[];
  for(const aff of allAffs){
    const affLang=aff.lang||'en';
    const matchBanners=allBanners.filter(b=>dlLang!=='all'?b.lang===dlLang&&b.lang===affLang:b.lang===affLang);
    for(const b of matchBanners)pairs.push({aff,banner:b});
  }
  return pairs;
}
function makeFilename(promoCode,banner){
  const s=v=>String(v||'').replace(/[^a-zA-Z0-9_\-]/g,'_');
  return banner.evergreen?`${s(promoCode)}_evergreen.png`:`${s(promoCode)}_${s(banner.startDate)}_to_${s(banner.endDate)}.png`;
}
async function previewDownload(){
  const pairs=await getDlScope();
  const prev=document.getElementById('dl-preview-list');prev.style.display='block';
  if(!pairs.length){prev.innerHTML='<div style="color:var(--muted);font-size:.81rem;padding:10px">No matching pairs. Check language settings.</div>';return;}
  prev.innerHTML=`<div style="font-size:.73rem;color:var(--ac);margin-bottom:7px;font-weight:700">${pairs.length} file(s):</div><div style="max-height:200px;overflow-y:auto;background:var(--card2);border-radius:8px;padding:7px 11px">${pairs.map(({aff,banner})=>`<div style="font-size:.76rem;padding:3px 0;border-bottom:1px solid var(--border)"><strong style="color:var(--ac)">${eh(aff.id)}</strong> â†’ <strong style="color:var(--text)">${makeFilename(aff.promoCode,banner)}</strong></div>`).join('')}</div>`;
}
async function startBulkDownload(){
  const pairs=await getDlScope();
  if(!pairs.length){toast('No matching pairs. Check filters.','err');return;}
  const structure=document.getElementById('dl-structure').value;
  const progEl=document.getElementById('dl-progress');
  const progText=document.getElementById('dl-prog-text');
  const progFill=document.getElementById('dl-prog-fill');
  progEl.style.display='block';
  function loadImg(src){return new Promise(res=>{const i=new Image();i.onload=()=>res(i);i.onerror=()=>res(null);i.src=src;});}
  // Cache images from cloud
  const bannerIds=[...new Set(pairs.map(p=>p.banner.id))];
  const imgCache={};
  for(const bid of bannerIds){try{imgCache[bid]=await CLOUD.get(K.img(bid));}catch(e){imgCache[bid]=null;}}
  const total=pairs.length;let done=0;
  async function renderPair(aff,banner){
    const src=imgCache[banner.id];if(!src)return null;
    const img=await loadImg(src);if(!img)return null;
    const c=document.createElement('canvas');c.width=img.width;c.height=img.height;
    const ctx=c.getContext('2d');ctx.drawImage(img,0,0);stampCanvas(ctx,banner,aff.promoCode);
    return new Promise(res=>c.toBlob(res,'image/png'));
  }
  if(structure==='perAff'){
    const byAff={};pairs.forEach(p=>{if(!byAff[p.aff.id])byAff[p.aff.id]={aff:p.aff,pairs:[]};byAff[p.aff.id].pairs.push(p);});
    for(const affId of Object.keys(byAff)){
      const{aff,pairs:ap}=byAff[affId];const zip=new JSZip();
      for(const{banner}of ap){const blob=await renderPair(aff,banner);if(blob)zip.file(makeFilename(aff.promoCode,banner),blob);done++;progText.textContent=`Processing ${done}/${total}â€¦`;progFill.style.width=Math.round(done/total*100)+'%';await new Promise(r=>setTimeout(r,5));}
      const zb=await zip.generateAsync({type:'blob'});const a=document.createElement('a');a.href=URL.createObjectURL(zb);a.download=`megapari_${aff.id}_${aff.promoCode}.zip`;a.click();
      await new Promise(r=>setTimeout(r,400));
    }
  } else {
    const zip=new JSZip();
    for(const{aff,banner}of pairs){const folder=zip.folder(aff.id+'_'+aff.promoCode);const blob=await renderPair(aff,banner);if(blob)folder.file(makeFilename(aff.promoCode,banner),blob);done++;progText.textContent=`Processing ${done}/${total}â€¦`;progFill.style.width=Math.round(done/total*100)+'%';await new Promise(r=>setTimeout(r,5));}
    progText.textContent='Compressingâ€¦';
    const zb=await zip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:6}});
    const a=document.createElement('a');a.href=URL.createObjectURL(zb);a.download=`megapari_banners_${new Date().toISOString().slice(0,10)}.zip`;a.click();
  }
  progText.textContent='âœ… Done!';setTimeout(()=>progEl.style.display='none',4000);toast('âœ… ZIP ready!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REGISTRATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateRegBadge(){
  const pending=await cGet(K.regs,[])||[];
  const badge=document.getElementById('reg-badge');
  if(pending.length){badge.style.display='';badge.textContent=pending.length;}else{badge.style.display='none';}
}
async function renderRegs(){
  const pending=await cGet(K.regs,[])||[];
  const approved=await cGet(K.approvedregs,[])||[];
  document.getElementById('pending-cnt').textContent=pending.length;
  document.getElementById('approved-cnt').textContent=approved.length;
  const pl=document.getElementById('pending-list');
  pl.innerHTML=!pending.length?'<div style="color:var(--muted);text-align:center;padding:24px">No pending registrations</div>':pending.map((r,i)=>`<div class="reg-card">
    <div style="font-size:.82rem;line-height:2;margin-bottom:9px">
      <strong style="color:var(--ac)">${eh(r.id)}</strong> Â· ${eh(r.name||'â€”')} Â· <span class="bx bx-r">${eh(r.promoCode)}</span> Â· ${LS_LANGS[r.lang]||r.lang}<br>
      <span style="font-size:.72rem;color:var(--muted)">Submitted: ${new Date(r.submittedAt||Date.now()).toLocaleString()}</span>
    </div>
    <div class="br">
      <button class="btn g sm" onclick="approveReg(${i})">âœ… Approve</button>
      <button class="btn a sm" onclick="editApproveReg(${i})">âœï¸ Edit & Approve</button>
      <button class="btn r sm" onclick="rejectReg(${i})">âœ• Reject</button>
    </div>
  </div>`).join('');
  const al=document.getElementById('approved-list');
  al.innerHTML=!approved.length?'<div style="color:var(--muted);text-align:center;padding:18px">No approved registrations</div>':approved.slice(-20).reverse().map(r=>`<div style="font-size:.8rem;padding:7px 0;border-bottom:1px solid var(--border)">${eh(r.id)} Â· ${eh(r.name||'â€”')} Â· <span class="bx bx-r">${eh(r.promoCode)}</span></div>`).join('');
}
async function approveReg(i){
  let pending=await cGet(K.regs,[])||[];
  const r=pending[i];if(!r)return;
  showSaving('Approvingâ€¦',50);
  let affs=await cGet(K.affs,[])||[];
  const ei=affs.findIndex(a=>a.id.toLowerCase()===r.id.toLowerCase());
  if(ei>=0)affs[ei]=r;else affs.push(r);
  await cSet(K.affs,affs);
  const approved=await cGet(K.approvedregs,[])||[];approved.push(r);await cSet(K.approvedregs,approved);
  pending.splice(i,1);await cSet(K.regs,pending);
  delete _cache[K.regs];delete _cache[K.affs];delete _cache[K.approvedregs];
  hideSaving();renderRegs();renderAffs();toast('âœ… Approved!');updateRegBadge();
}
async function editApproveReg(i){
  const pending=await cGet(K.regs,[])||[];
  const r=pending[i];if(!r)return;
  go('affiliates',document.querySelector('.nav'));
  document.getElementById('a-id').value=r.id||'';document.getElementById('a-name').value=r.name||'';
  document.getElementById('a-promo').value=r.promoCode||'';document.getElementById('a-player').value=r.playerLink||'';
  document.getElementById('a-apk').value=r.apkLink||'';document.getElementById('a-ios').value=r.iosLink||'';
  document.getElementById('a-lang').value=r.lang||'en';
  document.getElementById('aff-form-title').textContent='Approve: '+r.id;
  pending.splice(i,1);await cSet(K.regs,pending);delete _cache[K.regs];
  updateRegBadge();window.scrollTo({top:0,behavior:'smooth'});toast('Edit details then Save Affiliate');
}
async function rejectReg(i){
  if(!confirm('Reject this registration?'))return;
  const pending=await cGet(K.regs,[])||[];pending.splice(i,1);await cSet(K.regs,pending);delete _cache[K.regs];renderRegs();toast('Rejected');updateRegBadge();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function changePw(){
  const cur=document.getElementById('cur-pw').value;const nw=document.getElementById('new-pw').value;const conf=document.getElementById('conf-pw').value;
  const stored=(await CLOUD.get(K.pw))||'admin123';
  if(cur!==stored){toast('Wrong password','err');return;}
  if(!nw||nw.length<4){toast('Min 4 chars','err');return;}
  if(nw!==conf){toast('No match','err');return;}
  await CLOUD.set(K.pw,nw);
  ['cur-pw','new-pw','conf-pw'].forEach(f=>document.getElementById(f).value='');toast('âœ… Password updated!');
}
async function exportData(){
  const d={affiliates:await cGet(K.affs,[]),texts:await cGet(K.texts,[]),banners:(await cGet(K.banners,[])).map(b=>({...b})),exportedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='megapari-backup-'+new Date().toISOString().slice(0,10)+'.json';a.click();toast('âœ… Exported!');
}
async function importData(){
  const file=document.getElementById('imp-in').files[0];if(!file)return;
  const r=new FileReader();
  r.onload=async function(e){
    try{
      const d=JSON.parse(e.target.result);
      showSaving('Importingâ€¦',30);
      if(d.affiliates){await cSet(K.affs,d.affiliates);}
      if(d.texts){await cSet(K.texts,d.texts);}
      if(d.banners){await cSet(K.banners,d.banners);}
      delete _cache[K.affs];delete _cache[K.texts];delete _cache[K.banners];
      await ensureDefTxts();
      hideSaving();renderAffs();renderTxts();renderBanners();toast('âœ… Imported!');
    }catch(err){hideSaving();toast('Invalid file','err');}
  };
  r.readAsText(file);
}
async function clearAll(){
  if(!confirm('Delete ALL cloud data?'))return;if(!confirm('FINAL CONFIRM?'))return;
  showSaving('Clearingâ€¦',50);
  await Promise.all([cSet(K.affs,[]),cSet(K.texts,[]),cSet(K.banners,[]),cSet(K.regs,[]),cSet(K.approvedregs,[])]);
  _cache={};hideSaving();renderAffs();renderBanners();renderTxts();renderRegs();toast('All data cleared');
}
async function renderStats(){
  const a=(await cGet(K.affs,[])||[]).length;
  const b=(await cGet(K.banners,[])||[]);
  const t=(await cGet(K.texts,[])||[]);
  const pr=(await cGet(K.regs,[])||[]).length;
  const byL={en:0,fr:0,ar:0,es:0,pt:0};t.forEach(x=>{if(byL[x.lang]!==undefined)byL[x.lang]++;});
  const sc=(v,l,c)=>`<div style="background:var(--card2);border:1px solid var(--border);border-radius:9px;padding:13px;text-align:center"><div style="font-size:1.5rem;font-weight:700;color:${c};font-family:'Bebas Neue',sans-serif">${v}</div><div style="font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px">${l}</div></div>`;
  document.getElementById('stats-area').innerHTML=sc(a,'Affiliates','var(--ac)')+sc(b.length,'Banners','var(--amber)')+sc(t.length,'Captions','var(--blue2)')+sc(pr,'Pending','var(--amber)')+Object.entries(byL).map(([l,n])=>sc(n,LS_LANGS[l],'var(--muted)')).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.style.background=type==='err'?'var(--red)':'var(--ac)';t.style.color='#fff';t.classList.add('on');setTimeout(()=>t.classList.remove('on'),2800);}
function eh(s){const d=document.createElement('div');d.textContent=String(s||'');return d.innerHTML;}
function ea(s){return String(s||'').replace(/'/g,"\\'");}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEFAULT TEXTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function ensureDefTxts(){
  const t=await cGet(K.texts,[]);
  if(!t||t.length===0){
    const defs=[
      {id:'e1',lang:'en',content:"âš½ğŸ”¥ BIG MATCH ENERGY STARTS HERE!\nğŸ¯ Register: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code: {{Promo code}}"},
      {id:'e2',lang:'en',content:"Smart bettors use the right platform.\nğŸ‘‰ Join: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° Code: {{Promo code}}"},
      {id:'f1',lang:'fr',content:"âš½ğŸ”¥ MATCHS DE RÃŠVE = PROFITS RÃ‰ELS!\nğŸ¯ Inscription: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ Code: {{Promo code}}"},
      {id:'f2',lang:'fr',content:"Les parieurs intelligents choisissent Megapari.\nğŸ‘‰ Rejoignez: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° Code: {{Promo code}}"},
      {id:'a1',lang:'ar',content:"âš½ğŸ”¥ Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©!\nğŸ¯ Ø³Ø¬Ù‘Ù„: {{Player link}}\nğŸ“² Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ ÙƒÙˆØ¯: {{Promo code}}"},
      {id:'a2',lang:'ar',content:"Ø§Ù„Ù…Ø±Ø§Ù‡Ù†ÙˆÙ† Ø§Ù„Ø£Ø°ÙƒÙŠØ§Ø¡ ÙŠØ®ØªØ§Ø±ÙˆÙ† Megapari.\nğŸ‘‰ Ø§Ù†Ø¶Ù…: {{Player link}}\nğŸ“¥ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° ÙƒÙˆØ¯: {{Promo code}}"},
      {id:'s1',lang:'es',content:"âš½ğŸ”¥ Â¡GRANDES PARTIDOS = GRANDES GANANCIAS!\nğŸ¯ RegÃ­strate: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}"},
      {id:'s2',lang:'es',content:"Los apostadores inteligentes eligen Megapari.\nğŸ‘‰ Ãšnete: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° CÃ³digo: {{Promo code}}"},
      {id:'p1',lang:'pt',content:"âš½ğŸ”¥ GRANDES JOGOS = GRANDES LUCROS!\nğŸ¯ Registre-se: {{Player link}}\nğŸ“² APK: {{apk link}}\nğŸ iOS: {{iOS link}}\nğŸ CÃ³digo: {{Promo code}}"},
      {id:'p2',lang:'pt',content:"Apostadores inteligentes escolhem Megapari.\nğŸ‘‰ Junte-se: {{Player link}}\nğŸ“¥ Android: {{apk link}}\nğŸ“± iOS: {{iOS link}}\nğŸ’° CÃ³digo: {{Promo code}}"},
    ];
    await cSet(K.texts,defs);
  }
}
</script>
</body>
</html>
